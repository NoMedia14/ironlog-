<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0a0a0f">
  <title>IRONLOG</title>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --bg:#0a0a0f; --surface:#111118; --card:#18181f; --border:#2a2a38;
      --accent:#e8ff47; --accent2:#ff4757; --accent3:#47c8ff; --accent4:#47ffb8;
      --text:#f0f0f8; --muted:#6b6b80; --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0;}
    body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;overflow-x:hidden;}

    /* AUTH */
    #auth-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;padding:24px;}
    .auth-logo{font-family:'Bebas Neue',sans-serif;font-size:52px;letter-spacing:8px;color:var(--accent);margin-bottom:4px;}
    .auth-logo span{color:var(--text);}
    .auth-sub{font-size:13px;color:var(--muted);letter-spacing:2px;text-transform:uppercase;margin-bottom:40px;}
    .auth-box{background:var(--card);border:1px solid var(--border);border-radius:20px;padding:28px;width:100%;max-width:380px;}
    .auth-tabs{display:flex;gap:4px;background:var(--surface);border-radius:10px;padding:4px;margin-bottom:24px;}
    .auth-tab{flex:1;padding:8px;border-radius:7px;border:none;background:transparent;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;}
    .auth-tab.active{background:var(--card);color:var(--accent);}
    .auth-form{display:none;} .auth-form.active{display:block;}
    .auth-err{font-size:12px;margin-top:8px;display:none;}

    /* LOADING */
    #loading-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px;}
    .spinner{width:40px;height:40px;border:3px solid var(--border);border-top:3px solid var(--accent);border-radius:50%;animation:spin .8s linear infinite;}
    @keyframes spin{to{transform:rotate(360deg);}}

    #app-screen{display:none;}

    /* HEADER */
    header{position:sticky;top:0;z-index:100;background:rgba(10,10,15,.92);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);padding:0 16px;height:60px;display:flex;align-items:center;justify-content:space-between;}
    .logo{font-family:'Bebas Neue',sans-serif;font-size:26px;letter-spacing:4px;color:var(--accent);}
    .logo span{color:var(--text);}
    .header-right{display:flex;align-items:center;gap:10px;}
    .user-badge{display:flex;align-items:center;gap:8px;cursor:pointer;padding:6px 10px;border-radius:8px;border:1px solid var(--border);transition:all .2s;}
    .user-badge:hover{border-color:var(--accent);}
    .user-avatar{width:28px;height:28px;border-radius:50%;background:var(--accent);color:#0a0a0f;font-family:'Bebas Neue',sans-serif;font-size:14px;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
    .user-name{font-size:12px;font-weight:600;max-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* NAV - FIX: profile+shared rechts */
    nav{display:flex;gap:2px;background:var(--surface);border-bottom:1px solid var(--border);padding:8px 12px 0;overflow-x:auto;scrollbar-width:none;align-items:flex-end;}
    nav::-webkit-scrollbar{display:none;}
    .nav-spacer{flex:1;}
    .tab{padding:9px 12px;border-radius:10px 10px 0 0;font-size:11px;font-weight:600;letter-spacing:.5px;cursor:pointer;border:none;background:transparent;color:var(--muted);transition:all .2s;white-space:nowrap;}
    .tab.active{background:var(--card);color:var(--accent);border:1px solid var(--border);border-bottom:1px solid var(--card);}
    .tab-right{color:var(--muted);}

    main{padding:16px 16px 100px;max-width:680px;margin:0 auto;}
    .view{display:none;} .view.active{display:block;}

    /* BUTTONS */
    .btn{padding:10px 18px;border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:600;cursor:pointer;border:none;transition:all .15s;}
    .btn-accent{background:var(--accent);color:#0a0a0f;}
    .btn-accent:hover{background:#d4eb30;transform:translateY(-1px);}
    .btn-ghost{background:transparent;border:1px solid var(--border);color:var(--muted);}
    .btn-ghost:hover{border-color:var(--accent);color:var(--accent);}
    .btn-danger{background:transparent;border:1px solid rgba(255,71,87,.4);color:var(--accent2);}
    .btn-danger:hover{background:rgba(255,71,87,.1);}
    .btn-blue{background:rgba(71,200,255,.15);border:1px solid rgba(71,200,255,.3);color:var(--accent3);}
    .btn-teal{background:rgba(71,255,184,.15);border:1px solid rgba(71,255,184,.3);color:var(--accent4);}
    .btn-sm{padding:6px 12px;font-size:12px;}
    .btn-xs{padding:4px 9px;font-size:11px;border-radius:6px;}
    .btn:disabled{opacity:.5;cursor:not-allowed;transform:none!important;}

    /* INPUTS */
    input,textarea,select{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'DM Sans',sans-serif;font-size:14px;padding:10px 12px;width:100%;transition:border-color .2s;outline:none;}
    input:focus,textarea:focus,select:focus{border-color:var(--accent);}
    select option{background:var(--card);}
    label{font-size:11px;font-weight:600;letter-spacing:1px;color:var(--muted);text-transform:uppercase;display:block;margin-bottom:6px;}
    .field{margin-bottom:14px;}

    /* TIMER */
    .timer-section{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;}
    .timer-section.minimized .timer-body{display:none;}
    .timer-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;}
    .timer-section.minimized .timer-header{margin-bottom:0;}
    .timer-lbl{font-size:10px;font-weight:600;letter-spacing:2px;color:var(--muted);text-transform:uppercase;}
    .timer-mini-row{display:flex;align-items:center;gap:10px;}
    .timer-mini-display{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;color:var(--accent);}
    .timer-mini-display.running{color:#47ff8a;} .timer-mini-display.countdown{color:var(--accent2);}
    .timer-display{font-family:'Bebas Neue',sans-serif;font-size:58px;letter-spacing:8px;color:var(--accent);line-height:1;margin:12px 0;text-align:center;transition:color .3s;}
    .timer-display.running{color:#47ff8a;} .timer-display.countdown{color:var(--accent2);}
    .timer-btns{display:flex;gap:10px;justify-content:center;margin-bottom:14px;}
    .timer-main{width:60px;height:60px;border-radius:50%;font-size:20px;display:flex;align-items:center;justify-content:center;cursor:pointer;border:none;transition:all .2s;}
    .t-play{background:var(--accent);color:#0a0a0f;box-shadow:0 0 20px rgba(232,255,71,.3);}
    .t-play:hover{transform:scale(1.08);}
    .t-reset{background:var(--card);border:1px solid var(--border);color:var(--muted);}
    .quick-btns{display:flex;gap:7px;justify-content:center;flex-wrap:wrap;}
    .qbtn{padding:7px 13px;border-radius:20px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--card);color:var(--muted);transition:all .2s;}
    .qbtn.qactive{border-color:var(--accent2);color:var(--accent2);background:rgba(255,71,87,.08);}

    /* SETS - FIX: removed Notiz column, only KG/REPS/PAUSE/BEM */
    .sets-header{display:grid;grid-template-columns:28px 1fr 1fr 1fr 1fr auto;gap:4px;font-size:10px;font-weight:600;letter-spacing:1px;color:var(--muted);text-transform:uppercase;padding:0 2px 8px;}
    .set-row{display:grid;grid-template-columns:28px 1fr 1fr 1fr 1fr auto;gap:5px;align-items:center;margin-bottom:7px;}
    .set-num{width:28px;height:28px;background:var(--surface);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--muted);flex-shrink:0;}
    .set-row input{padding:7px 4px;font-size:12px;text-align:center;}
    .del-set{width:28px;height:28px;background:transparent;border:1px solid var(--border);border-radius:6px;cursor:pointer;color:var(--muted);font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;flex-shrink:0;}
    .del-set:hover{border-color:var(--accent2);color:var(--accent2);}
    .exercise-block{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:12px;}
    .exercise-name-row{display:flex;gap:8px;align-items:center;margin-bottom:12px;}
    .exercise-name-row input{flex:1;font-weight:600;}

    /* SESSION CARDS */
    .session-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:10px;cursor:pointer;transition:border-color .2s,transform .15s;}
    .session-card:hover{border-color:var(--accent);transform:translateX(4px);}
    .session-date{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent);}
    .session-name{font-size:15px;font-weight:600;margin:2px 0 6px;}
    .session-meta{display:flex;gap:12px;font-size:12px;color:var(--muted);}

    /* PLAN CARDS */
    .rating-btn{padding:6px 12px;border-radius:20px;font-size:12px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;}
    .habit-color-btn{cursor:pointer;transition:transform .15s;border:3px solid transparent;}
    .habit-color-btn.active{transform:scale(1.25);border-color:#fff !important;}
    .habit-day-btn{display:flex;flex-direction:column;align-items:center;gap:3px;padding:6px 4px;border-radius:10px;cursor:pointer;border:none;background:transparent;color:var(--text);transition:background .15s;min-width:38px;}
    .habit-day-btn:hover{background:var(--surface);}
    .habit-day-dot{width:30px;height:30px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;border:2px solid var(--border);transition:all .2s;}
    .habit-day-dot.done{color:#0a0a0f;border-color:transparent;}
    .habit-day-dot.partial{border-color:currentColor;opacity:.7;}
    .habit-row{padding:10px 0;border-bottom:1px solid var(--border);}
    .habit-row:last-child{border-bottom:none;}
    .rating-btn.active{border-color:var(--accent3);color:var(--accent3);background:rgba(71,200,255,.12);}
    .plan-archived{opacity:.55;}
    .plan-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:10px;}
    .plan-name{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent3);margin-bottom:6px;}
    .plan-ex-list{font-size:12px;color:var(--muted);margin-bottom:10px;line-height:1.9;}
    .plan-actions{display:flex;gap:8px;flex-wrap:wrap;}
    .plan-ex-item.drag-over{border-top:2px solid var(--accent3);opacity:.7;}
    .plan-ex-item{display:flex;align-items:flex-start;gap:8px;padding:10px 0;border-bottom:1px solid var(--border);}
    .plan-ex-item:last-child{border-bottom:none;}

    /* ACTIVE WORKOUT */
    .active-workout{background:var(--card);border:2px solid var(--accent3);border-radius:var(--radius);margin-bottom:16px;overflow:hidden;}
    .aw-header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;cursor:pointer;background:rgba(71,200,255,.05);}
    .aw-title{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent3);}
    .aw-body{padding:0 16px 16px;display:none;}
    .aw-body.open{display:block;}
    .aw-actions{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border);}

    /* DETAIL */
    .detail-exercise{margin-bottom:16px;}
    .detail-exercise-name{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--accent);margin-bottom:8px;}
    .detail-sets{display:grid;grid-template-columns:repeat(auto-fill,minmax(80px,1fr));gap:8px;}
    .detail-set{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:10px;text-align:center;}

    /* STATS */
    .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;}
    .stat-box{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;text-align:center;}
    .stat-val{font-family:'Bebas Neue',sans-serif;font-size:36px;letter-spacing:2px;color:var(--accent);}
    .stat-label{font-size:11px;color:var(--muted);letter-spacing:1px;text-transform:uppercase;}
    .chart-wrap{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;}
    .chart-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--text);margin-bottom:12px;}

    /* DATA GROUPS */
    .year-group{margin-bottom:8px;}
    .year-header{display:flex;align-items:center;justify-content:space-between;padding:10px 4px;border-bottom:2px solid var(--border);margin-bottom:6px;cursor:pointer;user-select:none;}
    .year-header:hover{opacity:.8;}
    .year-body{display:none;}
    .year-body.open{display:block;}
    .data-group{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:8px;overflow:hidden;}
    .data-group-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;cursor:pointer;}
    .data-group-header:hover{background:rgba(255,255,255,.02);}
    .data-group-title{font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;}
    .data-group-meta{font-size:11px;color:var(--muted);}
    .data-group-body{display:none;border-top:1px solid var(--border);}
    .data-group-body.open{display:block;}
    .data-entry-row{display:flex;align-items:center;justify-content:space-between;padding:10px 16px;border-bottom:1px solid rgba(42,42,56,.5);cursor:pointer;}
    .data-entry-row:last-child{border-bottom:none;}
    .data-entry-row:hover{background:rgba(255,255,255,.02);}
    .data-entry-date{font-size:13px;font-weight:600;}
    .data-entry-vals{display:flex;gap:10px;font-size:11px;color:var(--muted);flex-wrap:wrap;margin-top:3px;}
    .data-entry-vals b{color:var(--text);font-size:13px;}

    /* WEEK COMPARE */
    .week-compare{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px;}
    .week-row{display:grid;grid-template-columns:78px 1fr 1fr 1fr 1fr;gap:6px;align-items:center;padding:8px 0;border-bottom:1px solid var(--border);font-size:12px;}
    .week-row:last-child{border-bottom:none;}
    .week-row.wh{font-size:10px;letter-spacing:1px;color:var(--muted);text-transform:uppercase;font-weight:600;padding-bottom:10px;}
    .week-lbl{font-family:'Bebas Neue',sans-serif;font-size:14px;letter-spacing:1px;color:var(--accent3);}
    .d-pos{color:#47ff8a;font-size:10px;} .d-neg{color:var(--accent2);font-size:10px;} .d-neu{color:var(--muted);font-size:10px;}

    /* FILTER */
    .filter-row{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap;}
    .fbtn{padding:5px 12px;border-radius:20px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;}
    .fbtn.active{border-color:var(--accent3);color:var(--accent3);background:rgba(71,200,255,.1);}

    /* BP */
    .bp-table{width:100%;border-collapse:collapse;font-size:12px;}
    .bp-table th{font-size:10px;letter-spacing:1px;color:var(--muted);text-transform:uppercase;font-weight:600;padding:6px 8px;text-align:left;border-bottom:1px solid var(--border);}
    .bp-table td{padding:8px;border-bottom:1px solid rgba(42,42,56,.5);vertical-align:middle;}
    .bp-table tr:last-child td{border-bottom:none;}
    .bp-table tr:hover td{background:rgba(255,255,255,.02);cursor:pointer;}
    .bp-tag{display:inline-block;padding:2px 8px;border-radius:10px;font-size:10px;font-weight:700;}
    .bp-normal{background:rgba(71,255,184,.15);color:var(--accent4);}
    .bp-elevated{background:rgba(232,255,71,.15);color:var(--accent);}
    .bp-high{background:rgba(255,71,87,.15);color:var(--accent2);}
    .bp-sys{color:var(--accent2);font-weight:700;} .bp-dia{color:var(--accent3);font-weight:700;}

    /* PROFILE */
    .profile-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:24px;margin-bottom:16px;text-align:center;}
    .profile-avatar-big{width:72px;height:72px;border-radius:50%;background:var(--accent);color:#0a0a0f;font-family:'Bebas Neue',sans-serif;font-size:32px;display:flex;align-items:center;justify-content:center;margin:0 auto 12px;}
    .profile-name{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:3px;}
    .profile-email{font-size:13px;color:var(--muted);margin-top:4px;}

    /* SHARING */
    .share-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:10px;}
    .share-email{font-size:14px;font-weight:600;}
    .share-cats{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;}
    .share-cat{padding:3px 10px;border-radius:20px;font-size:11px;font-weight:700;background:rgba(232,255,71,.1);color:var(--accent);border:1px solid rgba(232,255,71,.2);}
    .shared-person-card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;margin-bottom:10px;cursor:pointer;transition:border-color .2s;}
    .shared-person-card:hover{border-color:var(--accent3);}
    .shared-person-name{font-family:'Bebas Neue',sans-serif;font-size:18px;letter-spacing:2px;color:var(--accent3);}

    /* MODAL */
    .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);z-index:200;overflow-y:auto;padding:20px 16px;}
    .modal-bg.open{display:flex;align-items:flex-start;justify-content:center;}
    .modal{background:var(--card);border:1px solid var(--border);border-radius:20px;width:100%;max-width:600px;padding:24px;animation:slideUp .3s ease;}
    @keyframes slideUp{from{transform:translateY(30px);opacity:0;}to{transform:translateY(0);opacity:1;}}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;}
    .modal-title{font-family:'Bebas Neue',sans-serif;font-size:22px;letter-spacing:3px;}
    .close-btn{width:32px;height:32px;background:var(--surface);border:1px solid var(--border);border-radius:8px;cursor:pointer;color:var(--muted);font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
    .close-btn:hover{color:var(--text);border-color:var(--text);}
    .divider{height:1px;background:var(--border);margin:16px 0;}
    .check-group{display:flex;flex-direction:column;gap:10px;}
    .check-item{display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--surface);border-radius:8px;border:1px solid var(--border);cursor:pointer;}
    .check-item input[type=checkbox]{width:18px;height:18px;accent-color:var(--accent);cursor:pointer;}

    /* SYNC */
    .sync-dot{width:8px;height:8px;border-radius:50%;background:var(--accent4);display:inline-block;margin-right:6px;}
    .sync-dot.syncing{background:var(--accent);animation:pulse 1s infinite;}
    .sync-dot.error{background:var(--accent2);}
    @keyframes pulse{0%,100%{opacity:1;}50%{opacity:.3;}}

    /* TOAST */
    #toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--accent);color:#0a0a0f;padding:10px 20px;border-radius:20px;font-weight:600;font-size:13px;opacity:0;transition:all .3s;pointer-events:none;z-index:999;}
    #toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
    #toast.err{background:var(--accent2);color:#fff;}

    /* FAB */
    .fab{position:fixed;bottom:24px;right:20px;width:56px;height:56px;border-radius:50%;border:none;font-size:26px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;z-index:50;}
    .fab:hover{transform:scale(1.1);}
    .fab-yellow{background:var(--accent);color:#0a0a0f;box-shadow:0 4px 20px rgba(232,255,71,.4);}
    .fab-purple{background:#c847ff;color:#fff;box-shadow:0 4px 20px rgba(200,71,255,.4);}
    .fab-orange{background:#ff9f47;color:#fff;box-shadow:0 4px 20px rgba(255,159,71,.4);}
    .fab-green{background:#47ffb8;color:#0a0a0f;box-shadow:0 4px 20px rgba(71,255,184,.4);}
    .macro-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
    .macro-row:last-child{border-bottom:none;}
    .macro-label{font-size:13px;font-weight:600;color:var(--text);min-width:110px;flex-shrink:0;}
    .macro-input-wrap{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:0 10px;}
    .macro-input{background:transparent;border:none;color:var(--text);font-size:14px;font-weight:700;width:80px;text-align:right;padding:10px 0;outline:none;font-family:'DM Sans',sans-serif;}
    .macro-unit{font-size:11px;color:var(--muted);font-weight:600;white-space:nowrap;}
    .macro-select{background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:12px;font-weight:600;padding:10px 12px;outline:none;font-family:'DM Sans',sans-serif;width:100%;max-width:220px;}
    .macro-toggle{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;font-family:'DM Sans',sans-serif;}
    .macro-toggle.active{background:var(--accent3);color:#0a0a0f;border-color:var(--accent3);}
    .macro-toggle3{padding:7px 10px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;font-family:'DM Sans',sans-serif;}
    .macro-toggle3.active{background:var(--accent);color:#0a0a0f;border-color:var(--accent);}
    .macro-result-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
    .macro-result-row:last-child{border-bottom:none;}
    .macro-result-label{font-size:13px;color:var(--muted);font-weight:500;}
    .macro-result-val{font-size:15px;font-weight:800;color:var(--text);}
    .macro-result-val.accent{color:var(--accent);}
    .macro-result-val.accent2{color:var(--accent2);}
    .macro-result-val.accent3{color:var(--accent3);}
    .macro-result-val.accent4{color:var(--accent4);}
    .macro-highlight-deficit{background:rgba(71,200,255,.05);border-radius:8px;padding:10px 8px;margin:2px -8px;}
    .macro-highlight-maint{background:rgba(71,255,184,.05);border-radius:8px;padding:10px 8px;margin:2px -8px;}
    .fab-purple{background:#c847ff;color:#fff;box-shadow:0 4px 20px rgba(200,71,255,.4);}
    .fab-orange{background:#ff9f47;color:#fff;box-shadow:0 4px 20px rgba(255,159,71,.4);}
    .fab-green{background:#47ffb8;color:#0a0a0f;box-shadow:0 4px 20px rgba(71,255,184,.4);}
    .macro-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
    .macro-row:last-child{border-bottom:none;}
    .macro-label{font-size:13px;font-weight:600;color:var(--text);min-width:110px;flex-shrink:0;}
    .macro-input-wrap{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:0 10px;}
    .macro-input{background:transparent;border:none;color:var(--text);font-size:14px;font-weight:700;width:80px;text-align:right;padding:10px 0;outline:none;font-family:'DM Sans',sans-serif;}
    .macro-unit{font-size:11px;color:var(--muted);font-weight:600;white-space:nowrap;}
    .macro-select{background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:12px;font-weight:600;padding:10px 12px;outline:none;font-family:'DM Sans',sans-serif;width:100%;max-width:220px;}
    .macro-toggle{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;font-family:'DM Sans',sans-serif;}
    .macro-toggle.active{background:var(--accent3);color:#0a0a0f;border-color:var(--accent3);}
    .macro-toggle3{padding:7px 10px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;font-family:'DM Sans',sans-serif;}
    .macro-toggle3.active{background:var(--accent);color:#0a0a0f;border-color:var(--accent);}
    .macro-result-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
    .macro-result-row:last-child{border-bottom:none;}
    .macro-result-label{font-size:13px;color:var(--muted);font-weight:500;}
    .macro-result-val{font-size:15px;font-weight:800;color:var(--text);}
    .macro-result-val.accent{color:var(--accent);}
    .macro-result-val.accent2{color:var(--accent2);}
    .macro-result-val.accent3{color:var(--accent3);}
    .macro-result-val.accent4{color:var(--accent4);}
    .macro-highlight-deficit{background:rgba(71,200,255,.05);border-radius:8px;padding:10px 8px;margin:2px -8px;}
    .macro-highlight-maint{background:rgba(71,255,184,.05);border-radius:8px;padding:10px 8px;margin:2px -8px;}
    .fab-blue{background:var(--accent3);color:#0a0a0f;box-shadow:0 4px 20px rgba(71,200,255,.4);}
    .fab-teal{background:var(--accent4);color:#0a0a0f;box-shadow:0 4px 20px rgba(71,255,184,.4);}
    .fab-red{background:var(--accent2);color:#fff;box-shadow:0 4px 20px rgba(255,71,87,.4);}

    .empty{text-align:center;padding:60px 20px;color:var(--muted);}
    .empty-icon{font-size:48px;margin-bottom:12px;}
    .empty-text{font-size:15px;}
    .coming-soon{text-align:center;padding:80px 20px;}
    .coming-soon-icon{font-size:56px;margin-bottom:16px;}
    .coming-soon-title{font-family:'Bebas Neue',sans-serif;font-size:28px;letter-spacing:4px;color:var(--accent);margin-bottom:8px;}
    .coming-soon-sub{font-size:14px;color:var(--muted);}

    @media(max-width:380px){
      .sets-header,.set-row{grid-template-columns:24px 1fr 1fr 1fr 1fr 24px;gap:3px;}
    .sets-4,.set-row-4{grid-template-columns:24px 1fr 1fr 1fr 24px;gap:3px;}
    }

    .macro-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:10px 0;border-bottom:1px solid var(--border);}
    .macro-row:last-child{border-bottom:none;}
    .macro-label{font-size:13px;font-weight:600;color:var(--text);min-width:110px;flex-shrink:0;}
    .macro-input-wrap{display:flex;align-items:center;gap:6px;background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:0 10px;}
    .macro-input{background:transparent;border:none;color:var(--text);font-size:14px;font-weight:700;width:80px;text-align:right;padding:10px 0;outline:none;font-family:'DM Sans',sans-serif;}
    .macro-unit{font-size:11px;color:var(--muted);font-weight:600;white-space:nowrap;}
    .macro-select{background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:12px;font-weight:600;padding:10px 12px;outline:none;font-family:'DM Sans',sans-serif;width:100%;max-width:220px;}
    .macro-toggle{padding:8px 14px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;font-family:'DM Sans',sans-serif;}
    .macro-toggle.active{background:var(--accent3);color:#0a0a0f;border-color:var(--accent3);}
    .macro-toggle3{padding:7px 10px;border-radius:8px;font-size:11px;font-weight:700;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--muted);transition:all .2s;font-family:'DM Sans',sans-serif;}
    .macro-toggle3.active{background:var(--accent);color:#0a0a0f;border-color:var(--accent);}
    .macro-result-row{display:flex;align-items:center;justify-content:space-between;padding:10px 0;border-bottom:1px solid var(--border);}
    .macro-result-row:last-child{border-bottom:none;}
    .macro-result-label{font-size:13px;color:var(--muted);font-weight:500;}
    .macro-result-val{font-size:15px;font-weight:800;color:var(--text);}
    .macro-result-val.accent{color:var(--accent);}
    .macro-result-val.accent2{color:var(--accent2);}
    .macro-result-val.accent3{color:var(--accent3);}
    .macro-result-val.accent4{color:var(--accent4);}
    .macro-highlight-deficit{background:rgba(71,200,255,.06);border-radius:8px;padding:10px 8px !important;margin:2px -8px;}
    .macro-highlight-maint{background:rgba(71,255,184,.06);border-radius:8px;padding:10px 8px !important;margin:2px -8px;}
  </style>
</head>
<body>

<div id="loading-screen">
  <div class="spinner"></div>
  <div style="font-size:12px;color:var(--muted);letter-spacing:2px;">LADEN‚Ä¶</div>
  <button class="btn btn-ghost btn-sm" onclick="forceShowAuth()" style="margin-top:20px;font-size:11px;">Zur Anmeldung</button>
</div>

<div id="auth-screen" style="display:none;">
  <div class="auth-logo">IRON<span>LOG</span></div>
  <div class="auth-sub">Training Tracker</div>
  <div id="session-clear-hint" style="display:none;margin-bottom:16px;text-align:center;">
    <div style="font-size:12px;color:var(--muted);margin-bottom:8px;">Probleme beim Laden?</div>
    <button class="btn btn-ghost btn-xs" onclick="clearAndReload()">üîÑ Session zur√ºcksetzen</button>
  </div>
  <div class="auth-box">
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login',this)">Anmelden</button>
      <button class="auth-tab" onclick="switchAuthTab('register',this)">Registrieren</button>
    </div>
    <div class="auth-form active" id="af-login">
      <div class="field"><label>E-Mail</label><input type="email" id="login-email" placeholder="deine@email.de"></div>
      <div class="field"><label>Passwort</label><input type="password" id="login-pw" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
        onkeydown="if(event.key==='Enter')doLogin()"></div>
      <div class="auth-err" id="login-err"></div>
      <button class="btn btn-accent" style="width:100%;margin-top:8px;" onclick="doLogin()" id="login-btn">Anmelden</button>
      <div style="text-align:center;margin-top:12px;">
        <button onclick="showForgotPw()" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;text-decoration:underline;">Passwort vergessen?</button>
      </div>
    </div>
    <div class="auth-form" id="af-register">
      <div class="field"><label>Name</label><input type="text" id="reg-name" placeholder="Dein Name"></div>
      <div class="field"><label>E-Mail</label><input type="email" id="reg-email" placeholder="deine@email.de"></div>
      <div class="field"><label>Passwort</label><input type="password" id="reg-pw" placeholder="Mind. 6 Zeichen"></div>
      <div class="auth-err" id="reg-err"></div>
      <button class="btn btn-accent" style="width:100%;margin-top:8px;" onclick="doRegister()" id="reg-btn">Registrieren</button>
    </div>
    <!-- FORGOT PW (hidden, shown via link) -->
    <div class="auth-form" id="af-forgot">
      <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Gib deine E-Mail ein. Du bekommst einen Link zum Zur√ºcksetzen.</p>
      <div class="field"><label>E-Mail</label><input type="email" id="forgot-email" placeholder="deine@email.de"></div>
      <div class="auth-err" id="forgot-err"></div>
      <button class="btn btn-accent" style="width:100%;margin-top:8px;" onclick="doForgotPw()" id="forgot-btn">Link senden</button>
      <div style="text-align:center;margin-top:12px;">
        <button onclick="showLogin()" style="background:none;border:none;color:var(--muted);font-size:12px;cursor:pointer;text-decoration:underline;">‚Üê Zur√ºck zum Login</button>
      </div>
    </div>
  </div>
</div>

<div id="app-screen">
  <header>
    <div class="logo">IRON<span>LOG</span></div>
    <div class="header-right">
      <span class="sync-dot" id="sync-dot"></span>
      <div class="user-badge" onclick="showTab('profile',null)">
        <div class="user-avatar" id="header-avatar">?</div>
        <div class="user-name" id="header-name">‚Ä¶</div>
      </div>
    </div>
  </header>

  <!-- NAV: profile+shared rechtsb√ºndig -->
  <nav>
    <button class="tab active" data-tab="log" onclick="showTab('log',this)">üìã LOG</button>
    <button class="tab" data-tab="plans" onclick="showTab('plans',this)">üìå PL√ÑNE</button>
    <button class="tab" data-tab="stats" onclick="showTab('stats',this)">üìä STATS</button>
    <button class="tab" data-tab="weight" onclick="showTab('weight',this)">‚öñÔ∏è GEWICHT</button>
    <button class="tab" data-tab="macros" onclick="showTab('macros',this)">ü•ó MAKROS</button>
    <button class="tab" id="bp-tab" data-tab="bp" onclick="showTab('bp',this)">‚ù§Ô∏è BLUTDRUCK</button>
    <button class="tab" id="sleep-tab" data-tab="sleep" onclick="showTab('sleep',this)">üò¥ SCHLAF</button>
    <button class="tab" id="habits-tab" data-tab="habits" onclick="showTab('habits',this)">‚úÖ HABITS</button>
    <button class="tab" id="mood-tab" data-tab="mood" onclick="showTab('mood',this)">üòä STIMMUNG</button>
    <div class="nav-spacer"></div>
    <button class="tab tab-right" data-tab="shared" onclick="showTab('shared',this)">üë• Geteilt</button>
    <button class="tab tab-right" data-tab="profile" onclick="showTab('profile',this)">üë§ Profil</button>
  </nav>

  <main>
    <!-- LOG -->
    <div id="view-log" class="view active">
      <div class="timer-section" id="timer-section">
        <div class="timer-header">
          <div>
            <div class="timer-lbl">Pausentimer</div>
            <div class="timer-mini-row" id="timer-mini-row" style="display:none;">
              <div class="timer-mini-display" id="timer-mini">00:00</div>
              <button onclick="timerToggle()" id="timer-mini-btn" style="padding:3px 8px;border:1px solid var(--border);background:transparent;color:var(--muted);border-radius:6px;cursor:pointer;font-size:12px;">‚ñ∂</button>
            </div>
          </div>
          <button class="btn btn-ghost btn-xs" onclick="toggleTimerMin()">‚ñ≤ Min</button>
        </div>
        <div class="timer-body" id="timer-body">
          <div class="timer-display" id="timer-display">00:00</div>
          <div class="timer-btns">
            <button class="timer-main t-reset" onclick="timerReset()">‚Ü∫</button>
            <button class="timer-main t-play" id="timer-btn" onclick="timerToggle()">‚ñ∂</button>
          </div>
          <div class="quick-btns">
            <button class="qbtn" onclick="timerCountdown(60,this)">1 Min</button>
            <button class="qbtn" onclick="timerCountdown(120,this)">2 Min</button>
            <button class="qbtn" onclick="timerCountdown(180,this)">3 Min</button>
            <button class="qbtn" onclick="timerCountdown(240,this)">4 Min</button>
            <button class="qbtn" onclick="timerCountdown(300,this)">5 Min</button>
          </div>
        </div>
      </div>
      <div class="chart-wrap" style="margin-bottom:16px;">
        <div class="chart-title" style="margin-bottom:10px;">TRAINING STARTEN</div>
        <div style="display:flex;gap:8px;align-items:flex-end;margin-bottom:10px;">
          <div class="field" style="flex:1;margin-bottom:0;"><label>Trainingsplan</label>
            <select id="log-plan-sel"><option value="">‚Äî Plan w√§hlen ‚Äî</option></select></div>
          <button class="btn btn-blue" style="height:42px;padding:0 18px;font-size:13px;white-space:nowrap;" onclick="startSelectedPlan()">‚ñ∂ Starten</button>
        </div>
        <button class="btn btn-ghost btn-sm" style="width:100%;" onclick="openBlankSession()">+ Leere Einheit</button>
      </div>
      <div id="active-workout-wrap" style="display:none;"></div>
      <div id="log-list"></div>
    </div>

    <!-- PLANS -->
    <div id="view-plans" class="view"><div id="plans-list"></div></div>

    <!-- STATS -->
    <div id="view-stats" class="view">
      <div class="stats-grid" id="stats-grid"></div>
      <div class="chart-wrap">
        <div class="chart-title">FORTSCHRITT ‚Äî MAX. GEWICHT</div>
        <div class="field" style="margin-bottom:12px;"><label>√úbung</label>
          <select id="chart-ex-sel" onchange="updateProgressChart()"></select></div>
        <canvas id="progressChart" height="200"></canvas>
      </div>
      <div class="chart-wrap"><div class="chart-title">TRAININGS PRO WOCHE</div>
        <canvas id="weekChart" height="160"></canvas></div>
    </div>

    <!-- WEIGHT -->
    <div id="view-weight" class="view">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" onclick="exportWeightPDF()">&#x1F4C4; PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="exportWeightCSV()">&#x1F4CA; CSV</button>
        <button class="btn btn-ghost btn-sm" onclick="g('modal-weight-import').classList.add('open')">&#x1F4C2; Import</button>
      </div>
      <div class="chart-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
          <div class="chart-title" style="margin-bottom:0;">VERLAUF</div>
          <div style="display:flex;gap:4px;">
            <button class="fbtn wtf" onclick="setWTimeFilter('1m',this)">1M</button>
            <button class="fbtn wtf" onclick="setWTimeFilter('3m',this)">3M</button>
            <button class="fbtn wtf" onclick="setWTimeFilter('6m',this)">6M</button>
            <button class="fbtn wtf" onclick="setWTimeFilter('1y',this)">1J</button>
            <button class="fbtn wtf active" onclick="setWTimeFilter('all',this)">Alle</button>
          </div>
        </div>
        <div class="filter-row">
          <button class="fbtn wmet active" onclick="switchWMetric('weight',this)">&#x2696;&#xFE0F; Gewicht</button>
          <button class="fbtn wmet" onclick="switchWMetric('bauch',this)">&#x1F4CF; Bauch</button>
          <button class="fbtn wmet" onclick="switchWMetric('hueft',this)">&#x1F4D0; H&#xFC;fte</button>
          <button class="fbtn wmet" onclick="switchWMetric('kcal',this)">&#x1F525; Kalorien</button>
        </div>
        <canvas id="weightChart" height="200"></canvas>
      </div>
      <div class="week-compare"><div class="chart-title" style="margin-bottom:14px;">7-TAGE WOCHENVERGLEICH</div>
        <div id="week-compare-out"></div></div>
      <div class="chart-title" style="padding:4px 0 10px;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;">ALLE MESSUNGEN</div>
      <div id="weight-groups"></div>
    </div>

    <!-- BP -->
    <div id="view-bp" class="view">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;flex-wrap:wrap;">
        <button class="btn btn-ghost btn-sm" onclick="exportBPPDF()">&#x1F4C4; PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="exportBPCSV()">&#x1F4CA; CSV</button>
        <button class="btn btn-ghost btn-sm" onclick="g('modal-bp-import').classList.add('open')">&#x1F4C2; Import</button>
      </div>
      <div class="chart-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
          <div class="chart-title" style="margin-bottom:0;">VERLAUF</div>
          <div style="display:flex;gap:4px;">
            <button class="fbtn bptf" onclick="setBPTimeFilter('1m',this)">1M</button>
            <button class="fbtn bptf" onclick="setBPTimeFilter('3m',this)">3M</button>
            <button class="fbtn bptf" onclick="setBPTimeFilter('6m',this)">6M</button>
            <button class="fbtn bptf" onclick="setBPTimeFilter('1y',this)">1J</button>
            <button class="fbtn bptf active" onclick="setBPTimeFilter('all',this)">Alle</button>
          </div>
        </div>
        <div class="filter-row">
          <button class="fbtn bpv active" onclick="switchBPView('both',this)">Beide</button>
          <button class="fbtn bpv" onclick="switchBPView('sys',this)">Systolisch</button>
          <button class="fbtn bpv" onclick="switchBPView('dia',this)">Diastolisch</button>
        </div>
        <canvas id="bpChart" height="220"></canvas>
      </div>
      <div class="chart-wrap" style="margin-top:0;">
        <div class="chart-title" style="margin-bottom:12px;">DURCHSCHNITTSWERTE</div>
        <div id="bp-averages"></div>
      </div>
      <div class="chart-wrap" style="overflow-x:auto;">
        <div class="chart-title">LETZTE 7 TAGE</div><div id="bp-table-out"></div></div>
      <div class="chart-title" style="padding:4px 0 10px;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;">ALLE MESSUNGEN</div>
      <div id="bp-groups"></div>
    </div>

    <!-- SHARED -->
    <div id="view-shared" class="view">
      <!-- Person list screen -->
      <div id="shared-list-screen">
        <div class="chart-wrap" style="margin-bottom:16px;">
          <div class="chart-title" style="margin-bottom:4px;">FREIGEGEBENE DATEN</div>
          <p style="font-size:13px;color:var(--muted);">Personen die dir Zugriff gew√§hrt haben.</p>
        </div>
        <div id="shared-persons-list"></div>
      </div>
      <!-- Person detail screen -->
      <div id="shared-detail-screen" style="display:none;">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
          <button class="btn btn-ghost btn-sm" onclick="closeSharedDetail()">&#8592; Zur√ºck</button>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="user-avatar" style="width:36px;height:36px;font-size:16px;" id="shared-detail-avatar">?</div>
            <div style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--accent3);" id="shared-detail-name">‚Äì</div>
          </div>
        </div>
        <!-- Sub-tabs for shared person -->
        <div style="display:flex;gap:4px;background:var(--surface);border-radius:10px;padding:4px;margin-bottom:16px;overflow-x:auto;" id="shared-subtabs"></div>
        <!-- Content area -->
        <div id="shared-detail-content"></div>
      </div>
    </div>

    <!-- PROFILE -->
    <div id="view-profile" class="view">
      <div class="profile-card">
        <div class="profile-avatar-big" id="profile-avatar-big">?</div>
        <div class="profile-name" id="profile-name-display">‚Ä¶</div>
        <div class="profile-email" id="profile-email-display">‚Ä¶</div>
        <div style="margin-top:16px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" onclick="openEditProfile()">‚úèÔ∏è Name √§ndern</button>
          <button class="btn btn-ghost btn-sm" onclick="openChangePw()">üîë Passwort √§ndern</button>
          <button class="btn btn-danger btn-sm" onclick="doLogout()">Abmelden</button>
        </div>
      </div>
      <div class="chart-wrap">
        <div class="chart-title" style="margin-bottom:4px;">FREIGABEN VERWALTEN</div>
        <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Gib bestimmten Personen Einblick in deine Daten.</p>
        <button class="btn btn-accent btn-sm" style="margin-bottom:16px;" onclick="openNewShare()">+ Neue Freigabe</button>
        <div id="shares-list"></div>
      </div>
      <!-- EINSTELLUNGEN -->
      <div class="chart-wrap" style="margin-top:16px;">
        <div class="chart-title" style="margin-bottom:4px;">EINSTELLUNGEN</div>
        <p style="font-size:11px;color:var(--muted);margin-bottom:14px;">Ziehe die Tabs in die gew√ºnschte Reihenfolge. Checkbox zum Ein-/Ausblenden.</p>
        <div id="tab-order-list" style="display:flex;flex-direction:column;gap:6px;"></div>
      </div>
    </div>

    <!-- SCHLAF -->
    <div id="view-sleep" class="view">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;">
        <button class="btn btn-ghost btn-sm" onclick="exportSleepPDF()">üìÑ PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="exportSleepCSV()">üìä CSV</button>
      </div>
      <div class="chart-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
          <div class="chart-title" style="margin-bottom:0;">VERLAUF</div>
          <div style="display:flex;gap:4px;">
            <button class="fbtn sltf active" onclick="setSleepTimeFilter('1m',this)">1M</button>
            <button class="fbtn sltf" onclick="setSleepTimeFilter('3m',this)">3M</button>
            <button class="fbtn sltf" onclick="setSleepTimeFilter('6m',this)">6M</button>
            <button class="fbtn sltf" onclick="setSleepTimeFilter('1y',this)">1J</button>
            <button class="fbtn sltf" onclick="setSleepTimeFilter('all',this)">Alle</button>
          </div>
        </div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:600;">SCHLAFDAUER</div>
        <canvas id="sleepChart" height="180"></canvas>
        <div style="font-size:11px;color:var(--muted);margin-top:14px;margin-bottom:6px;font-weight:600;">SCHLAFQUALIT√ÑT</div>
        <div id="sleepRatingChart"></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-title" style="margin-bottom:12px;">DURCHSCHNITTSWERTE</div>
        <div id="sleep-averages"></div>
      </div>
      <div class="chart-title" style="padding:4px 0 10px;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;">ALLE EINTR√ÑGE</div>
      <div id="sleep-groups"></div>
    </div>

    <!-- HABITS -->
    <div id="view-habits" class="view">
      <div class="chart-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:12px;">
          <div class="chart-title" style="margin-bottom:0;">DIESE WOCHE</div>
          <div style="display:flex;align-items:center;gap:4px;">
            <button class="btn btn-ghost btn-sm" onclick="habitWeekOffset(-1)">&#8592;</button>
            <span id="habit-week-label" style="font-size:11px;color:var(--muted);min-width:90px;text-align:center;"></span>
            <button class="btn btn-ghost btn-sm" onclick="habitWeekOffset(1)">&#8594;</button>
          </div>
        </div>
        <div id="habit-week-grid"></div>
      </div>
      <div class="chart-wrap">
        <div class="chart-title" style="margin-bottom:10px;">VERLAUF (30 TAGE)</div>
        <canvas id="habitChart" height="200"></canvas>
      </div>
    </div>

    <!-- STIMMUNG -->
    <div id="view-mood" class="view">
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-bottom:10px;">
        <button class="btn btn-ghost btn-sm" onclick="exportMoodPDF()">üìÑ PDF</button>
        <button class="btn btn-ghost btn-sm" onclick="exportMoodCSV()">üòä CSV</button>
      </div>
      <div class="chart-wrap">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
          <div class="chart-title" style="margin-bottom:0;">VERLAUF</div>
          <div style="display:flex;gap:4px;">
            <button class="fbtn mdtf active" onclick="setMoodTimeFilter('1m',this)">1M</button>
            <button class="fbtn mdtf" onclick="setMoodTimeFilter('3m',this)">3M</button>
            <button class="fbtn mdtf" onclick="setMoodTimeFilter('6m',this)">6M</button>
            <button class="fbtn mdtf" onclick="setMoodTimeFilter('1y',this)">1J</button>
            <button class="fbtn mdtf" onclick="setMoodTimeFilter('all',this)">Alle</button>
          </div>
        </div>
        <canvas id="moodChart" height="200"></canvas>
      </div>
      <div class="chart-wrap">
        <div class="chart-title" style="margin-bottom:12px;">DURCHSCHNITTSWERTE</div>
        <div id="mood-averages"></div>
      </div>
      <div class="chart-title" style="padding:4px 0 10px;font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;">ALLE EINTR√ÑGE</div>
      <div id="mood-groups"></div>
    </div>

    <!-- MAKROS -->
    <div id="view-macros" class="view">

      <!-- SECTION 1: EINGABEN -->
      <div class="chart-wrap" style="margin-bottom:12px;">
        <div class="chart-title" style="margin-bottom:14px;">DEINE DATEN</div>

        <div class="macro-row">
          <label class="macro-label">Geschlecht</label>
          <div style="display:flex;gap:8px;">
            <button class="macro-toggle active" id="mg-m" onclick="setMacroGender('m')">‚ôÇ M√§nnlich</button>
            <button class="macro-toggle" id="mg-f" onclick="setMacroGender('f')">‚ôÄ Weiblich</button>
          </div>
        </div>

        <div class="macro-row">
          <label class="macro-label">Alter</label>
          <div class="macro-input-wrap"><input type="number" class="macro-input" id="mc-alter" min="10" max="100" placeholder="29" oninput="calcMacros()"><span class="macro-unit">Jahre</span></div>
        </div>

        <div class="macro-row">
          <label class="macro-label">Gr√∂√üe</label>
          <div class="macro-input-wrap"><input type="number" class="macro-input" id="mc-groesse" min="100" max="250" placeholder="180" oninput="calcMacros()"><span class="macro-unit">cm</span></div>
        </div>

        <div class="macro-row">
          <label class="macro-label">Gewicht</label>
          <div class="macro-input-wrap"><input type="number" class="macro-input" id="mc-gewicht" min="30" max="300" step="0.1" placeholder="80" oninput="calcMacros()"><span class="macro-unit">kg</span></div>
        </div>

        <div class="macro-row">
          <label class="macro-label">Wunschgewicht</label>
          <div class="macro-input-wrap"><input type="number" class="macro-input" id="mc-wunsch" min="30" max="300" step="0.1" placeholder="75" oninput="calcMacros()"><span class="macro-unit">kg</span></div>
        </div>

        <div class="macro-row">
          <label class="macro-label">Aktivit√§t</label>
          <select class="macro-select" id="mc-aktivitaet" onchange="calcMacros()">
            <option value="1.4">Normale Aktivit√§t</option>
            <option value="1.6">Erh√∂hte Aktivit√§t</option>
            <option value="1.8">Sehr hohe Aktivit√§t</option>
            <option value="2.0">H√∂chste Aktivit√§t / Leistungssportler</option>
          </select>
        </div>

        <div class="macro-row">
          <label class="macro-label">Proteinanteil</label>
          <div style="display:flex;gap:6px;">
            <button class="macro-toggle3 active" id="mp-low" onclick="setMacro3('protein','low')">Niedrig</button>
            <button class="macro-toggle3" id="mp-mid" onclick="setMacro3('protein','mid')">Moderat</button>
            <button class="macro-toggle3" id="mp-high" onclick="setMacro3('protein','high')">Hoch</button>
          </div>
        </div>

        <div class="macro-row">
          <label class="macro-label">Pflanzl. Protein</label>
          <div style="display:flex;gap:6px;">
            <button class="macro-toggle3 active" id="mpp-low" onclick="setMacro3('vprotein','low')">Niedrig</button>
            <button class="macro-toggle3" id="mpp-mid" onclick="setMacro3('vprotein','mid')">Moderat</button>
            <button class="macro-toggle3" id="mpp-high" onclick="setMacro3('vprotein','high')">Hoch</button>
          </div>
        </div>

        <div class="macro-row">
          <label class="macro-label">Fettanteil</label>
          <div style="display:flex;gap:6px;">
            <button class="macro-toggle3" id="mf-low" onclick="setMacro3('fat','low')">Niedrig</button>
            <button class="macro-toggle3 active" id="mf-mid" onclick="setMacro3('fat','mid')">Moderat</button>
            <button class="macro-toggle3" id="mf-high" onclick="setMacro3('fat','high')">Hoch</button>
          </div>
        </div>
      </div>

      <!-- SECTION 1.1: KALORIENBEREICH -->
      <div class="chart-wrap" style="margin-bottom:12px;" id="macro-results-kcal" style="display:none;">
        <div class="chart-title" style="margin-bottom:14px;">1.1 KALORIENBEREICH</div>
        <div class="macro-result-row">
          <span class="macro-result-label">Grundbedarf</span>
          <span class="macro-result-val" id="mr-grundbedarf">‚Äî</span>
        </div>
        <div class="macro-result-row">
          <span class="macro-result-label">Kritischer Bereich</span>
          <span class="macro-result-val" id="mr-kritisch">‚Äî</span>
        </div>
        <div class="macro-result-row macro-highlight-deficit">
          <span class="macro-result-label">Kaloriendefizit</span>
          <span class="macro-result-val accent3" id="mr-defizit">‚Äî</span>
        </div>
        <div class="macro-result-row">
          <span class="macro-result-label">Theoret. Erhaltung</span>
          <span class="macro-result-val" id="mr-erhaltung-t">‚Äî</span>
        </div>
        <div class="macro-result-row macro-highlight-maint">
          <span class="macro-result-label">Prakt. Erhaltung</span>
          <span class="macro-result-val accent4" id="mr-erhaltung-p">‚Äî</span>
        </div>
      </div>

      <!-- SECTION 1.2: MAKRON√ÑHRSTOFFE -->
      <div class="chart-wrap" style="margin-bottom:12px;" id="macro-results-makros">
        <div class="chart-title" style="margin-bottom:14px;">1.2 MAKRON√ÑHRSTOFFE</div>
        <div class="macro-result-row">
          <span class="macro-result-label">üçó Proteine</span>
          <span class="macro-result-val accent" id="mr-protein">‚Äî</span>
        </div>
        <div style="background:var(--surface);border-radius:8px;height:6px;margin:-6px 0 10px;overflow:hidden;">
          <div id="mr-protein-bar" style="height:100%;background:var(--accent);border-radius:8px;width:0%;transition:width .4s;"></div>
        </div>
        <div class="macro-result-row">
          <span class="macro-result-label">ü•ë Fette</span>
          <span class="macro-result-val accent3" id="mr-fett">‚Äî</span>
        </div>
        <div style="background:var(--surface);border-radius:8px;height:6px;margin:-6px 0 10px;overflow:hidden;">
          <div id="mr-fett-bar" style="height:100%;background:var(--accent3);border-radius:8px;width:0%;transition:width .4s;"></div>
        </div>
        <div class="macro-result-row">
          <span class="macro-result-label">üçû Kohlenhydrate</span>
          <span class="macro-result-val accent4" id="mr-kh">‚Äî</span>
        </div>
        <div style="background:var(--surface);border-radius:8px;height:6px;margin:-6px 0 10px;overflow:hidden;">
          <div id="mr-kh-bar" style="height:100%;background:var(--accent4);border-radius:8px;width:0%;transition:width .4s;"></div>
        </div>
        <div id="mr-macro-note" style="font-size:11px;color:var(--muted);margin-top:8px;"></div>
      </div>

      <!-- SECTION 2: K√ñRPERFETTZUNAHME -->
      <div class="chart-wrap" style="margin-bottom:12px;" id="macro-results-kfz">
        <div class="chart-title" style="margin-bottom:14px;">2.1 AB WANN NEHME ICH K√ñRPERFETT ZU?</div>
        <div class="macro-result-row">
          <span class="macro-result-label">Zunahme nicht m√∂glich</span>
          <span class="macro-result-val accent3" id="mr-kf1">‚Äî</span>
        </div>
        <div class="macro-result-row">
          <span class="macro-result-label">Zunahme unwahrscheinlich</span>
          <span class="macro-result-val" id="mr-kf2">‚Äî</span>
        </div>
        <div class="macro-result-row">
          <span class="macro-result-label">Zunahme m√∂glich</span>
          <span class="macro-result-val accent" id="mr-kf3">‚Äî</span>
        </div>
        <div class="macro-result-row">
          <span class="macro-result-label">Zunahme wahrscheinlich</span>
          <span class="macro-result-val accent2" id="mr-kf4">‚Äî</span>
        </div>
      </div>

      <!-- SECTION 2.2: TAGE BIS ZUNAHME -->
      <div class="chart-wrap" id="macro-results-tage">
        <div class="chart-title" style="margin-bottom:14px;">2.2 TAGE BIS K√ñRPERFETTZUNAHME</div>
        <div class="macro-row" style="margin-bottom:12px;">
          <label class="macro-label">Kalorienanzahl</label>
          <div class="macro-input-wrap"><input type="number" class="macro-input" id="mc-kcal-input" min="500" max="8000" placeholder="3500" oninput="calcKfTage()"><span class="macro-unit">kcal</span></div>
        </div>
        <div class="macro-result-row macro-highlight-deficit">
          <span class="macro-result-label">Anzahl der Tage</span>
          <span class="macro-result-val accent3" id="mr-tage">‚Äî</span>
        </div>
        <div id="mr-tage-note" style="font-size:11px;color:var(--muted);margin-top:6px;"></div>
      </div>

    </div>
  </main>

  <button class="fab fab-yellow" id="main-fab" onclick="fabAction()">Ôºã</button>
</div>

<!-- MODALS -->
<div class="modal-bg" id="modal-session">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">NEUE EINHEIT</div>
      <button class="close-btn" onclick="closeModal('modal-session')">‚úï</button>
    </div>
    <div class="field"><label>Datum</label><input type="date" id="s-date"></div>
    <div class="field"><label>Name (optional)</label><input type="text" id="s-name" placeholder="z.B. Push Day ‚Ä¶"></div>
    <div class="divider"></div>
    <div id="ex-container"></div>
    <button class="btn btn-ghost" style="width:100%;margin-bottom:16px;" onclick="addExercise()">+ √úbung hinzuf√ºgen</button>
    <div class="divider"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeModal('modal-session')">Abbrechen</button>
      <button class="btn btn-accent" onclick="saveSession()">üíæ Speichern</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-detail">
  <div class="modal">
    <div class="modal-header">
      <div><div class="modal-title" id="d-title"></div>
        <div style="font-size:12px;color:var(--muted);margin-top:2px;" id="d-sub"></div></div>
      <div style="display:flex;gap:8px;">
        <button class="btn btn-danger btn-sm" onclick="deleteCurrentSession()">üóë L√∂schen</button>
        <button class="close-btn" onclick="closeModal('modal-detail')">‚úï</button>
      </div>
    </div>
    <div id="d-content"></div>
  </div>
</div>

<div class="modal-bg" id="modal-plan">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="plan-modal-ttl">NEUER PLAN</div>
      <button class="close-btn" onclick="closeModal('modal-plan')">‚úï</button>
    </div>
    <div class="field"><label>Planname</label><input type="text" id="p-name" placeholder="z.B. Push A ‚Ä¶"></div>
    <div class="divider"></div>
    <div id="p-ex-container"></div>
    <button class="btn btn-ghost" style="width:100%;margin-bottom:16px;" onclick="addPlanEx()">+ √úbung hinzuf√ºgen</button>
    <div class="divider"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeModal('modal-plan')">Abbrechen</button>
      <button class="btn btn-accent" id="plan-save-btn" onclick="savePlan()">üíæ Plan speichern</button>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-weight">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="w-modal-ttl">MESSUNG ERFASSEN</div>
      <button class="close-btn" onclick="closeModal('modal-weight')">‚úï</button>
    </div>
    <div class="field"><label>Datum</label><input type="date" id="w-date"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field"><label>Gewicht (kg)</label><input type="number" id="w-kg" placeholder="82.5" step="0.1" min="0"></div>
      <div class="field"><label>Kalorien (kcal)</label><input type="number" id="w-kcal" placeholder="2200" min="0"></div>
      <div class="field"><label>Bauchumfang (cm)</label><input type="number" id="w-bauch" placeholder="88" step="0.1" min="0"></div>
      <div class="field"><label>H√ºftumfang (cm)</label><input type="number" id="w-hueft" placeholder="98" step="0.1" min="0"></div>
    </div>
    <p style="font-size:12px;color:var(--muted);margin-bottom:16px;">* Mindestens ein Feld muss ausgef√ºllt sein.</p>
    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;">
      <button class="btn btn-danger btn-sm" id="w-del-btn" style="display:none;" onclick="deleteWeightEntry()">üóë L√∂schen</button>
      <div style="display:flex;gap:10px;margin-left:auto;">
        <button class="btn btn-ghost" onclick="closeModal('modal-weight')">Abbrechen</button>
        <button class="btn btn-accent" onclick="saveWeightEntry()">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-bp">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="bp-modal-ttl">BLUTDRUCK ERFASSEN</div>
      <button class="close-btn" onclick="closeModal('modal-bp')">‚úï</button>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field"><label>Datum</label><input type="date" id="bp-date"></div>
      <div class="field"><label>Uhrzeit</label><input type="time" id="bp-time"></div>
      <div class="field"><label>Systolisch (mmHg)</label><input type="number" id="bp-sys" placeholder="120"></div>
      <div class="field"><label>Diastolisch (mmHg)</label><input type="number" id="bp-dia" placeholder="80"></div>
    </div>
    <div class="field"><label>Bemerkung (optional)</label><input type="text" id="bp-note" placeholder="z.B. morgens, nach Sport ‚Ä¶"></div>
    <div style="display:flex;gap:8px;justify-content:space-between;align-items:center;">
      <button class="btn btn-danger btn-sm" id="bp-del-btn" style="display:none;" onclick="deleteBPEntry()">üóë L√∂schen</button>
      <div style="display:flex;gap:10px;margin-left:auto;">
        <button class="btn btn-ghost" onclick="closeModal('modal-bp')">Abbrechen</button>
        <button class="btn btn-accent" onclick="saveBPEntry()">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-share">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="share-modal-title">FREIGABE ERSTELLEN</div>
      <button class="close-btn" onclick="closeModal('modal-share')">‚úï</button>
    </div>
    <div class="field" id="share-email-field"><label>E-Mail der Person</label><input type="email" id="share-email" placeholder="freund@email.de"></div>
    <div id="share-email-display" style="display:none;font-size:13px;font-weight:600;color:var(--accent3);margin-bottom:12px;padding:8px;background:var(--surface);border-radius:8px;"></div>
    <div class="field"><label>Was freigeben?</label>
      <div class="check-group">
        <label class="check-item"><input type="checkbox" id="sc-log"><span style="font-size:13px;font-weight:600;">üìã Training Log &amp; Stats</span></label>
        <label class="check-item"><input type="checkbox" id="sc-weight"><span style="font-size:13px;font-weight:600;">‚öñÔ∏è Gewicht &amp; K√∂rperma√üe</span></label>
        <label class="check-item"><input type="checkbox" id="sc-bp"><span style="font-size:13px;font-weight:600;">‚ù§Ô∏è Blutdruck</span></label>
        <label class="check-item"><input type="checkbox" id="sc-sleep"><span style="font-size:13px;font-weight:600;">üò¥ Schlaf</span></label>
        <label class="check-item"><input type="checkbox" id="sc-mood"><span style="font-size:13px;font-weight:600;">üòä Stimmung</span></label>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:space-between;align-items:center;">
      <button class="btn btn-danger btn-sm" id="share-delete-btn" style="display:none;" onclick="deleteCurrentShare()">üóë Freigabe entfernen</button>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-ghost" onclick="closeModal('modal-share')">Abbrechen</button>
        <button class="btn btn-accent" onclick="saveShare()">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-profile-edit">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">NAME √ÑNDERN</div>
      <button class="close-btn" onclick="closeModal('modal-profile-edit')">‚úï</button>
    </div>
    <div class="field"><label>Name</label><input type="text" id="edit-name" placeholder="Dein Name"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeModal('modal-profile-edit')">Abbrechen</button>
      <button class="btn btn-accent" onclick="saveProfile()">üíæ Speichern</button>
    </div>
  </div>
</div>


<!-- MODAL: HABIT ERSTELLEN/BEARBEITEN -->
<div class="modal-bg" id="modal-habit">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="habit-modal-title">HABIT ERSTELLEN</div>
      <button class="close-btn" onclick="closeModal('modal-habit')">‚úï</button>
    </div>
    <div class="field"><label>Name</label><input type="text" id="habit-name" placeholder="z.B. Wasser trinken, Sport..."></div>
    <div class="field"><label>H√§ufigkeit</label>
      <select id="habit-freq">
        <option value="1_daily">1√ó t√§glich</option>
        <option value="2_daily">2√ó t√§glich</option>
        <option value="3_daily">3√ó t√§glich</option>
        <option value="1_weekly">1√ó pro Woche</option>
        <option value="2_weekly">2√ó pro Woche</option>
        <option value="3_weekly">3√ó pro Woche</option>
        <option value="4_weekly">4√ó pro Woche</option>
        <option value="5_weekly">5√ó pro Woche</option>
        <option value="6_weekly">6√ó pro Woche</option>
        <option value="1_monthly">1√ó pro Monat</option>
        <option value="custom">Individuell...</option>
      </select>
    </div>
    <div class="field" id="habit-custom-field" style="display:none;">
      <label>Anzahl pro Tag</label>
      <input type="number" id="habit-custom-count" min="1" max="20" value="1" style="text-align:center;">
    </div>
    <div class="field"><label>Farbe</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;" id="habit-color-btns">
        <button class="habit-color-btn active" data-color="#47c8ff" onclick="selectHabitColor('#47c8ff',this)" style="width:28px;height:28px;border-radius:50%;background:#47c8ff;border:3px solid #47c8ff;"></button>
        <button class="habit-color-btn" data-color="#47ffb8" onclick="selectHabitColor('#47ffb8',this)" style="width:28px;height:28px;border-radius:50%;background:#47ffb8;border:3px solid transparent;"></button>
        <button class="habit-color-btn" data-color="#e8ff47" onclick="selectHabitColor('#e8ff47',this)" style="width:28px;height:28px;border-radius:50%;background:#e8ff47;border:3px solid transparent;"></button>
        <button class="habit-color-btn" data-color="#ff9f47" onclick="selectHabitColor('#ff9f47',this)" style="width:28px;height:28px;border-radius:50%;background:#ff9f47;border:3px solid transparent;"></button>
        <button class="habit-color-btn" data-color="#c847ff" onclick="selectHabitColor('#c847ff',this)" style="width:28px;height:28px;border-radius:50%;background:#c847ff;border:3px solid transparent;"></button>
        <button class="habit-color-btn" data-color="#ff4757" onclick="selectHabitColor('#ff4757',this)" style="width:28px;height:28px;border-radius:50%;background:#ff4757;border:3px solid transparent;"></button>
      </div>
    </div>
    <div style="display:flex;gap:10px;justify-content:space-between;margin-top:8px;">
      <button class="btn btn-danger btn-sm" id="habit-del-btn" style="display:none;" onclick="deleteHabit()">üóë L√∂schen</button>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-ghost" onclick="closeModal('modal-habit')">Abbrechen</button>
        <button class="btn btn-accent" onclick="saveHabit()">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: SCHLAF ERFASSEN -->
<div class="modal-bg" id="modal-sleep">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="sleep-modal-ttl">SCHLAF ERFASSEN</div>
      <button class="close-btn" onclick="closeModal('modal-sleep')">‚úï</button>
    </div>
    <div class="field"><label>Datum</label><input type="date" id="sleep-date"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div class="field"><label>Eingeschlafen</label><input type="time" id="sleep-from"></div>
      <div class="field"><label>Aufgewacht</label><input type="time" id="sleep-to"></div>
    </div>
    <div class="field" style="margin-bottom:4px;"><label>Schlafdauer</label>
      <div id="sleep-duration-display" style="padding:10px;background:var(--surface);border-radius:8px;font-size:14px;font-weight:700;color:var(--accent3);">‚Äî</div>
    </div>
    <div class="field"><label>Bewertung</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;" id="sleep-rating-btns">
        <button class="rating-btn" data-val="1" onclick="selectSleepRating(1,this)">Gut üòä</button>
        <button class="rating-btn" data-val="0" onclick="selectSleepRating(0,this)">Neutral üòê</button>
        <button class="rating-btn" data-val="-1" onclick="selectSleepRating(-1,this)">Schlecht üòî</button>
      </div>
    </div>
    <div class="field"><label>Notiz (optional)</label><input type="text" id="sleep-note" placeholder="z.B. Unruhig, Alptraum..."></div>
    <div style="display:flex;gap:10px;justify-content:space-between;margin-top:8px;">
      <button class="btn btn-danger btn-sm" id="sleep-del-btn" onclick="deleteSleepEntry()" style="display:none;">üóë L√∂schen</button>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-ghost" onclick="closeModal('modal-sleep')">Abbrechen</button>
        <button class="btn btn-accent" onclick="saveSleepEntry()">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: STIMMUNG ERFASSEN -->
<div class="modal-bg" id="modal-mood">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="mood-modal-ttl">STIMMUNG ERFASSEN</div>
      <button class="close-btn" onclick="closeModal('modal-mood')">‚úï</button>
    </div>
    <div class="field"><label>Datum</label><input type="date" id="mood-date"></div>
    <div class="field"><label>Uhrzeit</label><input type="time" id="mood-time"></div>
    <div class="field"><label>Stimmung</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:4px;" id="mood-rating-btns">
        <button class="rating-btn" data-val="2" onclick="selectMoodRating(2,this)">Sehr gut üòÑ</button>
        <button class="rating-btn" data-val="1" onclick="selectMoodRating(1,this)">Gut üôÇ</button>
        <button class="rating-btn" data-val="0" onclick="selectMoodRating(0,this)">Neutral üòê</button>
        <button class="rating-btn" data-val="-1" onclick="selectMoodRating(-1,this)">Schlecht üòï</button>
        <button class="rating-btn" data-val="-2" onclick="selectMoodRating(-2,this)">Sehr schlecht üòû</button>
      </div>
    </div>
    <div class="field"><label>Notiz (optional)</label><input type="text" id="mood-note" placeholder="z.B. Stress bei der Arbeit..."></div>
    <div style="display:flex;gap:10px;justify-content:space-between;margin-top:8px;">
      <button class="btn btn-danger btn-sm" id="mood-del-btn" onclick="deleteMoodEntry()" style="display:none;">üóë L√∂schen</button>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-ghost" onclick="closeModal('modal-mood')">Abbrechen</button>
        <button class="btn btn-accent" onclick="saveMoodEntry()">üíæ Speichern</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-bg" id="modal-pdf-select">
  <div class="modal" style="max-width:340px;">
    <div class="modal-header">
      <div class="modal-title" id="pdf-select-title">PDF EXPORT</div>
      <button class="close-btn" onclick="closeModal('modal-pdf-select')">‚úï</button>
    </div>
    <p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Was soll im PDF enthalten sein?</p>
    <div style="display:flex;flex-direction:column;gap:10px;">
      <button class="btn btn-accent" onclick="_pdfCallback('table')">üìã Tabelle (alle Eintr√§ge)</button>
      <button class="btn btn-ghost" onclick="_pdfCallback('chart')">üìà Diagramm (aktueller Zeitraum)</button>
      <button class="btn btn-ghost" onclick="_pdfCallback('both')">üìÑ Beides (Diagramm + Tabelle)</button>
    </div>
    <button class="btn btn-ghost btn-sm" style="width:100%;margin-top:12px;" onclick="closeModal('modal-pdf-select')">Abbrechen</button>
  </div>
</div>

<div id="toast"></div>

<!-- MODAL: GEWICHT CSV IMPORT -->
<div class="modal-bg" id="modal-weight-import">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <div class="modal-title">GEWICHT CSV IMPORT</div>
      <button class="close-btn" onclick="closeModal('modal-weight-import')">&#x2715;</button>
    </div>
    <div style="background:var(--surface);border-radius:10px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--muted);line-height:1.7;">
      <div style="font-weight:700;color:var(--text);margin-bottom:6px;">CSV Format:</div>
      <code style="color:var(--accent4);font-size:11px;">datum,gewicht,bauch,huefte,kalorien</code><br>
      <code style="color:var(--muted);font-size:11px;">2024-01-15,82.5,95,102,2200</code><br>
      <code style="color:var(--muted);font-size:11px;">2024-01-22,81.8,,100,</code>
      <div style="margin-top:8px;font-size:11px;">&#x2139; Leere Felder sind erlaubt. Datum muss im Format YYYY-MM-DD sein.</div>
    </div>
    <div class="field">
      <label>CSV Datei ausw&#228;hlen</label>
      <input type="file" id="weight-csv-file" accept=".csv,.txt" style="padding:8px;">
    </div>
    <div id="weight-import-preview" style="display:none;margin-bottom:12px;">
      <div style="font-size:12px;font-weight:600;margin-bottom:6px;" id="weight-import-info"></div>
      <div style="max-height:180px;overflow-y:auto;background:var(--surface);border-radius:8px;padding:8px;" id="weight-import-table"></div>
    </div>
    <div id="weight-import-err" style="color:var(--accent2);font-size:12px;margin-bottom:8px;display:none;"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeModal('modal-weight-import');resetWeightImport()">Abbrechen</button>
      <button class="btn btn-accent" id="weight-import-btn" onclick="doWeightImport()" style="display:none;">&#x1F4BE; Importieren</button>
    </div>
  </div>
</div>

<!-- MODAL: BLUTDRUCK CSV IMPORT -->
<div class="modal-bg" id="modal-bp-import">
  <div class="modal" style="max-width:480px;">
    <div class="modal-header">
      <div class="modal-title">BLUTDRUCK CSV IMPORT</div>
      <button class="close-btn" onclick="closeModal('modal-bp-import')">&#x2715;</button>
    </div>
    <div style="background:var(--surface);border-radius:10px;padding:12px;margin-bottom:16px;font-size:12px;color:var(--muted);line-height:1.7;">
      <div style="font-weight:700;color:var(--text);margin-bottom:6px;">CSV Format:</div>
      <code style="color:var(--accent2);font-size:11px;">datum,uhrzeit,systolisch,diastolisch,notiz</code><br>
      <code style="color:var(--muted);font-size:11px;">2024-01-15,08:30,120,80,Morgens</code><br>
      <code style="color:var(--muted);font-size:11px;">2024-01-15,20:00,118,76,</code>
      <div style="margin-top:8px;font-size:11px;">&#x2139; Uhrzeit und Notiz sind optional. Datum: YYYY-MM-DD, Uhrzeit: HH:MM</div>
    </div>
    <div class="field">
      <label>CSV Datei ausw&#228;hlen</label>
      <input type="file" id="bp-csv-file" accept=".csv,.txt" style="padding:8px;">
    </div>
    <div id="bp-import-preview" style="display:none;margin-bottom:12px;">
      <div style="font-size:12px;font-weight:600;margin-bottom:6px;" id="bp-import-info"></div>
      <div style="max-height:180px;overflow-y:auto;background:var(--surface);border-radius:8px;padding:8px;" id="bp-import-table"></div>
    </div>
    <div id="bp-import-err" style="color:var(--accent2);font-size:12px;margin-bottom:8px;display:none;"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;">
      <button class="btn btn-ghost" onclick="closeModal('modal-bp-import');resetBPImport()">Abbrechen</button>
      <button class="btn btn-accent" id="bp-import-btn" onclick="doBPImport()" style="display:none;">&#x1F4BE; Importieren</button>
    </div>
  </div>
</div>

<!-- MODAL: PASSWORT √ÑNDERN -->
<div class="modal-bg" id="modal-pw">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">PASSWORT √ÑNDERN</div>
      <button class="close-btn" onclick="closeModal('modal-pw')">‚úï</button>
    </div>
    <div class="field"><label>Neues Passwort</label><input type="password" id="pw-new" placeholder="Mind. 6 Zeichen"></div>
    <div class="field"><label>Passwort wiederholen</label><input type="password" id="pw-confirm" placeholder="Nochmal eingeben"></div>
    <div class="auth-err" id="pw-err"></div>
    <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:8px;">
      <button class="btn btn-ghost" onclick="closeModal('modal-pw')">Abbrechen</button>
      <button class="btn btn-accent" onclick="saveNewPw()">üíæ Speichern</button>
    </div>
  </div>
</div>

<script>
const SUPA_URL = 'https://ovawjghvikjivcoupvcb.supabase.co';
const SUPA_KEY = 'sb_publishable_8fbAlwYQV4x2STiO9lSOFQ_4rp7IaRB';
const { createClient } = supabase;
const sb = createClient(SUPA_URL, SUPA_KEY, {
  auth: {
    persistSession: true,
    autoRefreshToken: true,
    detectSessionInUrl: true,
    storage: window.localStorage,
    storageKey: 'ironlog-auth-v3'
  }
});

let currentUser=null, currentProfile=null;
let sessions=[], plans=[], weightEntries=[], bpEntries=[], sleepEntries=[], moodEntries=[], habits=[], habitLogs=[], shares=[];
let currentSessionId=null, editingWeightId=null, editingPlanId=null, editingBPId=null;
let activeTab='log';
let pChartI=null, wkChartI=null, wtChartI=null, bpChartI=null;
let currentWMetric='weight', currentBPView='both';
let exCounter=0, setCounters={}, planExCounter=0, awSetCounters={};
let timerRunning=false, timerSecs=0, timerTarget=null, timerStart=null, timerInterval=null, timerMinimized=false;
let appReady=false;

const g = id => document.getElementById(id);
function today(){ return new Date().toISOString().split('T')[0]; }
function nowTime(){ const n=new Date(); return n.getHours().toString().padStart(2,'0')+':'+n.getMinutes().toString().padStart(2,'0'); }
function fmtD(ds,opts){ return new Date(ds+'T12:00:00').toLocaleDateString('de-DE',opts); }
function fmtShort(ds){ return fmtD(ds,{day:'2-digit',month:'short'}); }
function weekMon(ds){ const d=new Date(ds+'T12:00:00'); d.setDate(d.getDate()-((d.getDay()+6)%7)); return d.toISOString().split('T')[0]; }
function weekLabel(ds){ return fmtD(weekMon(ds),{day:'2-digit',month:'short'}); }
function monthKey(ds){ return ds.substring(0,7); }
function monthLabel(mk){ const[y,m]=mk.split('-'); return new Date(parseInt(y),parseInt(m)-1,1).toLocaleDateString('de-DE',{month:'long',year:'numeric'}); }
function nameInitial(n){ return n?n.charAt(0).toUpperCase():'?'; }
function setSyncState(s){ const d=g('sync-dot'); if(d) d.className='sync-dot'+(s==='syncing'?' syncing':s==='error'?' error':''); }
function showToast(msg,isErr=false){ const t=g('toast'); t.textContent=(isErr?'\u26a0 ':'\u2713 ')+msg; t.className='show'+(isErr?' err':''); setTimeout(()=>t.className='',2800); }
function closeModal(id){ g(id).classList.remove('open'); }
function toggleYearGroup(id){
  const body=g('yb-'+id.replace('yg-',''));
  const arr=g('yarr-'+id.replace('yg-',''));
  if(!body)return;
  const open=body.classList.toggle('open');
  if(arr)arr.textContent=open?'‚ñº':'‚ñ∂';
}
function toggleGroup(id){ const b=g(id); b.classList.toggle('open'); const a=g(id.replace('g-','g-arr-')); if(a) a.textContent=b.classList.contains('open')?'\u25bc':'\u25b6'; }

// ‚îÄ‚îÄ SHOW/HIDE SCREENS ‚îÄ‚îÄ
function showScreen(name){
  g('loading-screen').style.display = name==='loading' ? 'flex' : 'none';
  g('auth-screen').style.display   = name==='auth'    ? 'flex' : 'none';
  g('app-screen').style.display    = name==='app'     ? 'block': 'none';
}

// ‚îÄ‚îÄ AUTH FUNCTIONS ‚îÄ‚îÄ
function switchAuthTab(tab,el){
  document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));
  el.classList.add('active');
  g('af-'+tab).classList.add('active');
}

async function doLogin(){
  const email=g('login-email').value.trim(), pw=g('login-pw').value;
  if(!email||!pw){ showAuthErr('login-err','Bitte E-Mail und Passwort eingeben.'); return; }
  const btn=g('login-btn'); btn.disabled=true; btn.textContent='...';
  const {data, error}=await sb.auth.signInWithPassword({email, password:pw});
  btn.disabled=false; btn.textContent='Anmelden';
  if(error){
    showAuthErr('login-err', 'Fehler: '+error.message);
    return;
  }
  // signInWithPassword returns session directly - don't wait for onAuthStateChange
  if(data?.session){
    await showApp(data.session);
  }
}

async function doRegister(){
  const name=g('reg-name').value.trim(), email=g('reg-email').value.trim(), pw=g('reg-pw').value;
  if(!name){ showAuthErr('reg-err','Bitte Name eingeben.'); return; }
  if(!email){ showAuthErr('reg-err','Bitte E-Mail eingeben.'); return; }
  if(pw.length<6){ showAuthErr('reg-err','Passwort mind. 6 Zeichen.'); return; }
  const btn=g('reg-btn'); btn.disabled=true; btn.textContent='...';
  const {data,error}=await sb.auth.signUp({email,password:pw,options:{data:{name}}});
  btn.disabled=false; btn.textContent='Registrieren';
  if(error){ showAuthErr('reg-err',error.message); return; }
  if(data?.user){
    try{ await sb.from('profiles').upsert({id:data.user.id,email,name},{onConflict:'id'}); }
    catch(e){ console.log('Profile pre-create:',e); }
  }
  showAuthErr('reg-err','\u2713 Registrierung erfolgreich! Bitte E-Mail bestaetigen, dann anmelden.',false);
}

function showAuthErr(id,msg,isErr=true){
  const e=g(id); if(!e) return;
  e.textContent=msg; e.style.display='block';
  e.style.color=isErr?'var(--accent2)':'var(--accent4)';
}

async function doLogout(){
  await sb.auth.signOut();
  currentUser=null; currentProfile=null; appReady=false;
  sessions=[]; plans=[]; weightEntries=[]; bpEntries=[]; sleepEntries=[]; moodEntries=[]; habits=[]; habitLogs=[]; shares=[];
  showScreen('auth');
}

function clearAndReload(){
  localStorage.clear(); sessionStorage.clear(); location.reload();
}

// ‚îÄ‚îÄ APP INIT ‚îÄ‚îÄ
async function showApp(session){
  if(appReady) return; // prevent double-init
  appReady=true;
  currentUser=session.user;
  showScreen('loading');
  try{
    await loadProfile();
    await loadAllData();
  }catch(e){ console.error('Load error:',e); }
  showScreen('app');
  renderLog(); updateFab(); populateLogPlanSelect(); loadSettings();
}

async function initApp(){
  showScreen('loading');

  // Handle password reset link
  const hash=window.location.hash;
  if(hash && hash.includes('type=recovery')){
    showScreen('auth');
    document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));
    const div=document.createElement('div'); div.className='auth-form active';
    div.innerHTML='<p style="font-size:13px;color:var(--muted);margin-bottom:16px;">Neues Passwort setzen:</p>'
      +'<div class="field"><label>Neues Passwort</label><input type="password" id="rec-pw" placeholder="Mind. 6 Zeichen"></div>'
      +'<div class="field"><label>Wiederholen</label><input type="password" id="rec-pw2" placeholder="Nochmal eingeben"></div>'
      +'<div class="auth-err" id="rec-err"></div>'
      +'<button class="btn btn-accent" style="width:100%;margin-top:8px;" onclick="doRecoverPw()">Passwort setzen</button>';
    document.querySelector('.auth-box').appendChild(div);
    return;
  }

  // Timeout safety net
  const killTimer=setTimeout(()=>{ if(!appReady){ console.warn('Auth timeout'); showScreen('auth'); } }, 6000);

  try{
    const {data:{session}}=await sb.auth.getSession();
    clearTimeout(killTimer);
    if(session){
      await showApp(session);
    } else {
      showScreen('auth');
    }
  }catch(e){
    clearTimeout(killTimer);
    console.error('initApp error:',e);
    showScreen('auth');
  }
}

// Auth state listener - only for token refresh and unexpected sign-out
sb.auth.onAuthStateChange(async(event, session)=>{
  console.log('Auth event:', event);
  if(event==='SIGNED_OUT'){
    currentUser=null; currentProfile=null; appReady=false;
    sessions=[]; plans=[]; weightEntries=[]; bpEntries=[]; sleepEntries=[]; moodEntries=[]; habits=[]; habitLogs=[]; shares=[];
    showScreen('auth');
  }
  if(event==='TOKEN_REFRESHED' && session){
    currentUser=session.user;
  }
  // INITIAL_SESSION fires on page load if session exists - use it as backup
  if(event==='INITIAL_SESSION' && session && !appReady){
    await showApp(session);
  }
});

// PWA: re-check on foreground
document.addEventListener('visibilitychange', async()=>{
  if(document.visibilityState==='visible' && !appReady){
    try{
      const {data:{session}}=await sb.auth.getSession();
      if(session && !appReady) await showApp(session);
    }catch(e){}
  }
});

initApp();

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ
async function loadProfile(){
  const {data,error}=await sb.from('profiles').select('*').eq('id',currentUser.id).single();
  if(data){
    currentProfile=data;
  } else {
    // Profile might not exist yet ‚Äì create it from auth user metadata
    const meta=currentUser.user_metadata||{};
    const name=meta.name||currentUser.email.split('@')[0];
    const {data:created}=await sb.from('profiles').upsert({id:currentUser.id,email:currentUser.email,name},{onConflict:'id'}).select().single();
    currentProfile=created||{id:currentUser.id,email:currentUser.email,name};
  }
  updateProfileUI();
}

function updateProfileUI(){
  if(!currentProfile) return;
  const init=nameInitial(currentProfile.name);
  const name=currentProfile.name||'?';
  const email=currentProfile.email||currentUser?.email||'';
  // header
  if(g('header-avatar')) g('header-avatar').textContent=init;
  if(g('header-name')) g('header-name').textContent=name;
  // profile page
  if(g('profile-avatar-big')) g('profile-avatar-big').textContent=init;
  if(g('profile-name-display')) g('profile-name-display').textContent=name;
  if(g('profile-email-display')) g('profile-email-display').textContent=email;
}

function openEditProfile(){ g('edit-name').value=currentProfile?.name||''; g('modal-profile-edit').classList.add('open'); }

async function saveProfile(){
  const name=g('edit-name').value.trim();
  if(!name) return;
  // Use upsert to ensure it works even if profile row doesn't exist yet
  const {error}=await sb.from('profiles').upsert({id:currentUser.id,email:currentProfile?.email||currentUser.email,name},{onConflict:'id'});
  if(error){ showToast('Fehler: '+error.message,true); return; }
  await sb.auth.updateUser({data:{name}});
  currentProfile={...currentProfile,name};
  updateProfileUI();
  closeModal('modal-profile-edit');
  showToast('Name gespeichert!');
}

async function loadAllData(){
  setSyncState('syncing');
  try{
    const uid=currentUser.id;
    const[s,p,w,b,sl,md,hb,hl,sh]=await Promise.all([
      sb.from('sessions').select('*').eq('user_id',uid).order('date',{ascending:false}),
      sb.from('plans').select('*').eq('user_id',uid).order('created_at',{ascending:false}),
      sb.from('weight_entries').select('*').eq('user_id',uid).order('date',{ascending:false}),
      sb.from('bp_entries').select('*').eq('user_id',uid).order('date',{ascending:false}),
      sb.from('sleep_entries').select('*').eq('user_id',uid).order('date',{ascending:false}),
      sb.from('mood_entries').select('*').eq('user_id',uid).order('date',{ascending:false}),
      sb.from('habits').select('*').eq('user_id',uid).order('created_at',{ascending:true}),
      sb.from('habit_logs').select('*').eq('user_id',uid).order('date',{ascending:false}),
      sb.from('shares').select('*').eq('owner_id',uid)
    ]);
    sessions=s.data||[]; plans=p.data||[]; weightEntries=w.data||[]; bpEntries=b.data||[];
    sleepEntries=sl.data||[]; moodEntries=md.data||[]; habits=hb.data||[]; habitLogs=hl.data||[]; shares=sh.data||[];
    setSyncState('ok');
  }catch(e){ setSyncState('error'); showToast('Sync-Fehler',true); }
}

// ‚îÄ‚îÄ SETTINGS ‚îÄ‚îÄ
const TAB_SETTINGS_BASE=[
  {id:'stats',   emoji:'üìä', label:'Stats',    default:true},
  {id:'weight',  emoji:'‚öñÔ∏è', label:'Gewicht',  default:true},
  {id:'bp',      emoji:'‚ù§Ô∏è', label:'Blutdruck',default:true},
  {id:'sleep',   emoji:'üò¥', label:'Schlaf',   default:true},
  {id:'habits',  emoji:'‚úÖ', label:'Habits',   default:true},
  {id:'mood',    emoji:'üòä', label:'Stimmung', default:true},
  {id:'macros',  emoji:'ü•ó', label:'Makros',   default:true},
];

function getTabOrder(){
  try{
    const saved=JSON.parse(localStorage.getItem('il_tab_order')||'null');
    if(saved&&Array.isArray(saved)&&saved.length>=TAB_SETTINGS_BASE.length) return saved;
  }catch(e){}
  return TAB_SETTINGS_BASE.map(s=>s.id);
}
function saveTabOrder(order){ localStorage.setItem('il_tab_order',JSON.stringify(order)); }
function getTabVisible(id){ const v=localStorage.getItem('il_vis_'+id); return v===null?true:v==='true'; }
function setTabVisible(id,show){ localStorage.setItem('il_vis_'+id,show); }

function loadSettings(){
  const order=getTabOrder();
  const nav=document.querySelector('nav');
  const spacer=nav.querySelector('.nav-spacer');
  // Reorder nav tabs according to saved order
  order.forEach(id=>{
    const tab=nav.querySelector(`.tab[data-tab="${id}"]`);
    if(tab) nav.insertBefore(tab,spacer);
  });
  // Apply visibility
  TAB_SETTINGS_BASE.forEach(s=>{
    const show=getTabVisible(s.id);
    const tab=nav.querySelector(`.tab[data-tab="${s.id}"]`);
    if(tab) tab.style.display=show?'':'none';
  });
  renderTabOrderList();
}

function renderTabOrderList(){
  const el=g('tab-order-list'); if(!el)return;
  const order=getTabOrder();
  el.innerHTML='';
  order.forEach(id=>{
    const meta=TAB_SETTINGS_BASE.find(s=>s.id===id); if(!meta)return;
    const show=getTabVisible(id);
    const row=document.createElement('div');
    row.dataset.tabid=id;
    row.draggable=true;
    row.style.cssText='display:flex;align-items:center;gap:10px;padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:10px;cursor:default;user-select:none;';
    row.innerHTML=`<span style="font-size:16px;color:var(--muted);cursor:grab;" title="Reihenfolge √§ndern">‚†ø</span>
      <input type="checkbox" ${show?'checked':''} onchange="onTabVisChange('${id}',this)" style="width:18px;height:18px;accent-color:var(--accent);cursor:pointer;flex-shrink:0;">
      <span style="font-size:13px;font-weight:600;flex:1;">${meta.emoji} ${meta.label}</span>`;
    initTabDnD(row);
    el.appendChild(row);
  });
}

let _tabDragSrc=null;

// ‚îÄ‚îÄ Unified DnD (mouse + touch) for tab order list ‚îÄ‚îÄ
function initTabDnD(row){
  // ‚îÄ‚îÄ Mouse drag ‚îÄ‚îÄ
  row.addEventListener('dragstart',e=>{_tabDragSrc=row;row.style.opacity='.4';e.dataTransfer.effectAllowed='move';});
  row.addEventListener('dragend',()=>{row.style.opacity='';document.querySelectorAll('#tab-order-list > div').forEach(r=>r.style.outline='');applyTabOrderFromList();});
  row.addEventListener('dragover',e=>{e.preventDefault();if(row!==_tabDragSrc)row.style.outline='2px solid var(--accent3)';});
  row.addEventListener('dragleave',()=>row.style.outline='');
  row.addEventListener('drop',e=>{
    e.preventDefault();e.stopPropagation();
    if(_tabDragSrc&&_tabDragSrc!==row){
      const list=g('tab-order-list');
      const items=[...list.children];
      const si=items.indexOf(_tabDragSrc),ti=items.indexOf(row);
      if(si<ti) list.insertBefore(_tabDragSrc,row.nextSibling);
      else list.insertBefore(_tabDragSrc,row);
    }
    row.style.outline='';
  });

  // ‚îÄ‚îÄ Touch drag ‚îÄ‚îÄ
  const handle=row.querySelector('span[title="Reihenfolge √§ndern"]')||row;
  handle.addEventListener('touchstart',e=>{
    _tabDragSrc=row;
    row.style.opacity='.5';
    e.stopPropagation();
  },{passive:true});

  handle.addEventListener('touchmove',e=>{
    e.preventDefault();
    const touch=e.touches[0];
    const list=g('tab-order-list');
    if(!list)return;
    // Highlight target
    list.querySelectorAll(':scope > div').forEach(r=>r.style.outline='');
    const target=_tabTouchTarget(touch.clientX,touch.clientY);
    if(target&&target!==_tabDragSrc) target.style.outline='2px solid var(--accent3)';
  },{passive:false});

  handle.addEventListener('touchend',e=>{
    row.style.opacity='';
    const list=g('tab-order-list');
    if(!list){_tabDragSrc=null;return;}
    list.querySelectorAll(':scope > div').forEach(r=>r.style.outline='');
    const touch=e.changedTouches[0];
    const target=_tabTouchTarget(touch.clientX,touch.clientY);
    if(target&&target!==_tabDragSrc){
      const items=[...list.children];
      const si=items.indexOf(_tabDragSrc),ti=items.indexOf(target);
      if(si<ti) list.insertBefore(_tabDragSrc,target.nextSibling);
      else list.insertBefore(_tabDragSrc,target);
      applyTabOrderFromList();
    }
    _tabDragSrc=null;
  });
}

function _tabTouchTarget(x,y){
  const list=g('tab-order-list'); if(!list)return null;
  for(const row of list.querySelectorAll(':scope > div')){
    const r=row.getBoundingClientRect();
    if(x>=r.left&&x<=r.right&&y>=r.top&&y<=r.bottom) return row;
  }
  return null;
}

function applyTabOrderFromList(){
  const el=g('tab-order-list'); if(!el)return;
  const newOrder=[...el.children].map(r=>r.dataset.tabid);
  saveTabOrder(newOrder);
  const nav=document.querySelector('nav');
  const spacer=nav.querySelector('.nav-spacer');
  newOrder.forEach(id=>{
    const tab=nav.querySelector(`.tab[data-tab="${id}"]`);
    if(tab) nav.insertBefore(tab,spacer);
  });
}

function onTabVisChange(id,cbx){
  const show=cbx.checked;
  setTabVisible(id,show);
  const tab=document.querySelector(`.tab[data-tab="${id}"]`);
  if(tab) tab.style.display=show?'':'none';
  if(!show&&activeTab===id) showTab('log',document.querySelector('.tab[data-tab="log"]'));
  const meta=TAB_SETTINGS_BASE.find(s=>s.id===id);
  showToast(show?(meta?.label+'-Tab eingeblendet'):(meta?.label+'-Tab ausgeblendet'));
}

function toggleTabSetting(tabId){ /* legacy noop - now handled by onTabVisChange */ }
function toggleBPTab(){ onTabVisChange('bp',{checked:g('setting-bp')?.checked??true}); }

// ‚îÄ‚îÄ SHARES ‚îÄ‚îÄ
let _editingShareId=null;
function openNewShare(){
  _editingShareId=null;
  g('share-modal-title').textContent='FREIGABE ERSTELLEN';
  g('share-email-field').style.display='';
  g('share-email-display').style.display='none';
  g('share-delete-btn').style.display='none';
  g('share-email').value='';
  ['log','weight','bp','sleep','mood'].forEach(c=>g('sc-'+c).checked=false);
  g('modal-share').classList.add('open');
}
function openEditShare(id){
  const sh=shares.find(s=>s.id===id); if(!sh)return;
  _editingShareId=id;
  g('share-modal-title').textContent='FREIGABE BEARBEITEN';
  g('share-email-field').style.display='none';
  g('share-email-display').style.display='block';
  g('share-email-display').textContent='‚úâÔ∏è '+sh.shared_with_email;
  g('share-delete-btn').style.display='block';
  ['log','weight','bp','sleep','mood'].forEach(c=>g('sc-'+c).checked=(sh.categories||[]).includes(c));
  g('modal-share').classList.add('open');
}
async function deleteCurrentShare(){
  if(!_editingShareId||!confirm('Freigabe komplett entfernen?'))return;
  await sb.from('shares').delete().eq('id',_editingShareId);
  await loadAllData(); closeModal('modal-share'); renderShares(); showToast('Freigabe entfernt.');
}
async function saveShare(){
  const cats=['log','weight','bp','sleep','mood'].filter(c=>g('sc-'+c).checked);
  if(!cats.length){ showToast('Mindestens eine Kategorie w√§hlen.',true); return; }
  setSyncState('syncing');
  let error;
  if(_editingShareId){
    ({error}=await sb.from('shares').update({categories:cats}).eq('id',_editingShareId));
  } else {
    const email=g('share-email').value.trim();
    if(!email){ showToast('Bitte E-Mail eingeben.',true); return; }
    ({error}=await sb.from('shares').upsert({owner_id:currentUser.id,shared_with_email:email,categories:cats},{onConflict:'owner_id,shared_with_email'}));
  }
  if(error){ showToast('Fehler: '+error.message,true); setSyncState('error'); return; }
  await loadAllData(); closeModal('modal-share'); renderShares(); showToast('Freigabe gespeichert!');
}
async function deleteShare(id){ if(!confirm('Freigabe entfernen?'))return; await sb.from('shares').delete().eq('id',id); await loadAllData(); renderShares(); showToast('Freigabe entfernt.'); }
function renderShares(){
  const el=g('shares-list');
  if(!shares.length){ el.innerHTML='<p style="color:var(--muted);font-size:13px;">Noch keine Freigaben.</p>'; return; }
  const cl={log:'üìã Log',weight:'‚öñÔ∏è Gewicht',bp:'‚ù§Ô∏è Blutdruck',sleep:'üò¥ Schlaf',mood:'üòä Stimmung'};
  el.innerHTML=shares.map(sh=>`<div class="share-card">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
      <div class="share-email">${sh.shared_with_email}</div>
      <button class="btn btn-ghost btn-xs" onclick="openEditShare('${sh.id}')">‚úèÔ∏è Bearbeiten</button>
    </div>
    <div class="share-cats">${(sh.categories||[]).map(c=>`<span class="share-cat">${cl[c]||c}</span>`).join('')}</div>
  </div>`).join('');
}

// Store shared persons for safe onclick
let sharedPersonsData = [];

// ‚îÄ‚îÄ SHARED VIEW ‚îÄ‚îÄ
async function renderSharedView(){
  const el=g('shared-persons-list');
  el.innerHTML='<div style="color:var(--muted);font-size:13px;padding:16px 0;">Lade...</div>';
  const myEmail=currentProfile?.email||currentUser?.email;
  if(!myEmail){ el.innerHTML='<div style="color:var(--muted);font-size:13px;">Profil nicht geladen.</div>'; return; }
  const{data:received}=await sb.from('shares').select('*').eq('shared_with_email',myEmail);
  if(!received||!received.length){
    el.innerHTML='<div class="empty"><div class="empty-icon">&#x1F465;</div><div class="empty-text">Keine geteilten Daten.</div></div>';
    return;
  }
  const ownerIds=received.map(s=>s.owner_id);
  let ownerProfs=[];
  try{ const{data:p}=await sb.from('profiles').select('id,name,email').in('id',ownerIds); ownerProfs=p||[]; }
  catch(e){ console.warn('profiles RLS:',e); }
  sharedPersonsData=received.map((sh,i)=>{
    const prof=ownerProfs.find(p=>p.id===sh.owner_id);
    const name=prof?.name||(prof?.email?prof.email.split('@')[0]:null)||'?';
    return{index:i,share:sh,name,ownerId:sh.owner_id,categories:sh.categories||[]};
  });
  const cl={log:'Log',weight:'Gewicht',bp:'Blutdruck'};
  el.innerHTML=sharedPersonsData.map((item,i)=>{
    const cats=item.categories.map(c=>'<span class="share-cat">'+( cl[c]||c)+'</span>').join('');
    return '<div class="shared-person-card" onclick="openSharedPerson('+i+')">'+'<div style="display:flex;align-items:center;gap:12px;">'
      +'<div class="user-avatar" style="width:40px;height:40px;font-size:18px;">'+nameInitial(item.name)+'</div>'
      +'<div><div class="shared-person-name">'+item.name+'</div>'
      +'<div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;">'+cats+'</div>'
      +'</div></div></div>';
  }).join('');
}

async function openSharedPerson(idx){
  const item=sharedPersonsData[idx];
  if(!item){showToast('Fehler',true);return;}
  const{share,name}=item;
  const ownerId=share.owner_id;
  const categories=share.categories||[];

  // Switch to detail screen
  g('shared-list-screen').style.display='none';
  g('shared-detail-screen').style.display='block';
  g('shared-detail-avatar').textContent=nameInitial(name);
  g('shared-detail-name').textContent=name.toUpperCase();
  g('shared-detail-content').innerHTML='<div style="text-align:center;padding:32px;color:var(--muted);"><div class="spinner" style="margin:0 auto 12px;"></div>Lade...</div>';

  // Build sub-tabs
  const tabDefs=[];
  if(categories.includes('log')) tabDefs.push({id:'log',label:'üìã Training'});
  if(categories.includes('weight')) tabDefs.push({id:'weight',label:'‚öñÔ∏è Gewicht'});
  if(categories.includes('bp')) tabDefs.push({id:'bp',label:'‚ù§Ô∏è Blutdruck'});
  if(categories.includes('sleep')) tabDefs.push({id:'sleep',label:'üò¥ Schlaf'});
  if(categories.includes('mood')) tabDefs.push({id:'mood',label:'üòä Stimmung'});

  const tabsEl=g('shared-subtabs');
  tabsEl.innerHTML=tabDefs.map((t,i)=>
    `<button onclick="switchSharedTab('${t.id}',this)" class="btn btn-ghost btn-sm" style="flex:1;border-radius:7px;${i===0?'background:var(--card);color:var(--accent);':''}">${t.label}</button>`
  ).join('');

  // Load all data in parallel
  const loads=[
    categories.includes('log')?sb.from('sessions').select('*').eq('user_id',ownerId).order('date',{ascending:false}):Promise.resolve({data:[]}),
    categories.includes('weight')?sb.from('weight_entries').select('*').eq('user_id',ownerId).order('date',{ascending:false}):Promise.resolve({data:[]}),
    categories.includes('bp')?sb.from('bp_entries').select('*').eq('user_id',ownerId).order('date',{ascending:false}):Promise.resolve({data:[]}),
    categories.includes('sleep')?sb.from('sleep_entries').select('*').eq('user_id',ownerId).order('date',{ascending:false}):Promise.resolve({data:[]}),
    categories.includes('mood')?sb.from('mood_entries').select('*').eq('user_id',ownerId).order('date',{ascending:false}):Promise.resolve({data:[]})
  ];
  const[sR,wR,bR,slR,mdR]=await Promise.all(loads);
  window._sharedData={sessions:sR.data||[],weight:wR.data||[],bp:bR.data||[],sleep:slR.data||[],mood:mdR.data||[]};
  window._sharedCharts={};

  if(tabDefs.length) switchSharedTab(tabDefs[0].id, tabsEl.firstChild);
}

function closeSharedDetail(){
  if(window._sharedCharts){Object.values(window._sharedCharts).forEach(c=>{try{c.destroy();}catch(e){}});window._sharedCharts={};}
  g('shared-list-screen').style.display='block';
  g('shared-detail-screen').style.display='none';
  window._sharedData=null;
}

function switchSharedTab(tabId, btn){
  g('shared-subtabs').querySelectorAll('button').forEach(b=>{b.style.background='transparent';b.style.color='var(--muted)';});
  if(btn){btn.style.background='var(--card)';btn.style.color='var(--accent)';}
  const d=window._sharedData||{};
  const el=g('shared-detail-content');
  // Destroy any shared chart
  if(window._sharedCharts){Object.values(window._sharedCharts).forEach(c=>{try{c.destroy();}catch(e){}});window._sharedCharts={};}

  if(tabId==='log'){
    if(!d.sessions||!d.sessions.length){el.innerHTML='<div class="empty"><div class="empty-text">Noch keine Einheiten.</div></div>';return;}
    el.innerHTML=d.sessions.map(s=>{
      const ec=(s.exercises||[]).length,sc=(s.exercises||[]).reduce((a,e)=>a+(e.sets||[]).length,0);
      const exDetail=(s.exercises||[]).map(ex=>{
        const setsStr=(ex.sets||[]).map((st,i)=>`<span style="display:inline-block;background:var(--surface);border-radius:5px;padding:2px 7px;margin:2px;font-size:11px;">${i+1}: ${st.kg||'‚Äî'}kg √ó ${st.reps||'‚Äî'}</span>`).join('');
        return`<div style="margin-top:8px;"><div style="font-size:12px;font-weight:600;color:var(--accent3);margin-bottom:4px;">${ex.name}</div><div>${setsStr}</div>${ex.remark?`<div style="font-size:11px;color:var(--muted);margin-top:3px;">${ex.remark}</div>`:''}</div>`;
      }).join('');
      return`<div class="session-card" style="cursor:default;"><div class="session-date">${fmtD(s.date,{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</div><div class="session-name">${s.name||'Training'}</div><div class="session-meta"><span>üí™ ${ec} √úbungen</span><span>üìã ${sc} Sets</span></div><div style="margin-top:8px;border-top:1px solid var(--border);padding-top:8px;">${exDetail}</div></div>`;
    }).join('');
    return;
  }

  if(tabId==='weight'){
    if(!d.weight||!d.weight.length){el.innerHTML='<div class="empty"><div class="empty-text">Noch keine Messungen.</div></div>';return;}
    const sorted=[...d.weight].sort((a,b)=>a.date.localeCompare(b.date));
    const wVals=sorted.map(e=>e.weight?parseFloat(e.weight):null);
    const maW=calcMA(wVals,7);
    el.innerHTML=`
      <div class="chart-wrap"><div class="chart-title" style="margin-bottom:10px;">VERLAUF</div>
        <canvas id="shared-w-chart" height="200"></canvas></div>
      <div class="chart-wrap" style="overflow-x:auto;"><div class="chart-title">ALLE MESSUNGEN</div>
        <div>${d.weight.map(e=>{const vals=[];if(e.weight)vals.push(`<b>${e.weight} kg</b>`);if(e.bauch)vals.push(`Bauch: <b>${e.bauch} cm</b>`);if(e.hueft)vals.push(`H√ºfte: <b>${e.hueft} cm</b>`);if(e.kcal)vals.push(`${e.kcal} kcal`);return`<div class="data-entry-row" style="cursor:default;"><div><div class="data-entry-date">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</div><div class="data-entry-vals">${vals.map(v=>`<span>${v}</span>`).join('')}</div></div></div>`;}).join('')}</div>
      </div>`;
    setTimeout(()=>{
      const cv=g('shared-w-chart');if(!cv)return;
      window._sharedCharts.w=new Chart(cv,{type:'line',data:{labels:sorted.map(e=>fmtShort(e.date)),datasets:[
        {label:'Gewicht',data:wVals,borderColor:'#47c8ff',backgroundColor:'rgba(71,200,255,.08)',pointRadius:sorted.length>60?1:3,tension:.3,fill:true,order:2},
        {label:'√ò 7 Tage',data:maW,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true}
      ]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10},grid:{color:'#2a2a38'}},y:{ticks:{color:'#6b6b80'},grid:{color:'#2a2a38'}}}}});
    },50);
    return;
  }

  if(tabId==='bp'){
    if(!d.bp||!d.bp.length){el.innerHTML='<div class="empty"><div class="empty-text">Noch keine Messungen.</div></div>';return;}
    const sorted=[...d.bp].sort((a,b)=>a.date.localeCompare(b.date));
    const sysV=sorted.map(e=>e.sys), diaV=sorted.map(e=>e.dia);
    const maSys=calcMA(sysV,7), maDia=calcMA(diaV,7);
    el.innerHTML=`
      <div class="chart-wrap"><div class="chart-title" style="margin-bottom:10px;">VERLAUF</div>
        <canvas id="shared-bp-chart" height="220"></canvas></div>
      <div class="chart-wrap" style="overflow-x:auto;"><div class="chart-title">ALLE MESSUNGEN</div>
        <table class="bp-table"><thead><tr><th>Datum</th><th>Zeit</th><th>SYS</th><th>DIA</th><th>Notiz</th></tr></thead>
        <tbody>${sorted.slice().reverse().map(e=>`<tr><td>${fmtD(e.date,{day:'2-digit',month:'short'})}</td><td style="color:var(--muted);">${e.time||'‚Äî'}</td><td class="bp-sys">${e.sys}</td><td class="bp-dia">${e.dia}</td><td style="color:var(--muted);font-size:12px;">${e.note||'‚Äî'}</td></tr>`).join('')}</tbody></table>
      </div>`;
    setTimeout(()=>{
      const cv=g('shared-bp-chart');if(!cv)return;
      window._sharedCharts.bp=new Chart(cv,{type:'line',data:{labels:sorted.map(e=>fmtShort(e.date)),datasets:[
        {label:'Systolisch',data:sysV,borderColor:'#ff4757',pointRadius:sorted.length>60?1:3,tension:.3,fill:false,order:2},
        {label:'Diastolisch',data:diaV,borderColor:'#47c8ff',pointRadius:sorted.length>60?1:3,tension:.3,fill:false,order:2},
        {label:'√ò Sys',data:maSys,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true},
        {label:'√ò Dia',data:maDia,borderColor:'#e8ff47',borderWidth:1,borderDash:[3,3],pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true}
      ]},options:{plugins:{legend:{display:true,labels:{color:'#6b6b80',font:{size:10},boxWidth:10}}},
        scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10},grid:{color:'#2a2a38'}},
                y:{ticks:{color:'#6b6b80'},grid:{color:'#2a2a38'},
                   min:(ctx)=>{const v=ctx.chart.data.datasets.flatMap(d=>d.data).filter(x=>x!=null);return v.length?Math.floor(Math.min(...v)/5)*5-5:60;},
                   max:(ctx)=>{const v=ctx.chart.data.datasets.flatMap(d=>d.data).filter(x=>x!=null);return v.length?Math.ceil(Math.max(...v)/5)*5+5:200;}}}}});
    },50);
    return;
  }

  if(tabId==='sleep'){
    if(!d.sleep||!d.sleep.length){el.innerHTML='<div class="empty"><div class="empty-text">Noch keine Eintr√§ge.</div></div>';return;}
    const sorted=[...d.sleep].sort((a,b)=>a.date.localeCompare(b.date));
    const durV=sorted.map(e=>e.duration_mins?+(e.duration_mins/60).toFixed(2):null);
    const maD=calcMA(durV,7);
    el.innerHTML=`
      <div class="chart-wrap"><div class="chart-title" style="margin-bottom:10px;">VERLAUF</div>
        <canvas id="shared-sl-chart" height="200"></canvas></div>
      <div class="chart-wrap"><div class="chart-title">ALLE EINTR√ÑGE</div>
        <div>${sorted.slice().reverse().map(e=>{const h=Math.floor((e.duration_mins||0)/60),m=(e.duration_mins||0)%60;const rk=e.rating!=null?(e.rating>1?1:e.rating<-1?-1:e.rating):null;const r=rk!=null?SLEEP_RATINGS[rk]:null;return`<div class="data-entry-row" style="cursor:default;"><div><div class="data-entry-date">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short'})} ¬∑ ${e.sleep_from||'?'}‚Äì${e.sleep_to||'?'}</div><div class="data-entry-vals"><span>üò¥ <b>${h}h ${m}m</b></span>${r?`<span style="color:${r.color};">${r.emoji} ${r.label}</span>`:''}</div></div></div>`;}).join('')}</div>
      </div>`;
    setTimeout(()=>{
      const cv=g('shared-sl-chart');if(!cv)return;
      window._sharedCharts.sl=new Chart(cv,{type:'line',data:{labels:sorted.map(e=>fmtShort(e.date)),datasets:[
        {label:'Schlafdauer (h)',data:durV,borderColor:'#c847ff',backgroundColor:'rgba(200,71,255,.07)',pointRadius:3,tension:.3,fill:true,order:2},
        {label:'√ò 7 Tage',data:maD,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true}
      ]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10},grid:{color:'#2a2a38'}},y:{ticks:{color:'#6b6b80',callback:v=>v+'h'},grid:{color:'#2a2a38'},min:0}}}});
    },50);
    return;
  }

  if(tabId==='mood'){
    if(!d.mood||!d.mood.length){el.innerHTML='<div class="empty"><div class="empty-text">Noch keine Eintr√§ge.</div></div>';return;}
    const sorted=[...d.mood].sort((a,b)=>a.date.localeCompare(b.date));
    const mVals=sorted.map(e=>e.rating);
    const maM=calcMA(mVals,7);
    el.innerHTML=`
      <div class="chart-wrap"><div class="chart-title" style="margin-bottom:10px;">VERLAUF</div>
        <canvas id="shared-md-chart" height="200"></canvas></div>
      <div class="chart-wrap"><div class="chart-title">ALLE EINTR√ÑGE</div>
        <div>${sorted.slice().reverse().map(e=>{const r=MOOD_RATINGS[e.rating]||MOOD_RATINGS[0];return`<div class="data-entry-row" style="cursor:default;"><div><div class="data-entry-date">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short'})}${e.time?' ¬∑ '+e.time:''}</div><div class="data-entry-vals"><span style="color:${r.color};">${r.emoji} <b>${r.label}</b></span>${e.note?`<span style="font-size:11px;color:var(--muted);">${e.note}</span>`:''}</div></div></div>`;}).join('')}</div>
      </div>`;
    setTimeout(()=>{
      const cv=g('shared-md-chart');if(!cv)return;
      window._sharedCharts.md=new Chart(cv,{type:'line',data:{labels:sorted.map(e=>fmtShort(e.date)),datasets:[
        {label:'Stimmung',data:mVals,borderColor:'#ff9f47',pointBackgroundColor:sorted.map(e=>(MOOD_RATINGS[e.rating]||MOOD_RATINGS[0]).color),pointRadius:5,tension:.3,fill:false,order:2},
        {label:'√ò 7 Tage',data:maM,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true}
      ]},options:{plugins:{legend:{display:false}},
        scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10},grid:{color:'#2a2a38'}},
                y:{ticks:{color:'#6b6b80',callback:v=>{const r=MOOD_RATINGS[v];return r?r.emoji:'';},stepSize:1},grid:{color:'#2a2a38'},min:-1,max:1}}}});
    },50);
    return;
  }
}

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
function showTab(tab,el){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  if(el) el.classList.add('active');
  else { const t=document.querySelector(`.tab[data-tab="${tab}"]`); if(t) t.classList.add('active'); }
  g('view-'+tab).classList.add('active');
  activeTab=tab; updateFab();
  if(tab==='log'){renderLog();populateLogPlanSelect();}
  if(tab==='plans') renderPlans();
  if(tab==='stats') renderStats();
  if(tab==='weight') renderWeight();
  if(tab==='bp') renderBP();
  if(tab==='sleep') renderSleep();
  if(tab==='mood') renderMood();
  if(tab==='habits') renderHabits();
  if(tab==='macros'){prefillMacrosFromData();calcMacros();}
  if(tab==='shared'){ 
    // Reset to list view when switching to shared tab
    if(g('shared-list-screen')) g('shared-list-screen').style.display='block';
    if(g('shared-detail-screen')) g('shared-detail-screen').style.display='none';
    renderSharedView();
  }
  if(tab==='profile'){renderShares();loadSettings();}
}
function updateFab(){
  const f=g('main-fab');
  const cfg={log:'fab-yellow',plans:'fab-blue',weight:'fab-teal',bp:'fab-red',sleep:'fab-purple',mood:'fab-orange',habits:'fab-green'};
  if(!cfg[activeTab]){f.style.display='none';return;}
  f.style.display='flex'; f.className='fab '+cfg[activeTab]; f.textContent='Ôºã';
}
function fabAction(){
  if(activeTab==='log') openBlankSession();
  else if(activeTab==='plans') openNewPlan();
  else if(activeTab==='weight') openWeightModal();
  else if(activeTab==='bp') openBPModal();
  else if(activeTab==='sleep') openSleepModal();
  else if(activeTab==='mood') openMoodModal();
  else if(activeTab==='habits') openHabitModal();
}

// ‚îÄ‚îÄ TIMER ‚îÄ‚îÄ
function timerToggle(){
  if(timerRunning){ clearInterval(timerInterval); timerRunning=false; setTBtn('‚ñ∂'); g('timer-display').classList.remove('running','countdown'); g('timer-mini').classList.remove('running','countdown'); }
  else{ timerRunning=true; timerStart=Date.now()-timerSecs*1000; setTBtn('‚è∏'); const cls=timerTarget!==null?'countdown':'running'; g('timer-display').classList.add(cls); g('timer-mini').classList.add(cls); timerInterval=setInterval(timerTick,200); }
}
function timerTick(){
  const el=Math.floor((Date.now()-timerStart)/1000);
  if(timerTarget!==null){ const rem=timerTarget-el; if(rem<=0){ timerSecs=0;timerTarget=null;updateTDisp(0);clearInterval(timerInterval);timerRunning=false;setTBtn('‚ñ∂');g('timer-display').classList.remove('running','countdown');g('timer-mini').classList.remove('running','countdown');document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('qactive'));if(navigator.vibrate)navigator.vibrate([300,100,300]);showToast('‚è∞ Pause beendet!');return;} timerSecs=rem;updateTDisp(rem);}
  else{timerSecs=el;updateTDisp(el);}
}
function timerReset(){ clearInterval(timerInterval);timerRunning=false;timerSecs=0;timerTarget=null;timerStart=null;updateTDisp(0);setTBtn('‚ñ∂');g('timer-display').classList.remove('running','countdown');g('timer-mini').classList.remove('running','countdown');document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('qactive')); }
function timerCountdown(s,btn){ timerReset();timerTarget=s;timerSecs=s;updateTDisp(s);document.querySelectorAll('.qbtn').forEach(b=>b.classList.remove('qactive'));if(btn)btn.classList.add('qactive');timerStart=Date.now();timerRunning=true;setTBtn('‚è∏');g('timer-display').classList.add('countdown');g('timer-mini').classList.add('countdown');timerInterval=setInterval(timerTick,200); }
function updateTDisp(s){ const m=Math.floor(Math.abs(s)/60).toString().padStart(2,'0'),sec=(Math.abs(s)%60).toString().padStart(2,'0'),str=m+':'+sec; g('timer-display').textContent=str; g('timer-mini').textContent=str; }
function setTBtn(t){ g('timer-btn').textContent=t; g('timer-mini-btn').textContent=t; }
function toggleTimerMin(){ timerMinimized=!timerMinimized; const sec=g('timer-section'),body=g('timer-body'),mr=g('timer-mini-row'),btn=sec.querySelector('.btn-xs'); if(timerMinimized){sec.classList.add('minimized');body.style.display='none';mr.style.display='flex';btn.textContent='‚ñº Max';}else{sec.classList.remove('minimized');body.style.display='block';mr.style.display='none';btn.textContent='‚ñ≤ Min';} }

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ
function populateLogPlanSelect(){ const sel=g('log-plan-sel'); sel.innerHTML='<option value="">‚Äî Plan w√§hlen ‚Äî</option>'; plans.forEach(p=>sel.innerHTML+=`<option value="${p.id}">${p.name}</option>`); }
function startSelectedPlan(){ const pid=g('log-plan-sel').value; if(!pid){showToast('Bitte Plan ausw√§hlen.',true);return;} const plan=plans.find(p=>p.id===pid); if(plan) startWorkout(plan); }
function openBlankSession(){ exCounter=0;setCounters={}; g('s-date').value=today(); g('s-name').value=''; g('ex-container').innerHTML=''; addExercise(); g('modal-session').classList.add('open'); }

// ‚îÄ‚îÄ ACTIVE WORKOUT ‚îÄ‚îÄ
function startWorkout(plan){
  awSetCounters={};
  const exercises=(plan.exercises||[]).map((ex,i)=>({id:i,name:ex.name,defaultSets:ex.defaultSets||3,defaultReps:ex.defaultReps||0}));
  
  // Find last session that used this plan (same name)
  const lastSession = sessions.find(s => s.name === plan.name);
  const lastExMap = {};
  if(lastSession){
    (lastSession.exercises||[]).forEach(ex=>{ lastExMap[ex.name.toLowerCase()]=ex; });
  }
  
  const wrap=g('active-workout-wrap'); wrap.style.display='block';
  let exHtml='';
  exercises.forEach((ex,ei)=>{
    const lastEx = lastExMap[ex.name.toLowerCase()];
    const lastSets = lastEx?.sets||[];
    
    // Build "last session" hint
    let lastHint='';
    if(lastSets.length){
      const parts = lastSets.map((s,i)=>`Set ${i+1}: ${s.kg||'‚Äî'}kg √ó ${s.reps||'‚Äî'}`).join(' ¬∑ ');
      lastHint=`<div style="font-size:11px;color:var(--accent3);background:rgba(71,200,255,.08);border:1px solid rgba(71,200,255,.2);border-radius:8px;padding:6px 10px;margin-bottom:8px;">
        <span style="font-weight:700;letter-spacing:.5px;">LETZTES MAL:</span> ${parts}
      </div>`;
    }
    
    let setsHtml='';
    for(let si=0;si<ex.defaultSets;si++){
      // Pre-fill with last session values as placeholders
      const lastKg = lastSets[si]?.kg||'';
      const lastRp = lastSets[si]?.reps||(ex.defaultReps||'');
      setsHtml+=`<div class="set-row" id="aws-${ei}-${si}">
        <div class="set-num">${si+1}</div>
        <input type="number" placeholder="${lastKg||'‚Äî'}" id="aw-kg-${ei}-${si}" min="0" step="0.5">
        <input type="number" placeholder="${lastRp||'‚Äî'}" id="aw-rp-${ei}-${si}" value="">
        <input type="text" placeholder="‚Äî" id="aw-pa-${ei}-${si}" style="font-size:12px;">
        <button class="del-set" onclick="document.getElementById('aws-${ei}-${si}').remove()">‚úï</button>
      </div>`;
    }
    exHtml+=`<div class="exercise-block" id="aw-ex-${ei}">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--accent3);margin-bottom:8px;">${ex.name}</div>
      ${lastHint}
      <div class="sets-header"><div>#</div><div>KG</div><div>REPS</div><div>PAUSE</div><div></div></div>
      <div id="aw-sets-${ei}">${setsHtml}</div>
      <button class="btn btn-ghost btn-xs" style="width:100%;margin-top:6px;" onclick="addAWSet(${ei},${ex.defaultSets},${ex.defaultReps||0})">+ Set</button>
      <div class="field" style="margin-top:10px;"><label>Bemerkung</label><textarea id="aw-rmk-${ei}" placeholder="Optional‚Ä¶" style="min-height:44px;resize:vertical;font-size:13px;"></textarea></div>
    </div>`;
  });
  wrap.innerHTML=`<div class="active-workout">
    <div class="aw-header" onclick="toggleAWMin()">
      <div><div class="aw-title">üèãÔ∏è ${plan.name}</div>
        <div style="font-size:12px;color:var(--muted);">Aktives Training ¬∑ tippen zum Auf/Zuklappen</div></div>
      <div style="font-size:20px;color:var(--accent3);" id="aw-arrow">‚ñº</div>
    </div>
    <div class="aw-body open" id="aw-body">
      <div style="padding:12px 16px 0;">
        <div class="field" style="margin-bottom:10px;"><label>Name</label><input type="text" id="aw-name" value="${plan.name}"></div>
      </div>
      ${exHtml}
    </div>
    <div class="aw-actions">
      <button class="btn btn-accent btn-sm" id="aw-save-btn" onclick="saveActiveWorkout(${JSON.stringify(exercises).replace(/"/g,'&quot;')})">üíæ Speichern</button>
      <button class="btn btn-danger btn-sm" onclick="discardWorkout()">‚úï Verwerfen</button>
    </div>
  </div>`;
  wrap.scrollIntoView({behavior:'smooth'});
}
function addAWSet(ei,startCount,defReps){
  if(!awSetCounters[ei]) awSetCounters[ei]=startCount||3;
  const si=awSetCounters[ei]++;
  const d=document.createElement('div'); d.className='set-row'; d.id=`aws-${ei}-${si}`;
  d.innerHTML=`<div class="set-num">${si+1}</div>
    <input type="number" placeholder="‚Äî" id="aw-kg-${ei}-${si}" min="0" step="0.5">
    <input type="number" placeholder="‚Äî" id="aw-rp-${ei}-${si}" value="${defReps||''}">
    <input type="text" placeholder="‚Äî" id="aw-pa-${ei}-${si}" style="font-size:12px;">
    <button class="del-set" onclick="document.getElementById('aws-${ei}-${si}').remove()">‚úï</button>`;
  g('aw-sets-'+ei)?.appendChild(d);
}
function toggleAWMin(){ const b=g('aw-body'),a=g('aw-arrow'); const open=b.classList.toggle('open'); a.textContent=open?'‚ñº':'‚ñ∂'; }
async function saveActiveWorkout(exercises){
  const btn=g('aw-save-btn'); if(btn){btn.disabled=true;btn.textContent='Speichert‚Ä¶';}
  const name=g('aw-name')?.value.trim()||'Training';
  const exList=[];
  exercises.forEach((ex,ei)=>{
    const sets=[];
    document.querySelectorAll(`#aw-sets-${ei} .set-row`).forEach(row=>{
      const parts=row.id.split('-'); const si=parts[parts.length-1];
      sets.push({kg:g(`aw-kg-${ei}-${si}`)?.value||'',reps:g(`aw-rp-${ei}-${si}`)?.value||'',pause:g(`aw-pa-${ei}-${si}`)?.value||''});
    });
    exList.push({name:ex.name,sets,remark:g(`aw-rmk-${ei}`)?.value||''});
  });
  setSyncState('syncing');
  const{error}=await sb.from('sessions').insert({user_id:currentUser.id,date:today(),name,exercises:exList});
  if(error){showToast('Fehler: '+error.message,true);setSyncState('error');if(btn){btn.disabled=false;btn.textContent='üíæ Speichern';}return;}
  await loadAllData();
  g('active-workout-wrap').style.display='none'; g('active-workout-wrap').innerHTML=''; awSetCounters={};
  renderLog();
  showToast('Einheit gespeichert!');
}
function discardWorkout(){ if(!confirm('Training verwerfen?'))return; g('active-workout-wrap').style.display='none'; g('active-workout-wrap').innerHTML=''; awSetCounters={}; }

// ‚îÄ‚îÄ LOG LIST ‚îÄ‚îÄ
function renderLog(){
  const el=g('log-list');
  if(!sessions.length){el.innerHTML=`<div class="empty"><div class="empty-icon">üèãÔ∏è</div><div class="empty-text">Noch keine Einheiten.</div></div>`;return;}
  el.innerHTML=sessions.map(s=>{
    const ec=(s.exercises||[]).length,sc=(s.exercises||[]).reduce((a,e)=>a+(e.sets||[]).length,0);
    return`<div class="session-card" onclick="openDetail('${s.id}')">
      <div class="session-date">${fmtD(s.date,{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</div>
      <div class="session-name">${s.name||'Training'}</div>
      <div class="session-meta"><span>üí™ ${ec} √úbung${ec!==1?'en':''}</span><span>üìã ${sc} Sets</span></div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ SESSION FORM ‚îÄ‚îÄ
function addExercise(name='',defSets=3){
  const id=++exCounter;
  const d=document.createElement('div'); d.className='exercise-block'; d.id='ex-'+id;
  d.innerHTML=`<div class="exercise-name-row">
    <input type="text" placeholder="√úbungsname" id="ex-n-${id}" value="${name}">
    <button class="btn btn-danger btn-sm" onclick="document.getElementById('ex-${id}').remove()">‚úï</button>
  </div>
  <div class="sets-header"><div>#</div><div>KG</div><div>REPS</div><div>PAUSE</div><div>BEM.</div><div></div></div>
  <div id="sets-${id}"></div>
  <button class="btn btn-ghost btn-xs" style="width:100%;margin-top:6px;" onclick="addSet(${id})">+ Set</button>
  <div class="field" style="margin-top:10px;"><label>Bemerkung</label><textarea id="ex-r-${id}" placeholder="Optional‚Ä¶" style="min-height:44px;resize:vertical;"></textarea></div>`;
  g('ex-container').appendChild(d);
  for(let i=0;i<(defSets||1);i++) addSet(id);
}
function addSet(exId){
  if(!setCounters[exId]) setCounters[exId]=0;
  const sn=++setCounters[exId];
  const d=document.createElement('div'); d.className='set-row'; d.id=`sr-${exId}-${sn}`;
  d.innerHTML=`<div class="set-num">${sn}</div>
    <input type="number" placeholder="‚Äî" id="kg-${exId}-${sn}" min="0" step="0.5">
    <input type="number" placeholder="‚Äî" id="rp-${exId}-${sn}" min="0">
    <input type="text" placeholder="‚Äî" id="pa-${exId}-${sn}" style="font-size:12px;">
    <input type="text" placeholder="‚Äî" id="bm-${exId}-${sn}" style="font-size:12px;">
    <button class="del-set" onclick="document.getElementById('sr-${exId}-${sn}').remove()">‚úï</button>`;
  g('sets-'+exId).appendChild(d);
}
async function saveSession(){
  const date=g('s-date').value,name=g('s-name').value.trim();
  if(!date){alert('Bitte Datum angeben.');return;}
  const exercises=[];
  document.querySelectorAll('#ex-container .exercise-block').forEach(block=>{
    const exId=block.id.replace('ex-','');
    const exName=g('ex-n-'+exId)?.value.trim(); if(!exName)return;
    const remark=g('ex-r-'+exId)?.value.trim()||'';
    const sets=[];
    block.querySelectorAll('.set-row').forEach(row=>{
      const sn=row.id.replace(`sr-${exId}-`,'');
      sets.push({kg:g(`kg-${exId}-${sn}`)?.value||'',reps:g(`rp-${exId}-${sn}`)?.value||'',pause:g(`pa-${exId}-${sn}`)?.value||'',remark:g(`bm-${exId}-${sn}`)?.value||''});
    });
    exercises.push({name:exName,sets,remark});
  });
  if(!exercises.length){alert('Mindestens eine √úbung.');return;}
  setSyncState('syncing');
  const{error}=await sb.from('sessions').insert({user_id:currentUser.id,date,name,exercises});
  if(error){showToast('Fehler: '+error.message,true);setSyncState('error');console.error('Session insert error:',error);return;}
  await loadAllData(); closeModal('modal-session'); renderLog(); if(activeTab==='stats')renderStats(); showToast('Einheit gespeichert!');
}

// ‚îÄ‚îÄ DETAIL ‚îÄ‚îÄ
function openDetail(id){
  currentSessionId=id;
  const s=sessions.find(x=>x.id===id); if(!s)return;
  g('d-title').textContent=s.name||'Training';
  g('d-sub').textContent=fmtD(s.date,{weekday:'long',day:'2-digit',month:'long',year:'numeric'});
  g('d-content').innerHTML=(s.exercises||[]).map(ex=>`<div class="detail-exercise">
    <div class="detail-exercise-name">${ex.name}</div>
    <div class="detail-sets">${(ex.sets||[]).map((st,i)=>`<div class="detail-set">
      <div style="font-size:10px;color:var(--muted);">SET ${i+1}</div>
      <div style="font-size:18px;font-weight:700;">${st.kg||'‚Äî'}</div><div style="font-size:10px;color:var(--muted);">kg</div>
      <div style="font-size:12px;margin-top:4px;">${st.reps||'‚Äî'} <span style="font-size:10px;color:var(--muted)">reps</span></div>
      ${st.pause?`<div style="font-size:10px;color:var(--muted);margin-top:2px">‚è± ${st.pause}</div>`:''}
      ${st.remark?`<div style="font-size:10px;color:var(--muted);margin-top:2px">üí¨ ${st.remark}</div>`:''}
    </div>`).join('')}</div>
    ${ex.remark?`<div style="margin-top:8px;font-size:13px;color:var(--muted);background:var(--surface);padding:8px;border-radius:8px;">üí¨ ${ex.remark}</div>`:''}
  </div><div class="divider"></div>`).join('');
  g('modal-detail').classList.add('open');
}
async function deleteCurrentSession(){
  if(!confirm('Einheit wirklich l√∂schen?'))return;
  setSyncState('syncing');
  const{error}=await sb.from('sessions').delete().eq('id',currentSessionId).eq('user_id',currentUser.id);
  if(error){showToast('Fehler: '+error.message,true);return;}
  await loadAllData(); closeModal('modal-detail'); renderLog(); showToast('Einheit gel√∂scht.');
}

// ‚îÄ‚îÄ PLANS ‚îÄ‚îÄ
function renderPlans(){
  const el=g('plans-list');
  if(!plans.length){el.innerHTML=`<div class="empty"><div class="empty-icon">üìå</div><div class="empty-text">Noch keine Pl√§ne.<br>Tippe auf + um einen zu erstellen.</div></div>`;return;}
  const active=plans.filter(p=>!p.archived);
  const archived=plans.filter(p=>p.archived);
  const cardHTML=p=>`<div class="plan-card${p.archived?' plan-archived':''}">
    <div class="plan-name">${p.name}${p.archived?'<span style="font-size:10px;color:var(--muted);font-weight:400;margin-left:8px;">ARCHIVIERT</span>':''}</div>
    <div class="plan-ex-list">${(p.exercises||[]).map((e,i)=>`${i+1}. ${e.name} <span style="color:var(--muted)">(${e.defaultSets} Sets √ó ${e.defaultReps||'?'} Wdh.)</span>`).join(' ¬∑ ')}</div>
    <div class="plan-actions">
      ${!p.archived?`<button class="btn btn-blue btn-sm" onclick="startPlanFromPlans('${p.id}')">‚ñ∂ Starten</button>`:''}
      <button class="btn btn-ghost btn-sm" onclick="editPlan('${p.id}')">‚úèÔ∏è</button>
      <button class="btn btn-ghost btn-sm" onclick="toggleArchivePlan('${p.id}',${!p.archived})" title="${p.archived?'Reaktivieren':'Archivieren'}">${p.archived?'‚Ü© Reaktivieren':'üì¶ Archiv'}</button>
      <button class="btn btn-danger btn-sm" onclick="deletePlan('${p.id}')">üóë</button>
    </div>
  </div>`;
  let html=active.map(cardHTML).join('');
  if(archived.length){
    html+=`<div class="year-group" id="plan-archive-group">
      <div class="year-header" onclick="toggleYearGroup('plan-archive-group')" style="margin-top:12px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-family:'Bebas Neue',sans-serif;font-size:16px;letter-spacing:2px;color:var(--muted);">üì¶ ARCHIV</span>
          <span style="font-size:12px;color:var(--muted);">${archived.length} Pl√§ne</span>
        </div>
        <span id="yarr-plan-archive-group" style="color:var(--muted);font-size:12px;">‚ñ∂</span>
      </div>
      <div class="year-body" id="yb-plan-archive-group">${archived.map(cardHTML).join('')}</div>
    </div>`;
  }
  el.innerHTML=html;
}
function openNewPlan(){ editingPlanId=null;planExCounter=0; g('p-name').value=''; g('p-ex-container').innerHTML=''; g('plan-modal-ttl').textContent='NEUER PLAN'; addPlanEx(); g('modal-plan').classList.add('open'); }
function editPlan(id){ const plan=plans.find(p=>p.id===id); if(!plan)return; editingPlanId=id;planExCounter=0; g('p-name').value=plan.name; g('p-ex-container').innerHTML=''; g('plan-modal-ttl').textContent='PLAN BEARBEITEN'; (plan.exercises||[]).forEach(ex=>addPlanEx(ex.name,ex.defaultSets,ex.defaultReps)); g('modal-plan').classList.add('open'); }
function addPlanEx(name='',sets=3,reps=10){
  const id=++planExCounter;
  const d=document.createElement('div'); d.className='plan-ex-item'; d.id='pex-'+id;
  d.draggable=true;
  d.innerHTML=`
    <div style="display:grid;grid-template-columns:20px 20px 1fr 62px 62px 28px;gap:6px;align-items:end;width:100%;">
      <span class="drag-handle" style="font-size:16px;color:var(--muted);padding-bottom:9px;cursor:grab;touch-action:none;" title="Ziehen zum Sortieren">‚†ø</span>
      <span class="pex-num" style="font-size:11px;color:var(--muted);padding-bottom:11px;"></span>
      <div>
        <label style="font-size:10px;margin-bottom:3px;">√úbungsname</label>
        <input type="text" placeholder="z.B. Bankdr√ºcken" id="pex-n-${id}" value="${name}">
      </div>
      <div>
        <label style="font-size:10px;margin-bottom:3px;">Sets</label>
        <input type="number" id="pex-s-${id}" value="${sets}" min="1" max="20" style="text-align:center;">
      </div>
      <div>
        <label style="font-size:10px;margin-bottom:3px;">Wdh.</label>
        <input type="number" id="pex-r-${id}" value="${reps}" min="1" max="100" style="text-align:center;">
      </div>
      <button class="del-set" style="margin-bottom:2px;" onclick="document.getElementById('pex-${id}').remove();updatePexNums()">‚úï</button>
    </div>`;
  g('p-ex-container').appendChild(d);
  updatePexNums();
  initPlanDnD(d);
}

function updatePexNums(){
  document.querySelectorAll('#p-ex-container .plan-ex-item').forEach((el,i)=>{
    const num=el.querySelector('.pex-num');
    if(num) num.textContent=(i+1)+'.';
  });
}

let dragSrc=null;
function initPlanDnD(el){
  // ‚îÄ‚îÄ Mouse drag ‚îÄ‚îÄ
  el.addEventListener('dragstart',e=>{dragSrc=el;el.style.opacity='.4';e.dataTransfer.effectAllowed='move';});
  el.addEventListener('dragend',()=>{el.style.opacity='';document.querySelectorAll('.plan-ex-item').forEach(i=>i.classList.remove('drag-over'));updatePexNums();});
  el.addEventListener('dragover',e=>{e.preventDefault();e.dataTransfer.dropEffect='move';if(el!==dragSrc)el.classList.add('drag-over');return false;});
  el.addEventListener('dragleave',()=>el.classList.remove('drag-over'));
  el.addEventListener('drop',e=>{
    e.stopPropagation();e.preventDefault();
    if(dragSrc!==el){
      const con=g('p-ex-container');
      const items=[...con.querySelectorAll('.plan-ex-item')];
      const si=items.indexOf(dragSrc),ti=items.indexOf(el);
      if(si<ti) con.insertBefore(dragSrc,el.nextSibling);
      else con.insertBefore(dragSrc,el);
    }
    el.classList.remove('drag-over');
    return false;
  });

  // ‚îÄ‚îÄ Touch drag ‚îÄ‚îÄ
  const handle=el.querySelector('.drag-handle')||el;
  handle.addEventListener('touchstart',e=>{dragSrc=el;el.style.opacity='.5';e.stopPropagation();},{passive:true});
  handle.addEventListener('touchmove',e=>{
    e.preventDefault();
    const touch=e.touches[0];
    document.querySelectorAll('.plan-ex-item').forEach(i=>i.classList.remove('drag-over'));
    const target=_planTouchTarget(touch.clientX,touch.clientY);
    if(target&&target!==dragSrc) target.classList.add('drag-over');
  },{passive:false});
  handle.addEventListener('touchend',e=>{
    el.style.opacity='';
    document.querySelectorAll('.plan-ex-item').forEach(i=>i.classList.remove('drag-over'));
    const touch=e.changedTouches[0];
    const target=_planTouchTarget(touch.clientX,touch.clientY);
    if(target&&target!==dragSrc){
      const con=g('p-ex-container');
      const items=[...con.querySelectorAll('.plan-ex-item')];
      const si=items.indexOf(dragSrc),ti=items.indexOf(target);
      if(si<ti) con.insertBefore(dragSrc,target.nextSibling);
      else con.insertBefore(dragSrc,target);
      updatePexNums();
    }
    dragSrc=null;
  });
}

function _planTouchTarget(x,y){
  const con=g('p-ex-container'); if(!con)return null;
  for(const item of con.querySelectorAll('.plan-ex-item')){
    const r=item.getBoundingClientRect();
    if(x>=r.left&&x<=r.right&&y>=r.top&&y<=r.bottom) return item;
  }
  return null;
}
async function savePlan(){
  const name=g('p-name').value.trim(); if(!name){alert('Bitte Planname eingeben.');return;}
  const exercises=[];
  document.querySelectorAll('[id^="pex-n-"]').forEach(inp=>{
    const id=inp.id.replace('pex-n-','');
    const n=inp.value.trim();
    const s=parseInt(g('pex-s-'+id)?.value)||3;
    const r=parseInt(g('pex-r-'+id)?.value)||10;
    if(n) exercises.push({name:n,defaultSets:s,defaultReps:r});
  });
  if(!exercises.length){alert('Mindestens eine √úbung.');return;}
  const saveBtn=g('plan-save-btn'); if(saveBtn){saveBtn.disabled=true;saveBtn.textContent='Speichert‚Ä¶';}
  setSyncState('syncing');
  let error;
  if(editingPlanId){
    ({error}=await sb.from('plans').update({name,exercises}).eq('id',editingPlanId).eq('user_id',currentUser.id));
  } else {
    ({error}=await sb.from('plans').insert({user_id:currentUser.id,name,exercises}));
  }
  if(saveBtn){saveBtn.disabled=false;saveBtn.textContent='üíæ Plan speichern';}
  if(error){showToast('Fehler: '+error.message,true);setSyncState('error');return;}
  await loadAllData(); closeModal('modal-plan'); renderPlans(); populateLogPlanSelect(); showToast('Plan gespeichert!');
}
async function deletePlan(id){
  if(!confirm('Plan wirklich l√∂schen?'))return;
  setSyncState('syncing');
  const{error}=await sb.from('plans').delete().eq('id',id).eq('user_id',currentUser.id);
  if(error){showToast('Fehler beim L√∂schen: '+error.message,true);setSyncState('error');console.error('Delete plan error:',error);return;}
  await loadAllData(); renderPlans(); populateLogPlanSelect(); showToast('Plan gel√∂scht.');
}
async function toggleArchivePlan(id, archive){
  const{error}=await sb.from('plans').update({archived:archive}).eq('id',id).eq('user_id',currentUser.id);
  if(error){showToast('Fehler: '+error.message,true);return;}
  await loadAllData(); renderPlans(); populateLogPlanSelect();
  showToast(archive?'Plan archiviert.':'Plan reaktiviert.');
}
function startPlanFromPlans(id){ const plan=plans.find(p=>p.id===id); if(!plan)return; showTab('log',document.querySelector('.tab[data-tab="log"]')); startWorkout(plan); }

// ‚îÄ‚îÄ STATS ‚îÄ‚îÄ FIX: use loaded sessions data properly
function renderStats(){
  const total=sessions.length,allEx=sessions.flatMap(s=>s.exercises||[]);
  const totalSets=sessions.reduce((sum,s)=>sum+(s.exercises||[]).reduce((a,e)=>a+(e.sets||[]).length,0),0);
  const unique=[...new Set(allEx.map(e=>e.name?.toLowerCase()).filter(Boolean))].length;
  g('stats-grid').innerHTML=`
    <div class="stat-box"><div class="stat-val">${total}</div><div class="stat-label">Einheiten</div></div>
    <div class="stat-box"><div class="stat-val">${totalSets}</div><div class="stat-label">Sets gesamt</div></div>
    <div class="stat-box"><div class="stat-val">${unique}</div><div class="stat-label">√úbungen</div></div>
    <div class="stat-box"><div class="stat-val">${total?Math.round(totalSets/total):0}</div><div class="stat-label">Sets/Einheit</div></div>`;
  const names=[...new Set(allEx.map(e=>e.name).filter(Boolean))].sort();
  const sel=g('chart-ex-sel');
  sel.innerHTML=names.length?names.map(n=>`<option value="${n}">${n}</option>`).join(''):'<option>Keine Daten</option>';
  updateProgressChart(); renderWeekChart();
}
function updateProgressChart(){
  const exName=g('chart-ex-sel').value; const pts=[];
  sessions.forEach(s=>(s.exercises||[]).forEach(ex=>{
    if(ex.name===exName){ const max=Math.max(...(ex.sets||[]).map(st=>parseFloat(st.kg)||0)); if(max>0) pts.push({date:s.date,kg:max}); }
  }));
  pts.sort((a,b)=>a.date.localeCompare(b.date));
  if(pChartI) pChartI.destroy();
  pChartI=new Chart(g('progressChart'),{type:'line',data:{labels:pts.map(d=>fmtShort(d.date)),datasets:[{label:'Max kg',data:pts.map(d=>d.kg),borderColor:'#e8ff47',backgroundColor:'rgba(232,255,71,.08)',pointBackgroundColor:'#e8ff47',pointRadius:5,tension:.3,fill:true}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b6b80'},grid:{color:'#2a2a38'}},y:{ticks:{color:'#6b6b80'},grid:{color:'#2a2a38'}}}}});
}
function renderWeekChart(){
  const wc={}; sessions.forEach(s=>{const w=weekLabel(s.date);wc[w]=(wc[w]||0)+1;});
  const labels=Object.keys(wc).sort().slice(-12);
  if(wkChartI) wkChartI.destroy();
  wkChartI=new Chart(g('weekChart'),{type:'bar',data:{labels,datasets:[{data:labels.map(l=>wc[l]),backgroundColor:'rgba(232,255,71,.2)',borderColor:'#e8ff47',borderWidth:2,borderRadius:6}]},options:{plugins:{legend:{display:false}},scales:{x:{ticks:{color:'#6b6b80',font:{size:10}},grid:{color:'#2a2a38'}},y:{ticks:{color:'#6b6b80',stepSize:1},grid:{color:'#2a2a38'}}}}});
}

// ‚îÄ‚îÄ WEIGHT ‚îÄ‚îÄ
let wTimeFilter='all', bpTimeFilter='all';

function filterByTime(entries, filter){
  if(filter==='all') return entries;
  const now = new Date();
  const months = filter==='1m'?1:filter==='3m'?3:filter==='6m'?6:12;
  const cutoff = new Date(now.getFullYear(), now.getMonth()-months, now.getDate());
  const cutStr = cutoff.toISOString().split('T')[0];
  return entries.filter(e=>e.date>=cutStr);
}

function calcMA(vals, window=7){
  return vals.map((_,i)=>{
    const slice=vals.slice(Math.max(0,i-window+1),i+1).filter(v=>v!=null);
    return slice.length>=Math.floor(window/2)?slice.reduce((a,b)=>a+b)/slice.length:null;
  });
}

function setWTimeFilter(f, btn){
  wTimeFilter=f;
  document.querySelectorAll('.wtf').forEach(b=>{b.classList.remove('active');});
  btn.classList.add('active');
  renderWeightChart();
}
function setBPTimeFilter(f, btn){
  bpTimeFilter=f;
  document.querySelectorAll('.bptf').forEach(b=>{b.classList.remove('active');});
  btn.classList.add('active');
  renderBPChart();
}
function renderWeight(){renderWeightChart();renderWeekCompare();renderWeightGroups();}
function openWeightModal(entry=null){ editingWeightId=entry?entry.id:null; g('w-modal-ttl').textContent=entry?'MESSUNG BEARBEITEN':'MESSUNG ERFASSEN'; g('w-date').value=entry?entry.date:today(); g('w-kg').value=entry?(entry.weight||''):''; g('w-bauch').value=entry?(entry.bauch||''):''; g('w-hueft').value=entry?(entry.hueft||''):''; g('w-kcal').value=entry?(entry.kcal||''):''; g('w-del-btn').style.display=entry?'block':'none'; g('modal-weight').classList.add('open'); }
async function saveWeightEntry(){
  const date=g('w-date').value,weight=g('w-kg').value,bauch=g('w-bauch').value,hueft=g('w-hueft').value,kcal=g('w-kcal').value;
  if(!date){alert('Bitte Datum.');return;}
  if(!weight&&!bauch&&!hueft&&!kcal){alert('Mindestens ein Feld.');return;}
  if(!currentUser){showToast('Nicht eingeloggt!',true);return;}
  const entry={user_id:currentUser.id,date,weight:weight?parseFloat(weight):null,bauch:bauch?parseFloat(bauch):null,hueft:hueft?parseFloat(hueft):null,kcal:kcal?parseInt(kcal):null};
  setSyncState('syncing');
  let res;
  if(editingWeightId){
    res=await sb.from('weight_entries').update(entry).eq('id',editingWeightId).eq('user_id',currentUser.id);
  }else{
    // Remove user_id from entry for insert - RLS handles it, but we need it
    res=await sb.from('weight_entries').insert(entry).select();
  }
  if(res.error){
    showToast('Speicherfehler: '+res.error.message,true);
    setSyncState('error');
    console.error('Weight save error:',JSON.stringify(res.error));
    return;
  }
  await loadAllData(); closeModal('modal-weight'); renderWeight(); showToast('Messung gespeichert!');
}
async function deleteWeightEntry(){ if(!confirm('L√∂schen?'))return; await sb.from('weight_entries').delete().eq('id',editingWeightId); await loadAllData(); closeModal('modal-weight'); renderWeight(); showToast('Gel√∂scht.'); }
function switchWMetric(m,btn){
  currentWMetric=m;
  document.querySelectorAll('.wmet').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderWeightChart();
}
function renderWeightChart(){
  if(wtChartI){try{wtChartI.destroy();}catch(e){} wtChartI=null;}
  const oldW=g('weightChart');
  if(!oldW)return;
  const freshW=document.createElement('canvas');
  freshW.id='weightChart'; freshW.height=200;
  oldW.parentNode.replaceChild(freshW,oldW);
  const m=currentWMetric;
  const lmap={weight:'Gewicht (kg)',bauch:'Bauchumfang (cm)',hueft:'H√ºftumfang (cm)',kcal:'Kalorien (kcal)'};
  const colors={weight:'#47c8ff',bauch:'#47ffb8',hueft:'#c847ff',kcal:'#ff9f47'};
  const filtered=filterByTime(weightEntries, wTimeFilter);
  const pts=filtered.filter(e=>e[m]).map(e=>({date:e.date,val:parseFloat(e[m])})).sort((a,b)=>a.date.localeCompare(b.date));
  const maVals = m!=='kcal' ? calcMA(pts.map(p=>p.val),7) : calcMA(pts.map(p=>p.val),7);
  const col=colors[m]||'#47c8ff';
  const datasets=[
    {label:lmap[m],data:pts.map(p=>p.val),borderColor:col,backgroundColor:`rgba(${col==='#47c8ff'?'71,200,255':col==='#47ffb8'?'71,255,184':col==='#c847ff'?'200,71,255':'255,159,71'},.08)`,pointBackgroundColor:col,pointRadius:pts.length>60?2:4,tension:.3,fill:true,order:2},
    {label:'√ò 7 Tage',data:maVals,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,borderDash:[],order:1,spanGaps:true}
  ];
  wtChartI=new Chart(g('weightChart'),{type:'line',data:{labels:pts.map(p=>fmtShort(p.date)),datasets},options:{plugins:{legend:{display:true,labels:{color:'#6b6b80',font:{size:10},boxWidth:12,filter:item=>item.text&&item.text.includes('Trend')}}},scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10},grid:{color:'#2a2a38'}},y:{ticks:{color:'#6b6b80'},grid:{color:'#2a2a38'}}}}});
}
function renderWeekCompare(){
  const el=g('week-compare-out');
  if(weightEntries.length<2){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">Zu wenig Daten.</div>';return;}
  const weeks={};
  weightEntries.forEach(e=>{const k=weekMon(e.date);if(!weeks[k])weeks[k]=[];weeks[k].push(e);});
  const keys=Object.keys(weeks).sort().slice(-6);
  if(keys.length<2){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">Mindestens 2 Wochen ben√∂tigt.</div>';return;}
  function wavg(arr,f){const v=arr.map(e=>parseFloat(e[f])).filter(v=>!isNaN(v)&&v>0);return v.length?(v.reduce((a,b)=>a+b)/v.length).toFixed(1):null;}
  function cell(ck,pk,f){const c=wavg(weeks[ck],f),p=pk?wavg(weeks[pk],f):null;if(!c)return'<span style="color:var(--muted)">‚Äî</span>';if(!p)return c;const diff=(parseFloat(c)-parseFloat(p)).toFixed(1),n=parseFloat(diff);const cls=n<0?'d-pos':n>0?'d-neg':'d-neu',sign=n>0?'+':'';return`${c} <span class="${cls}">(${sign}${diff})</span>`;}
  let html=`<div class="week-row wh"><div>WOCHE</div><div>‚öñÔ∏è KG</div><div>üìè BAUCH</div><div>üìê H√úFTE</div><div>üî• KCAL</div></div>`;
  keys.forEach((k,i)=>{const pk=i>0?keys[i-1]:null;html+=`<div class="week-row"><div class="week-lbl">${fmtD(k,{day:'2-digit',month:'short'})}</div><div>${cell(k,pk,'weight')}</div><div>${cell(k,pk,'bauch')}</div><div>${cell(k,pk,'hueft')}</div><div>${cell(k,pk,'kcal')}</div></div>`;});
  el.innerHTML=html;
}
function renderWeightGroups(){
  const el=g('weight-groups');
  if(!weightEntries.length){el.innerHTML='';return;}
  // Group by year
  const years={};
  weightEntries.forEach(e=>{
    const y=e.date.substring(0,4);
    const mk=monthKey(e.date);
    if(!years[y]) years[y]={};
    if(!years[y][mk]) years[y][mk]=[];
    years[y][mk].push(e);
  });
  const yearKeys=Object.keys(years).sort().reverse();
  let yi=0;
  el.innerHTML=yearKeys.map(yr=>{
    const months=years[yr];
    const mkeys=Object.keys(months).sort().reverse();
    const monthsHtml=mkeys.map((mk,mi)=>{
      const gIdx=yi++;
      const entries=[...months[mk]].sort((a,b)=>b.date.localeCompare(a.date));
      const rows=entries.map(e=>{
        const vals=[];
        if(e.weight)vals.push(`‚öñÔ∏è <b>${e.weight} kg</b>`);
        if(e.bauch)vals.push(`üìè <b>${e.bauch} cm</b>`);
        if(e.hueft)vals.push(`üìê <b>${e.hueft} cm</b>`);
        if(e.kcal)vals.push(`üî• <b>${e.kcal} kcal</b>`);
        return`<div class="data-entry-row" onclick='openWeightModal(${JSON.stringify(e)})'><div><div class="data-entry-date">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short'})}</div><div class="data-entry-vals">${vals.map(v=>`<span>${v}</span>`).join('')}</div></div><span style="color:var(--muted)">‚úèÔ∏è</span></div>`;
      }).join('');
      const isFirst=(yr===yearKeys[0]&&mi===0);
      return`<div class="data-group"><div class="data-group-header" onclick="toggleGroup('wg-${gIdx}')"><div><div class="data-group-title" style="color:var(--accent4);">${monthLabel(mk)}</div><div class="data-group-meta">${entries.length} Messungen</div></div><div id="wg-arr-${gIdx}">${isFirst?'‚ñº':'‚ñ∂'}</div></div><div class="data-group-body${isFirst?' open':''}" id="wg-${gIdx}">${rows}</div></div>`;
    }).join('');
    const totalEntries=Object.values(months).flat().length;
    const isCurrentYear=(yr===yearKeys[0]);
    return`<div class="year-group" id="yg-w-${yr}">
      <div class="year-header" onclick="toggleYearGroup('yg-w-${yr}')">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;color:var(--accent);">${yr}</span>
          <span style="font-size:12px;color:var(--muted);">${totalEntries} Eintr√§ge</span>
        </div>
        <span id="yarr-w-${yr}" style="color:var(--muted);font-size:12px;">${isCurrentYear?'‚ñº':'‚ñ∂'}</span>
      </div>
      <div class="year-body${isCurrentYear?' open':''}" id="yb-w-${yr}">${monthsHtml}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ BP ‚îÄ‚îÄ
function renderBP(){renderBPChart();renderBPTable();renderBPAverages();renderBPGroups();}
function openBPModal(entry=null){ editingBPId=entry?entry.id:null; g('bp-modal-ttl').textContent=entry?'MESSUNG BEARBEITEN':'BLUTDRUCK ERFASSEN'; g('bp-date').value=entry?entry.date:today(); g('bp-time').value=entry?entry.time:nowTime(); g('bp-sys').value=entry?(entry.sys||''):''; g('bp-dia').value=entry?(entry.dia||''):''; g('bp-note').value=entry?(entry.note||''):''; g('bp-del-btn').style.display=entry?'block':'none'; g('modal-bp').classList.add('open'); }
async function saveBPEntry(){
  const date=g('bp-date').value,time=g('bp-time').value,sys=g('bp-sys').value,dia=g('bp-dia').value,note=g('bp-note').value.trim();
  if(!date||!sys||!dia){alert('Datum, Systolisch und Diastolisch sind Pflichtfelder.');return;}
  if(!currentUser){showToast('Nicht eingeloggt!',true);return;}
  const entry={user_id:currentUser.id,date,time,sys:parseInt(sys),dia:parseInt(dia),note};
  setSyncState('syncing');
  let res;
  if(editingBPId){
    res=await sb.from('bp_entries').update(entry).eq('id',editingBPId).eq('user_id',currentUser.id);
  }else{
    res=await sb.from('bp_entries').insert(entry).select();
  }
  if(res.error){
    showToast('Speicherfehler: '+res.error.message,true);
    setSyncState('error');
    console.error('BP save error:',JSON.stringify(res.error));
    return;
  }
  await loadAllData(); closeModal('modal-bp'); renderBP(); showToast('Blutdruck gespeichert!');
}
async function deleteBPEntry(){ if(!confirm('L√∂schen?'))return; await sb.from('bp_entries').delete().eq('id',editingBPId); await loadAllData(); closeModal('modal-bp'); renderBP(); showToast('Gel√∂scht.'); }
function switchBPView(v,btn){
  currentBPView=v;
  document.querySelectorAll('.bpv').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderBPChart();
}
function bpCategory(sys,dia){ if(sys<120&&dia<80)return{label:'Normal',cls:'bp-normal'}; if(sys<130&&dia<80)return{label:'Erh√∂ht',cls:'bp-elevated'}; return{label:'Hoch',cls:'bp-high'}; }
function renderBPChart(){
  // Destroy any existing instance first
  if(bpChartI){try{bpChartI.destroy();}catch(e){} bpChartI=null;}
  // Replace canvas to guarantee clean state (fixes "canvas already in use")
  const old=g('bpChart');
  if(!old)return;
  const fresh=document.createElement('canvas');
  fresh.id='bpChart'; fresh.height=220;
  old.parentNode.replaceChild(fresh,old);
  const canvas=fresh;
  const filtered=filterByTime(bpEntries,bpTimeFilter);
  if(!filtered.length)return;
  const sorted=[...filtered].sort((a,b)=>a.date===b.date?(a.time||'').localeCompare(b.time||''):a.date.localeCompare(b.date));
  const labels=sorted.map(e=>fmtShort(e.date)+(e.time?' '+e.time.substring(0,5):''));
  const sysVals=sorted.map(e=>e.sys);
  const diaVals=sorted.map(e=>e.dia);
  const maSys=calcMA(sysVals,7);
  const maDia=calcMA(diaVals,7);
  const pRadius=sorted.length>80?1:sorted.length>40?2:3;
  const datasets=[];
  if(currentBPView==='both'||currentBPView==='sys'){
    datasets.push({label:'Systolisch',data:sysVals,borderColor:'#ff4757',backgroundColor:'rgba(255,71,87,.06)',pointBackgroundColor:'#ff4757',pointRadius:pRadius,tension:.3,fill:false,order:2});
    datasets.push({label:'Trend Sys',data:maSys,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true});
  }
  if(currentBPView==='both'||currentBPView==='dia'){
    datasets.push({label:'Diastolisch',data:diaVals,borderColor:'#47c8ff',backgroundColor:'rgba(71,200,255,.06)',pointBackgroundColor:'#47c8ff',pointRadius:pRadius,tension:.3,fill:false,order:2});
    datasets.push({label:'Trend Dia',data:maDia,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true});
  }
  bpChartI=new Chart(canvas,{type:'line',data:{labels,datasets},options:{
    plugins:{legend:{display:currentBPView==='both',labels:{color:'#6b6b80',font:{size:10},boxWidth:12,
      filter:item=>item.text==='Systolisch'||item.text==='Diastolisch'}}},
    scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10,maxRotation:45},grid:{color:'#2a2a38'}},
            y:{ticks:{color:'#6b6b80'},grid:{color:'#2a2a38'},
               min:(ctx)=>{const v=ctx.chart.data.datasets.flatMap(d=>d.data).filter(x=>x!=null);return v.length?Math.floor(Math.min(...v)/5)*5-5:60;},
               max:(ctx)=>{const v=ctx.chart.data.datasets.flatMap(d=>d.data).filter(x=>x!=null);return v.length?Math.ceil(Math.max(...v)/5)*5+5:200;}}}
  }});
}
function renderBPTable(){
  const el=g('bp-table-out');
  if(!bpEntries.length){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">Noch keine Messungen.</div>';return;}
  // Last 7 days
  const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-6);
  const cutStr=cutoff.toISOString().split('T')[0];
  const recent=bpEntries.filter(e=>e.date>=cutStr);
  if(!recent.length){el.innerHTML='<div style="text-align:center;padding:16px;color:var(--muted);font-size:13px;">Keine Messungen in den letzten 7 Tagen.</div>';return;}
  const byDate={};
  recent.forEach(e=>{if(!byDate[e.date])byDate[e.date]=[];byDate[e.date].push(e);});
  const dates=Object.keys(byDate).sort().reverse();
  let html=`<table class="bp-table"><thead><tr><th>Datum</th><th>Zeit</th><th>SYS</th><th>DIA</th><th>Notiz</th></tr></thead><tbody>`;
  dates.forEach(d=>{
    byDate[d].sort((a,b)=>(a.time||'').localeCompare(b.time||'')).forEach((e,i)=>{
      html+=`<tr onclick='openBPModal(${JSON.stringify(e)})'>`;
      if(i===0) html+=`<td style="font-weight:600;vertical-align:top;" rowspan="${byDate[d].length}">${fmtD(d,{weekday:'short',day:'2-digit',month:'short'})}</td>`;
      html+=`<td style="color:var(--muted);">${e.time||'‚Äî'}</td><td class="bp-sys">${e.sys}</td><td class="bp-dia">${e.dia}</td><td style="color:var(--muted);font-size:12px;">${e.note||'‚Äî'}</td></tr>`;
    });
  });
  html+='</tbody></table>';
  el.innerHTML=html;
}
function renderBPAverages(){
  const el=g('bp-averages'); if(!el) return;
  if(!bpEntries.length){ el.innerHTML='<div style="color:var(--muted);font-size:13px;">Keine Daten.</div>'; return; }
  
  // Oldest entry date
  const bpDates=bpEntries.map(e=>e.date).sort();
  const oldestBP=bpDates[0];
  function avgFor(days){
    const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-days);
    const cutStr=cutoff.toISOString().split('T')[0];
    // Only show period if we actually have data spanning back that far
    if(oldestBP>cutStr) return null;
    const entries=bpEntries.filter(e=>e.date>=cutStr);
    if(!entries.length) return null;
    const sys=Math.round(entries.reduce((a,e)=>a+e.sys,0)/entries.length);
    const dia=Math.round(entries.reduce((a,e)=>a+e.dia,0)/entries.length);
    return {sys, dia, n:entries.length};
  }
  
  const periods=[
    {label:'7 Tage',    days:7},
    {label:'1 Monat',   days:30},
    {label:'3 Monate',  days:90},
    {label:'1 Jahr',    days:365},
  ];
  
  function bpColor(sys,dia){
    if(sys<120&&dia<80) return {color:'#47ffb8',label:'Optimal'};
    if(sys<130&&dia<85) return {color:'#a8ff47',label:'Normal'};
    if(sys<140&&dia<90) return {color:'#ffdb47',label:'Erh√∂ht'};
    return {color:'#ff4757',label:'Hoch'};
  }
  
  const rows=periods.map(p=>{
    const avg=avgFor(p.days);
    if(!avg) return '';
    return `<tr>
      <td style="font-weight:700;font-size:13px;">${p.label}</td>
      <td style="text-align:center;"><span class="bp-sys" style="font-size:16px;font-weight:800;">${avg.sys}</span></td>
      <td style="text-align:center;"><span class="bp-dia" style="font-size:16px;font-weight:800;">${avg.dia}</span></td>
    </tr>`;
  }).join('');
  if(!rows){el.innerHTML='<div style="color:var(--muted);font-size:13px;">Noch keine Daten.</div>';return;}
  el.innerHTML=`<table class="bp-table">
    <thead><tr><th>Zeitraum</th><th style="text-align:center;">Systolisch</th><th style="text-align:center;">Diastolisch</th></tr></thead>
    <tbody>${rows}</tbody>
  </table>`;
}

function renderBPGroups(){
  const el=g('bp-groups');
  if(!bpEntries.length){el.innerHTML='';return;}
  const years={};
  bpEntries.forEach(e=>{
    const yr=e.date.substring(0,4);
    const mk=monthKey(e.date);
    if(!years[yr])years[yr]={};
    if(!years[yr][mk])years[yr][mk]=[];
    years[yr][mk].push(e);
  });
  const yearKeys=Object.keys(years).sort().reverse();
  let gi=0;
  el.innerHTML=yearKeys.map(yr=>{
    const months=years[yr];
    const mkeys=Object.keys(months).sort().reverse();
    const monthsHtml=mkeys.map((mk,mi)=>{
      const idx=gi++;
      const entries=[...months[mk]].sort((a,b)=>b.date===a.date?(b.time||'').localeCompare(a.time||''):b.date.localeCompare(a.date));
      const rows=entries.map(e=>`<div class="data-entry-row" onclick='openBPModal(${JSON.stringify(e)})'><div><div class="data-entry-date">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short'})}${e.time?' ¬∑ '+e.time:''}</div><div class="data-entry-vals"><span><span class="bp-sys">${e.sys}</span>/<span class="bp-dia">${e.dia}</span> mmHg</span>${e.note?`<span style="color:var(--muted);font-size:11px;">${e.note}</span>`:''}</div></div><span style="color:var(--muted)">‚úèÔ∏è</span></div>`).join('');
      const isFirst=(yr===yearKeys[0]&&mi===0);
      return`<div class="data-group"><div class="data-group-header" onclick="toggleGroup('bpg-${idx}')"><div><div class="data-group-title" style="color:var(--accent2);">${monthLabel(mk)}</div><div class="data-group-meta">${entries.length} Messungen</div></div><div id="bpg-arr-${idx}">${isFirst?'‚ñº':'‚ñ∂'}</div></div><div class="data-group-body${isFirst?' open':''}" id="bpg-${idx}">${rows}</div></div>`;
    }).join('');
    const total=Object.values(months).flat().length;
    const isCurrentYear=(yr===yearKeys[0]);
    return`<div class="year-group" id="yg-bp-${yr}">
      <div class="year-header" onclick="toggleYearGroup('yg-bp-${yr}')">
        <div style="display:flex;align-items:center;gap:10px;">
          <span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;color:var(--accent);">${yr}</span>
          <span style="font-size:12px;color:var(--muted);">${total} Eintr√§ge</span>
        </div>
        <span id="yarr-bp-${yr}" style="color:var(--muted);font-size:12px;">${isCurrentYear?'‚ñº':'‚ñ∂'}</span>
      </div>
      <div class="year-body${isCurrentYear?' open':''}" id="yb-bp-${yr}">${monthsHtml}</div>
    </div>`;
  }).join('');
}

// ‚îÄ‚îÄ FORGOT PASSWORD ‚îÄ‚îÄ
function showForgotPw(){
  document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));
  document.querySelectorAll('.auth-tab').forEach(t=>t.classList.remove('active'));
  g('af-forgot').classList.add('active');
  g('forgot-email').value='';
  const e=g('forgot-err'); e.style.display='none';
}
async function doRecoverPw(){
  const pw=g('rec-pw')?.value, pw2=g('rec-pw2')?.value;
  const err=g('rec-err');
  if(!pw||pw.length<6){ err.textContent='Mind. 6 Zeichen.'; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  if(pw!==pw2){ err.textContent='Passw√∂rter stimmen nicht √ºberein.'; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  const {error}=await sb.auth.updateUser({password:pw});
  if(error){ err.textContent='Fehler: '+error.message; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  err.textContent='‚úì Passwort ge√§ndert! Du kannst dich jetzt anmelden.'; err.style.display='block'; err.style.color='var(--accent4)';
  setTimeout(()=>{ window.location.hash=''; showLogin(); },2000);
}

function showLogin(){
  document.querySelectorAll('.auth-form').forEach(f=>f.classList.remove('active'));
  g('af-login').classList.add('active');
  document.querySelectorAll('.auth-tab')[0].classList.add('active');
}
async function doForgotPw(){
  const email=g('forgot-email').value.trim();
  const err=g('forgot-err');
  if(!email){ err.textContent='Bitte E-Mail eingeben.'; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  const btn=g('forgot-btn'); btn.disabled=true; btn.textContent='Sende‚Ä¶';
  const {error}=await sb.auth.resetPasswordForEmail(email, {
    redirectTo: 'https://celebrated-mochi-4a3efb.netlify.app'
  });
  btn.disabled=false; btn.textContent='Link senden';
  if(error){ err.textContent='Fehler: '+error.message; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  err.textContent='‚úì E-Mail gesendet! Pr√ºfe deinen Posteingang.';
  err.style.display='block'; err.style.color='var(--accent4)';
}

// ‚îÄ‚îÄ PASSWORD CHANGE ‚îÄ‚îÄ
function openChangePw(){
  g('pw-new').value=''; g('pw-confirm').value='';
  const e=g('pw-err'); e.style.display='none';
  g('modal-pw').classList.add('open');
}
async function saveNewPw(){
  const pw=g('pw-new').value, c=g('pw-confirm').value;
  const err=g('pw-err');
  if(pw.length<6){ err.textContent='Mind. 6 Zeichen.'; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  if(pw!==c){ err.textContent='Passw√∂rter stimmen nicht √ºberein.'; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  const {error}=await sb.auth.updateUser({password:pw});
  if(error){ err.textContent='Fehler: '+error.message; err.style.display='block'; err.style.color='var(--accent2)'; return; }
  closeModal('modal-pw');
  showToast('Passwort ge√§ndert!');
}

// ‚îÄ‚îÄ CSV IMPORT ‚îÄ‚îÄ

// ‚îÄ‚îÄ WEIGHT IMPORT ‚îÄ‚îÄ
let weightImportRows = [];

function resetWeightImport(){
  weightImportRows=[];
  const f=g('weight-csv-file'); if(f) f.value='';
  const p=g('weight-import-preview'); if(p) p.style.display='none';
  const b=g('weight-import-btn'); if(b) b.style.display='none';
  const e=g('weight-import-err'); if(e) e.style.display='none';
}

g('weight-csv-file') && g('weight-csv-file').addEventListener('change', function(){
  const file = this.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const text = e.target.result;
    parseWeightCSV(text);
  };
  reader.readAsText(file, 'UTF-8');
});

// Re-attach after DOM ready
document.addEventListener('DOMContentLoaded', ()=>{
  const wf=g('weight-csv-file');
  if(wf) wf.addEventListener('change', function(){
    const file=this.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>parseWeightCSV(e.target.result);
    reader.readAsText(file,'UTF-8');
  });
  const bf=g('bp-csv-file');
  if(bf) bf.addEventListener('change', function(){
    const file=this.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=e=>parseBPCSV(e.target.result);
    reader.readAsText(file,'UTF-8');
  });
});

function parseWeightCSV(text){
  const errEl=g('weight-import-err');
  errEl.style.display='none';
  weightImportRows=[];
  
  const lines=text.trim().split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length){ showImportErr('weight-import-err','Datei ist leer.'); return; }
  
  // Auto-detect if first line is header
  const firstLower=lines[0].toLowerCase();
  const hasHeader = firstLower.includes('datum') || firstLower.includes('date') || 
                    firstLower.includes('gewicht') || firstLower.includes('weight') ||
                    isNaN(firstLower.split(/[,;\t]/)[0].trim().replace('-',''));
  const dataLines = hasHeader ? lines.slice(1) : lines;
  
  // Auto-detect separator
  const sep = lines[0].includes(';') ? ';' : lines[0].includes('\t') ? '\t' : ',';
  
  const errors=[];
  dataLines.forEach((line,i)=>{
    if(!line.trim()) return;
    const cols=line.split(sep).map(c=>c.trim().replace(/^["']|["']$/g,''));
    const [rawDate, rawWeight, rawBauch, rawHuefte, rawKcal] = cols;
    
    // Parse date - support DD.MM.YYYY, YYYY-MM-DD, DD/MM/YYYY
    const date = parseAnyDate(rawDate);
    if(!date){ errors.push(`Zeile ${i+2}: Ung√ºltiges Datum "${rawDate}"`); return; }
    
    const weight = rawWeight ? parseFloat(rawWeight.replace(',','.')) : null;
    const bauch  = rawBauch  ? parseFloat(rawBauch.replace(',','.'))  : null;
    const huefte = rawHuefte ? parseFloat(rawHuefte.replace(',','.')) : null;
    const kcal   = rawKcal   ? parseInt(rawKcal)                       : null;
    
    if(!weight && !bauch && !huefte && !kcal){ errors.push(`Zeile ${i+2}: Keine Werte`); return; }
    
    weightImportRows.push({date, weight, bauch, hueft:huefte, kcal});
  });
  
  if(!weightImportRows.length){
    showImportErr('weight-import-err', (errors.length?errors.join(', '):'Keine g√ºltigen Zeilen gefunden.'));
    return;
  }
  
  // Show preview
  g('weight-import-info').innerHTML = 
    '<span style="color:var(--accent4)">'+weightImportRows.length+' Zeilen bereit</span>'
    +(errors.length ? ' <span style="color:var(--accent2)">¬∑ '+errors.length+' Fehler ignoriert</span>' : '');
  
  g('weight-import-table').innerHTML = 
    '<table style="width:100%;font-size:11px;border-collapse:collapse;">'
    +'<tr style="color:var(--muted);"><th style="text-align:left;padding:3px 6px;">Datum</th><th>Gewicht</th><th>Bauch</th><th>H√ºfte</th><th>Kcal</th></tr>'
    +weightImportRows.slice(0,10).map(r=>
      '<tr style="border-top:1px solid var(--border);">'
      +'<td style="padding:3px 6px;">'+r.date+'</td>'
      +'<td style="text-align:center;">'+(r.weight||'‚Äî')+'</td>'
      +'<td style="text-align:center;">'+(r.bauch||'‚Äî')+'</td>'
      +'<td style="text-align:center;">'+(r.hueft||'‚Äî')+'</td>'
      +'<td style="text-align:center;">'+(r.kcal||'‚Äî')+'</td>'
      +'</tr>'
    ).join('')
    +(weightImportRows.length>10?'<tr><td colspan="5" style="color:var(--muted);padding:4px 6px;">... und '+(weightImportRows.length-10)+' weitere</td></tr>':'')
    +'</table>';
  
  g('weight-import-preview').style.display='block';
  g('weight-import-btn').style.display='block';
}

async function doWeightImport(){
  if(!weightImportRows.length) return;
  const btn=g('weight-import-btn'); btn.disabled=true; btn.textContent='Importiere...';
  
  // Insert in batches of 50
  const rows = weightImportRows.map(r=>({...r, user_id:currentUser.id}));
  let imported=0, errors=0;
  
  for(let i=0;i<rows.length;i+=50){
    const batch=rows.slice(i,i+50);
    const{error}=await sb.from('weight_entries').upsert(batch, {onConflict:'user_id,date'});
    if(error){ errors+=batch.length; console.error('Weight import batch error:',error); }
    else imported+=batch.length;
  }
  
  btn.disabled=false; btn.textContent='Importieren';
  await loadAllData();
  closeModal('modal-weight-import');
  resetWeightImport();
  renderWeight();
  showToast(imported+' Messungen importiert!'+(errors?' ('+errors+' Fehler)':''));
}

// ‚îÄ‚îÄ BP IMPORT ‚îÄ‚îÄ
let bpImportRows = [];

function resetBPImport(){
  bpImportRows=[];
  const f=g('bp-csv-file'); if(f) f.value='';
  const p=g('bp-import-preview'); if(p) p.style.display='none';
  const b=g('bp-import-btn'); if(b) b.style.display='none';
  const e=g('bp-import-err'); if(e) e.style.display='none';
}

function parseBPCSV(text){
  const errEl=g('bp-import-err');
  errEl.style.display='none';
  bpImportRows=[];
  
  const lines=text.trim().split(/\r?\n/).filter(l=>l.trim());
  if(!lines.length){ showImportErr('bp-import-err','Datei ist leer.'); return; }
  
  const firstLower=lines[0].toLowerCase();
  const hasHeader = firstLower.includes('datum') || firstLower.includes('date') ||
                    firstLower.includes('sys') || firstLower.includes('blut') ||
                    isNaN(firstLower.split(/[,;\t]/)[0].trim().replace('-',''));
  const dataLines = hasHeader ? lines.slice(1) : lines;
  const sep = lines[0].includes(';') ? ';' : lines[0].includes('\t') ? '\t' : ',';
  
  const errors=[];
  dataLines.forEach((line,i)=>{
    if(!line.trim()) return;
    const cols=line.split(sep).map(c=>c.trim().replace(/^["']|["']$/g,''));
    const [rawDate, rawTime, rawSys, rawDia, rawNote] = cols;
    
    const date=parseAnyDate(rawDate);
    if(!date){ errors.push(`Zeile ${i+2}: Ung√ºltiges Datum "${rawDate}"`); return; }
    
    const sys=parseInt(rawSys);
    const dia=parseInt(rawDia);
    if(isNaN(sys)||isNaN(dia)||sys<40||sys>300||dia<20||dia>200){
      errors.push(`Zeile ${i+2}: Ung√ºltige Werte SYS=${rawSys} DIA=${rawDia}`); return;
    }
    
    // Normalize time HH:MM
    let time='';
    if(rawTime && rawTime.trim()){
      const tm=rawTime.trim();
      if(/^\d{1,2}:\d{2}$/.test(tm)){
        time=tm.padStart(5,'0');
      } else if(/^\d{3,4}$/.test(tm)){
        time=tm.slice(0,-2).padStart(2,'0')+':'+tm.slice(-2);
      }
    }
    
    bpImportRows.push({date, time, sys, dia, note:rawNote||''});
  });
  
  if(!bpImportRows.length){
    showImportErr('bp-import-err', errors.length?errors.join(', '):'Keine g√ºltigen Zeilen.');
    return;
  }
  
  g('bp-import-info').innerHTML =
    '<span style="color:var(--accent2)">'+bpImportRows.length+' Eintr√§ge bereit</span>'
    +(errors.length?' <span style="color:var(--accent2)">¬∑ '+errors.length+' Fehler ignoriert</span>':'');
  
  g('bp-import-table').innerHTML =
    '<table style="width:100%;font-size:11px;border-collapse:collapse;">'
    +'<tr style="color:var(--muted);"><th style="text-align:left;padding:3px 6px;">Datum</th><th>Uhrzeit</th><th>SYS</th><th>DIA</th><th>Notiz</th></tr>'
    +bpImportRows.slice(0,10).map(r=>
      '<tr style="border-top:1px solid var(--border);">'
      +'<td style="padding:3px 6px;">'+r.date+'</td>'
      +'<td style="text-align:center;">'+(r.time||'‚Äî')+'</td>'
      +'<td style="text-align:center;color:#ff4757;">'+r.sys+'</td>'
      +'<td style="text-align:center;color:#47c8ff;">'+r.dia+'</td>'
      +'<td style="color:var(--muted);">'+(r.note||'‚Äî')+'</td>'
      +'</tr>'
    ).join('')
    +(bpImportRows.length>10?'<tr><td colspan="5" style="color:var(--muted);padding:4px 6px;">... und '+(bpImportRows.length-10)+' weitere</td></tr>':'')
    +'</table>';
  
  g('bp-import-preview').style.display='block';
  g('bp-import-btn').style.display='block';
}

async function doBPImport(){
  if(!bpImportRows.length) return;
  const btn=g('bp-import-btn'); btn.disabled=true; btn.textContent='Importiere...';
  
  const rows=bpImportRows.map(r=>({...r, user_id:currentUser.id}));
  let imported=0, errors=0;
  
  for(let i=0;i<rows.length;i+=50){
    const batch=rows.slice(i,i+50);
    const{error}=await sb.from('bp_entries').insert(batch);
    if(error){ errors+=batch.length; console.error('BP import error:',error); }
    else imported+=batch.length;
  }
  
  btn.disabled=false; btn.textContent='Importieren';
  await loadAllData();
  closeModal('modal-bp-import');
  resetBPImport();
  renderBP();
  showToast(imported+' Eintr√§ge importiert!'+(errors?' ('+errors+' Fehler)':''));
}

// Helper: parse various date formats -> YYYY-MM-DD or null
function parseAnyDate(raw){
  if(!raw||!raw.trim()) return null;
  const s=raw.trim();
  // YYYY-MM-DD
  if(/^\d{4}-\d{1,2}-\d{1,2}$/.test(s)){
    const[y,m,d]=s.split('-');
    return y+'-'+m.padStart(2,'0')+'-'+d.padStart(2,'0');
  }
  // DD.MM.YYYY or DD/MM/YYYY
  if(/^\d{1,2}[./]\d{1,2}[./]\d{4}$/.test(s)){
    const parts=s.split(/[./]/);
    return parts[2]+'-'+parts[1].padStart(2,'0')+'-'+parts[0].padStart(2,'0');
  }
  // DD.MM.YY
  if(/^\d{1,2}[./]\d{1,2}[./]\d{2}$/.test(s)){
    const parts=s.split(/[./]/);
    const yr=parseInt(parts[2])<50?'20'+parts[2]:'19'+parts[2];
    return yr+'-'+parts[1].padStart(2,'0')+'-'+parts[0].padStart(2,'0');
  }
  return null;
}

function showImportErr(id, msg){
  const el=g(id); if(!el) return;
  el.textContent='Fehler: '+msg; el.style.display='block';
}

// Attach file input listeners (called after DOM ready)
setTimeout(()=>{
  const wf=g('weight-csv-file');
  if(wf && !wf._hasListener){ wf._hasListener=true; wf.addEventListener('change',function(){ const file=this.files[0];if(!file)return;const r=new FileReader();r.onload=e=>parseWeightCSV(e.target.result);r.readAsText(file,'UTF-8'); }); }
  const bf=g('bp-csv-file');
  if(bf && !bf._hasListener){ bf._hasListener=true; bf.addEventListener('change',function(){ const file=this.files[0];if(!file)return;const r=new FileReader();r.onload=e=>parseBPCSV(e.target.result);r.readAsText(file,'UTF-8'); }); }
},500);


// ‚îÄ‚îÄ PDF EXPORT ‚îÄ‚îÄ
function pdfStyles(){
  return `
    body{font-family:Arial,sans-serif;color:#1a1a2e;background:#fff;margin:0;padding:24px;font-size:12px;}
    h1{font-size:22px;letter-spacing:4px;font-weight:900;margin:0 0 4px;}
    .sub{font-size:11px;color:#666;margin-bottom:24px;}
    table{width:100%;border-collapse:collapse;margin-bottom:24px;}
    th{background:#1a1a2e;color:#e8ff47;padding:7px 10px;text-align:left;font-size:11px;letter-spacing:1px;text-transform:uppercase;}
    td{padding:6px 10px;border-bottom:1px solid #e8e8f0;font-size:12px;}
    tr:nth-child(even) td{background:#f8f8fc;}
    .sys{color:#e62a38;font-weight:700;}
    .dia{color:#0077b6;font-weight:700;}
    .bold{font-weight:700;}
    .section{font-size:13px;font-weight:700;letter-spacing:2px;text-transform:uppercase;margin:20px 0 8px;color:#1a1a2e;border-bottom:2px solid #e8ff47;padding-bottom:4px;}
    .footer{margin-top:32px;font-size:10px;color:#999;border-top:1px solid #eee;padding-top:8px;}
    @media print{body{padding:0;} .no-print{display:none;}}
  `;
}

function openPDFWindow(title, bodyHtml){
  const w = window.open('','_blank','width=900,height=700');
  w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${title}</title><style>${pdfStyles()}</style></head><body>${bodyHtml}<div class="footer">IRONLOG ¬∑ Exportiert am ${new Date().toLocaleDateString('de-DE',{day:'2-digit',month:'long',year:'numeric'})} ¬∑ ironlog.app</div><script>window.onload=()=>{window.print();}<\/script></body></html>`);
  w.document.close();
}

let _pdfCallback=null;
function openPDFSelect(title, callback){
  if(!callback){return;}
  _pdfCallback=(mode)=>{closeModal('modal-pdf-select');callback(mode);};
  g('pdf-select-title').textContent=title;
  g('modal-pdf-select').classList.add('open');
}

function exportWeightPDF(){
  if(!weightEntries.length){showToast('Keine Daten vorhanden.',true);return;}
  openPDFSelect('GEWICHT PDF', mode => _doExportWeightPDF(mode));
}
function _doExportWeightPDF(mode){
  if(!weightEntries.length){showToast('Keine Daten vorhanden.',true);return;}
  const sorted=[...weightEntries].sort((a,b)=>b.date.localeCompare(a.date));
  const name=currentProfile?.name||'Unbekannt';
  const from=fmtD(sorted[sorted.length-1].date,{day:'2-digit',month:'long',year:'numeric'});
  const to=fmtD(sorted[0].date,{day:'2-digit',month:'long',year:'numeric'});

  // Stats
  const weights=sorted.filter(e=>e.weight).map(e=>parseFloat(e.weight));
  const minW=Math.min(...weights).toFixed(1), maxW=Math.max(...weights).toFixed(1);
  const avgW=(weights.reduce((a,b)=>a+b)/weights.length).toFixed(1);
  const diff=(parseFloat(sorted[0].weight||0)-parseFloat(sorted[sorted.length-1].weight||0)).toFixed(1);
  const diffSign=parseFloat(diff)>0?'+':'';

  const statsHtml=`<table style="margin-bottom:16px;"><tr>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;border-radius:8px;"><div style="font-size:18px;font-weight:700;">${avgW}<small>kg</small></div><div style="font-size:10px;color:#666;">Durchschnitt</div></td>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;"><div style="font-size:18px;font-weight:700;">${minW}<small>kg</small></div><div style="font-size:10px;color:#666;">Minimum</div></td>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;"><div style="font-size:18px;font-weight:700;">${maxW}<small>kg</small></div><div style="font-size:10px;color:#666;">Maximum</div></td>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;"><div style="font-size:18px;font-weight:700;color:${parseFloat(diff)<0?'#27ae60':'#e62a38'}">${diffSign}${diff}<small>kg</small></div><div style="font-size:10px;color:#666;">Ver√§nderung</div></td>
  </tr></table>`;

  const rows=sorted.map(e=>{
    const vals=[];
    if(e.bauch)vals.push(`Bauch: ${e.bauch}cm`);
    if(e.hueft)vals.push(`H√ºfte: ${e.hueft}cm`);
    if(e.kcal)vals.push(`${e.kcal} kcal`);
    return`<tr><td class="bold">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</td><td class="bold">${e.weight?e.weight+' kg':'‚Äî'}</td><td>${e.bauch?e.bauch+' cm':'‚Äî'}</td><td>${e.hueft?e.hueft+' cm':'‚Äî'}</td><td>${e.kcal?e.kcal:'‚Äî'}</td></tr>`;
  }).join('');

  const body=`
    <h1>IRONLOG <span style="color:#666;font-weight:300;">Gewicht</span></h1>
    <div class="sub">${name} ¬∑ ${from} bis ${to} ¬∑ ${sorted.length} Messungen</div>
    <div class="section">Zusammenfassung</div>
    ${statsHtml}
    <div class="section">Alle Messungen</div>
    <table><thead><tr><th>Datum</th><th>Gewicht</th><th>Bauch</th><th>H√ºfte</th><th>Kalorien</th></tr></thead><tbody>${rows}</tbody></table>`;

  if(mode==='table'){
    openPDFWindow('IRONLOG Gewicht', `<h1>IRONLOG <span style="color:#666;font-weight:300;">Gewicht</span></h1><div class="sub">${name} ¬∑ ${from} bis ${to} ¬∑ ${sorted.length} Messungen</div><div class="section">Zusammenfassung</div>${statsHtml}<div class="section">Alle Messungen</div><table><thead><tr><th>Datum</th><th>Gewicht</th><th>Bauch</th><th>H√ºfte</th><th>Kalorien</th></tr></thead><tbody>${rows}</tbody></table>`);
  } else if(mode==='chart'){
    _exportWeightChartPDF(name);
  } else {
    openPDFWindow('IRONLOG Gewicht', `<h1>IRONLOG <span style="color:#666;font-weight:300;">Gewicht</span></h1><div class="sub">${name} ¬∑ ${from} bis ${to} ¬∑ ${sorted.length} Messungen</div><div class="section">Zusammenfassung</div>${statsHtml}<div id="chart-placeholder" style="margin:16px 0;text-align:center;background:#f0f0f8;padding:40px;border-radius:8px;color:#999;font-size:13px;">üìà Diagramm nur in der App verf√ºgbar</div><div class="section">Alle Messungen</div><table><thead><tr><th>Datum</th><th>Gewicht</th><th>Bauch</th><th>H√ºfte</th><th>Kalorien</th></tr></thead><tbody>${rows}</tbody></table>`);
  }
}
function _exportWeightChartPDF(name){
  const canvas=g('weightChart');
  if(!canvas){showToast('Bitte zuerst einen Zeitraum im Chart anzeigen.',true);return;}
  const img=canvas.toDataURL('image/png');
  const from=filterByTime(weightEntries,wTimeFilter);
  const label=from.length?`${fmtD(from[from.length-1].date,{day:'2-digit',month:'short',year:'numeric'})} ‚Äì ${fmtD(from[0].date,{day:'2-digit',month:'short',year:'numeric'})}`:'-';
  openPDFWindow('IRONLOG Gewicht', `<h1>IRONLOG <span style="color:#666;font-weight:300;">Gewicht</span></h1><div class="sub">${name} ¬∑ ${label}</div><div class="section">Diagramm</div><img src="${img}" style="max-width:100%;border-radius:8px;"/>`);
}

function exportBPPDF(){
  if(!bpEntries.length){showToast('Keine Daten vorhanden.',true);return;}
  openPDFSelect('BLUTDRUCK PDF', mode => _doExportBPPDF(mode));
}
function _doExportBPPDF(mode){
  if(!bpEntries.length){return;}
  const sorted=[...bpEntries].sort((a,b)=>b.date===a.date?(b.time||'').localeCompare(a.time||''):b.date.localeCompare(a.date));
  const name=currentProfile?.name||'Unbekannt';
  const dates=sorted.map(e=>e.date);
  const from=fmtD(dates[dates.length-1],{day:'2-digit',month:'long',year:'numeric'});
  const to=fmtD(dates[0],{day:'2-digit',month:'long',year:'numeric'});

  const sysVals=sorted.map(e=>e.sys);
  const diaVals=sorted.map(e=>e.dia);
  const avgSys=Math.round(sysVals.reduce((a,b)=>a+b)/sysVals.length);
  const avgDia=Math.round(diaVals.reduce((a,b)=>a+b)/diaVals.length);
  const maxSys=Math.max(...sysVals), maxDia=Math.max(...diaVals);
  const minSys=Math.min(...sysVals), minDia=Math.min(...diaVals);

  const statsHtml=`<table style="margin-bottom:16px;"><tr>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;"><div style="font-size:18px;font-weight:700;"><span class="sys">${avgSys}</span>/<span class="dia">${avgDia}</span></div><div style="font-size:10px;color:#666;">Durchschnitt</div></td>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;"><div style="font-size:18px;font-weight:700;"><span class="sys">${minSys}</span>/<span class="dia">${minDia}</span></div><div style="font-size:10px;color:#666;">Minimum</div></td>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;"><div style="font-size:18px;font-weight:700;"><span class="sys">${maxSys}</span>/<span class="dia">${maxDia}</span></div><div style="font-size:10px;color:#666;">Maximum</div></td>
    <td style="padding:8px 16px;text-align:center;background:#f8f8fc;"><div style="font-size:18px;font-weight:700;">${sorted.length}</div><div style="font-size:10px;color:#666;">Messungen</div></td>
  </tr></table>`;

  // Group by month for PDF
  const byMonth={};
  sorted.forEach(e=>{const mk=e.date.substring(0,7);if(!byMonth[mk])byMonth[mk]=[];byMonth[mk].push(e);});
  let tableRows='';
  Object.keys(byMonth).sort().reverse().forEach(mk=>{
    const monthEntries=byMonth[mk].sort((a,b)=>b.date===a.date?(b.time||'').localeCompare(a.time||''):b.date.localeCompare(a.date));
    tableRows+=`<tr><td colspan="5" style="background:#e8e8f0;font-weight:700;font-size:11px;letter-spacing:1px;text-transform:uppercase;">${monthLabel(mk)}</td></tr>`;
    tableRows+=monthEntries.map(e=>`<tr><td>${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short'})}</td><td style="color:#666;">${e.time||'‚Äî'}</td><td class="sys">${e.sys}</td><td class="dia">${e.dia}</td><td style="color:#666;font-size:11px;">${e.note||'‚Äî'}</td></tr>`).join('');
  });

  const body=`
    <h1>IRONLOG <span style="color:#666;font-weight:300;">Blutdruck</span></h1>
    <div class="sub">${name} ¬∑ ${from} bis ${to} ¬∑ ${sorted.length} Messungen</div>
    <div class="section">Zusammenfassung</div>
    ${statsHtml}
    <div class="section">Alle Messungen</div>
    <table><thead><tr><th>Datum</th><th>Uhrzeit</th><th>Systolisch</th><th>Diastolisch</th><th>Notiz</th></tr></thead><tbody>${tableRows}</tbody></table>`;

  if(mode==='table'){
    openPDFWindow('IRONLOG Blutdruck', body);
  } else if(mode==='chart'){
    const canvas=g('bpChart');
    if(!canvas){showToast('Bitte zuerst einen Zeitraum im Chart anzeigen.',true);return;}
    const img=canvas.toDataURL('image/png');
    openPDFWindow('IRONLOG Blutdruck', `<h1>IRONLOG <span style="color:#666;font-weight:300;">Blutdruck</span></h1><div class="sub">${name}</div><div class="section">Diagramm</div><img src="${img}" style="max-width:100%;border-radius:8px;"/>`);
  } else {
    const canvas=g('bpChart');
    const chartHtml=canvas?`<div class="section">Diagramm</div><img src="${canvas.toDataURL('image/png')}" style="max-width:100%;border-radius:8px;"/>` :'';
    openPDFWindow('IRONLOG Blutdruck', `${body.replace('<div class="section">Alle','${chartHtml}<div class="section">Alle')}`);
  }
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ SLEEP ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let sleepTimeFilter='all', sleepRatingVal=null, editingSleepId=null, sleepChartI=null;

const SLEEP_RATINGS={
  1:{label:'Gut',emoji:'üòä',color:'#47ffb8'},
  0:{label:'Neutral',emoji:'üòê',color:'#47c8ff'},
  '-1':{label:'Schlecht',emoji:'üòî',color:'#ffb347'}
};

function setSleepTimeFilter(f,btn){
  sleepTimeFilter=f;
  document.querySelectorAll('.sltf').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderSleepChart();
  renderSleepRatingChart();
}

function openSleepModal(entry=null){
  editingSleepId=entry?entry.id:null;
  sleepRatingVal=entry?entry.rating:null;
  g('sleep-modal-ttl').textContent=entry?'SCHLAF BEARBEITEN':'SCHLAF ERFASSEN';
  g('sleep-date').value=entry?entry.date:today();
  g('sleep-from').value=entry?(entry.sleep_from||''):'22:00';
  g('sleep-to').value=entry?(entry.sleep_to||''):'07:00';
  g('sleep-note').value=entry?(entry.note||''):'';
  g('sleep-del-btn').style.display=entry?'block':'none';
  // Reset rating buttons
  document.querySelectorAll('#sleep-rating-btns .rating-btn').forEach(b=>{
    b.classList.toggle('active', parseInt(b.dataset.val)===sleepRatingVal);
  });
  updateSleepDuration();
  g('modal-sleep').classList.add('open');
}

function selectSleepRating(val,btn){
  sleepRatingVal=val;
  document.querySelectorAll('#sleep-rating-btns .rating-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

function updateSleepDuration(){
  const from=g('sleep-from').value, to=g('sleep-to').value;
  if(!from||!to){g('sleep-duration-display').textContent='‚Äî';return;}
  let [fh,fm]=from.split(':').map(Number), [th,tm]=to.split(':').map(Number);
  let mins=(th*60+tm)-(fh*60+fm);
  if(mins<0) mins+=24*60; // overnight
  const h=Math.floor(mins/60), m=mins%60;
  g('sleep-duration-display').textContent=`${h}h ${m}min`;
}

// Listen for time changes
setTimeout(()=>{
  const sf=g('sleep-from'), st=g('sleep-to');
  if(sf) sf.addEventListener('change',updateSleepDuration);
  if(st) st.addEventListener('change',updateSleepDuration);
},600);

async function saveSleepEntry(){
  const date=g('sleep-date').value, from=g('sleep-from').value, to=g('sleep-to').value;
  if(!date||!from||!to){alert('Datum, Einschlafen und Aufwachen sind Pflichtfelder.');return;}
  let [fh,fm]=from.split(':').map(Number), [th,tm]=to.split(':').map(Number);
  let mins=(th*60+tm)-(fh*60+fm);
  if(mins<0) mins+=24*60;
  const entry={user_id:currentUser.id,date,sleep_from:from,sleep_to:to,duration_mins:mins,rating:sleepRatingVal,note:g('sleep-note').value.trim()};
  setSyncState('syncing');
  let res;
  if(editingSleepId) res=await sb.from('sleep_entries').update(entry).eq('id',editingSleepId).eq('user_id',currentUser.id);
  else res=await sb.from('sleep_entries').insert(entry).select();
  if(res.error){showToast('Fehler: '+res.error.message,true);setSyncState('error');return;}
  await loadAllData(); closeModal('modal-sleep'); renderSleep(); showToast('Schlaf gespeichert!');
}

async function deleteSleepEntry(){
  if(!confirm('Eintrag l√∂schen?'))return;
  await sb.from('sleep_entries').delete().eq('id',editingSleepId);
  await loadAllData(); closeModal('modal-sleep'); renderSleep(); showToast('Gel√∂scht.');
}

function renderSleep(){renderSleepChart();renderSleepRatingChart();renderSleepAverages();renderSleepGroups();}

function renderSleepChart(){
  if(sleepChartI){try{sleepChartI.destroy();}catch(e){}sleepChartI=null;}
  const old=g('sleepChart'); if(!old)return;
  const fresh=document.createElement('canvas'); fresh.id='sleepChart'; fresh.height=200;
  old.parentNode.replaceChild(fresh,old);
  const filtered=filterByTime(sleepEntries,sleepTimeFilter);
  if(!filtered.length)return;
  const sorted=[...filtered].sort((a,b)=>a.date.localeCompare(b.date));
  const durVals=sorted.map(e=>e.duration_mins?+(e.duration_mins/60).toFixed(2):null);
  const maDur=calcMA(durVals,7);
  sleepChartI=new Chart(fresh,{type:'line',data:{
    labels:sorted.map(e=>fmtShort(e.date)),
    datasets:[
      {label:'Schlafdauer (h)',data:durVals,borderColor:'#c847ff',backgroundColor:'rgba(200,71,255,.07)',pointBackgroundColor:'#c847ff',pointRadius:sorted.length>60?2:4,tension:.3,fill:true,order:2},
      {label:'√ò 7 Tage',data:maDur,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true}
    ]
  },options:{
    plugins:{legend:{display:true,labels:{color:'#6b6b80',font:{size:10},boxWidth:12,filter:item=>item.text&&item.text.includes('√ò')}}},
    scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10},grid:{color:'#2a2a38'}},
            y:{ticks:{color:'#6b6b80',callback:v=>v+'h'},grid:{color:'#2a2a38'},min:0}}
  }});
}

function renderSleepRatingChart(){
  const el=g('sleepRatingChart'); if(!el)return;
  const filtered=filterByTime(sleepEntries,sleepTimeFilter).filter(e=>e.rating!=null);
  if(!filtered.length){el.innerHTML='<div style="color:var(--muted);font-size:12px;padding:12px 0;">Noch keine Bewertungen.</div>';return;}
  const sorted=[...filtered].sort((a,b)=>a.date.localeCompare(b.date));

  // Emoji label row + bars
  const EMOJIS={1:{e:'üòä',c:'#47ffb8'},0:{e:'üòê',c:'#47c8ff'},'-1':{e:'üòî',c:'#ff4757'}};
  const rows=[
    {val:1, label:'Gut'},
    {val:0, label:'Neutral'},
    {val:-1, label:'Schlecht'}
  ];

  const html=rows.map(row=>{
    const info=EMOJIS[row.val];
    // Count entries for this rating
    const count=sorted.filter(e=>(e.rating>1?1:e.rating<-1?-1:e.rating)===row.val).length;
    const pct=sorted.length?Math.round(count/sorted.length*100):0;
    return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:10px;">
      <span style="font-size:22px;width:30px;text-align:center;font-family:-apple-system,'Apple Color Emoji','Segoe UI Emoji',sans-serif;">${info.e}</span>
      <div style="flex:1;background:var(--surface);border-radius:6px;height:22px;overflow:hidden;">
        <div style="width:${pct}%;background:${info.c};height:100%;border-radius:6px;transition:width .4s;min-width:${pct>0?'4px':'0'};"></div>
      </div>
      <span style="font-size:12px;color:${info.c};font-weight:700;min-width:36px;text-align:right;">${count}√ó</span>
    </div>`;
  }).join('');

  // Summary line
  const last7=sorted.filter(e=>{const cutoff=new Date();cutoff.setDate(cutoff.getDate()-7);return e.date>=cutoff.toISOString().split('T')[0];});
  const avgRecent=last7.length?+(last7.reduce((a,e)=>a+(e.rating>1?1:e.rating<-1?-1:e.rating),0)/last7.length).toFixed(1):null;
  const avgEmoji=avgRecent!=null?(avgRecent>0.3?'üòä':avgRecent<-0.3?'üòî':'üòê'):'';

  el.innerHTML=`${html}
    ${avgRecent!=null?`<div style="font-size:11px;color:var(--muted);margin-top:4px;padding-top:8px;border-top:1px solid var(--border);">
      Letzte 7 Tage: √ò <span style="font-size:16px;font-family:-apple-system,'Apple Color Emoji',sans-serif;">${avgEmoji}</span>
      <span style="font-weight:600;color:var(--text);"> ${avgRecent>0?'+':''}${avgRecent}</span>
    </div>`:''}`;
}

function renderSleepAverages(){
  const el=g('sleep-averages'); if(!el)return;
  if(!sleepEntries.length){el.innerHTML='<div style="color:var(--muted);font-size:13px;">Keine Daten.</div>';return;}
  const sleepDates=sleepEntries.map(e=>e.date).sort();
  const oldestSleep=sleepDates[0];
  function avgFor(days){
    const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-days);
    const cutStr=cutoff.toISOString().split('T')[0];
    if(oldestSleep>cutStr) return null;
    const entries=sleepEntries.filter(e=>e.date>=cutStr);
    if(!entries.length) return null;
    const avgMins=Math.round(entries.reduce((a,e)=>a+(e.duration_mins||0),0)/entries.length);
    const withRating=entries.filter(e=>e.rating!=null);
    const avgRating=withRating.length?+(withRating.reduce((a,e)=>a+e.rating,0)/withRating.length).toFixed(1):null;
    return{h:Math.floor(avgMins/60),m:avgMins%60,rating:avgRating,n:entries.length};
  }
  const periods=[{label:'7 Tage',days:7},{label:'1 Monat',days:30},{label:'3 Monate',days:90},{label:'1 Jahr',days:365}];
  const rows=periods.map(p=>{
    const avg=avgFor(p.days);
    if(!avg) return null;
    const rIdx=Math.round(avg.rating);const rInfo=avg.rating!=null?(SLEEP_RATINGS[rIdx]||SLEEP_RATINGS[-1]||SLEEP_RATINGS[1]):null;
    return`<tr><td style="font-weight:700;font-size:13px;">${p.label}</td>
      <td style="text-align:center;font-size:16px;font-weight:800;color:#c847ff;">${avg.h}h ${avg.m}m</td>
      <td style="text-align:center;">${rInfo?`<span style="font-size:15px;">${rInfo.emoji}</span> <span style="font-size:11px;color:${rInfo.color};">${rInfo.label}</span>`:'‚Äî'}</td></tr>`;
  }).filter(Boolean).join('');
  el.innerHTML=`<table class="bp-table"><thead><tr><th>Zeitraum</th><th style="text-align:center;">Schlafdauer</th><th style="text-align:center;">Bewertung</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function renderSleepGroups(){
  const el=g('sleep-groups'); if(!el)return;
  if(!sleepEntries.length){el.innerHTML='';return;}
  const years={};
  sleepEntries.forEach(e=>{const yr=e.date.substring(0,4),mk=monthKey(e.date);if(!years[yr])years[yr]={};if(!years[yr][mk])years[yr][mk]=[];years[yr][mk].push(e);});
  const yearKeys=Object.keys(years).sort().reverse();
  let gi=0;
  el.innerHTML=yearKeys.map((yr,yri)=>{
    const months=years[yr], mkeys=Object.keys(months).sort().reverse();
    const monthsHtml=mkeys.map((mk,mi)=>{
      const idx=gi++, isFirst=(yri===0&&mi===0);
      const entries=[...months[mk]].sort((a,b)=>b.date.localeCompare(a.date));
      const rows=entries.map(e=>{
        const h=Math.floor((e.duration_mins||0)/60), m=(e.duration_mins||0)%60;
        const rk=e.rating!=null?(e.rating>1?1:e.rating<-1?-1:e.rating):null;const r=rk!=null?SLEEP_RATINGS[rk]:null;
        return`<div class="data-entry-row" onclick='openSleepModal(${JSON.stringify(e)})'><div>
          <div class="data-entry-date">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short'})} ¬∑ ${e.sleep_from||'?'} ‚Äì ${e.sleep_to||'?'}</div>
          <div class="data-entry-vals"><span>üò¥ <b>${h}h ${m}min</b></span>${r?`<span style="color:${r.color};">${r.emoji} ${r.label}</span>`:''}</div>
        </div><span style="color:var(--muted)">‚úèÔ∏è</span></div>`;
      }).join('');
      return`<div class="data-group"><div class="data-group-header" onclick="toggleGroup('slg-${idx}')"><div><div class="data-group-title" style="color:#c847ff;">${monthLabel(mk)}</div><div class="data-group-meta">${entries.length} Eintr√§ge</div></div><div id="slg-arr-${idx}">${isFirst?'‚ñº':'‚ñ∂'}</div></div><div class="data-group-body${isFirst?' open':''}" id="slg-${idx}">${rows}</div></div>`;
    }).join('');
    const total=Object.values(months).flat().length, isCurrentYear=(yri===0);
    return`<div class="year-group" id="yg-sl-${yr}"><div class="year-header" onclick="toggleYearGroup('yg-sl-${yr}')"><div style="display:flex;align-items:center;gap:10px;"><span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;color:var(--accent);">${yr}</span><span style="font-size:12px;color:var(--muted);">${total} Eintr√§ge</span></div><span id="yarr-sl-${yr}" style="color:var(--muted);font-size:12px;">${isCurrentYear?'‚ñº':'‚ñ∂'}</span></div><div class="year-body${isCurrentYear?' open':''}" id="yb-sl-${yr}">${monthsHtml}</div></div>`;
  }).join('');
}

function exportWeightCSV(){
  if(!weightEntries.length){showToast('Keine Daten.',true);return;}
  const sorted=[...weightEntries].sort((a,b)=>a.date.localeCompare(b.date));
  let csv='datum,gewicht_kg,bauch_cm,huefte_cm,kalorien\n';
  sorted.forEach(e=>csv+=`${e.date},${e.weight||''},${e.bauch||''},${e.hueft||''},${e.kcal||''}
`);
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,Ôªø'+encodeURIComponent(csv);
  a.download='ironlog_gewicht.csv';a.click();
}

function exportBPCSV(){
  if(!bpEntries.length){showToast('Keine Daten.',true);return;}
  const sorted=[...bpEntries].sort((a,b)=>a.date===b.date?(a.time||'').localeCompare(b.time||''):a.date.localeCompare(b.date));
  let csv='datum,uhrzeit,systolisch,diastolisch,notiz\n';
  sorted.forEach(e=>csv+=`${e.date},${e.time||''},${e.sys},${e.dia},"${(e.note||'').replace(/"/g,'""')}"
`);
  const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,Ôªø'+encodeURIComponent(csv);
  a.download='ironlog_blutdruck.csv';a.click();
}

function exportSleepCSV(){
  if(!sleepEntries.length){showToast('Keine Daten.',true);return;}
  const sorted=[...sleepEntries].sort((a,b)=>a.date.localeCompare(b.date));
  let csv='datum,eingeschlafen,aufgewacht,dauer_minuten,dauer_stunden,bewertung,notiz\n';
  sorted.forEach(e=>{
    const r=e.rating!=null?(SLEEP_RATINGS[e.rating]?.label||''):'';
    csv+=`${e.date},${e.sleep_from||''},${e.sleep_to||''},${e.duration_mins||''},${e.duration_mins?+(e.duration_mins/60).toFixed(2):''},${r},"${(e.note||'').replace(/"/g,'""')}"\n`;
  });
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download='ironlog_schlaf.csv'; a.click();
}

function exportSleepPDF(){
  if(!sleepEntries.length){showToast('Keine Daten.',true);return;}
  openPDFSelect('SCHLAF PDF', mode => _doExportSleepPDF(mode));
}
function _doExportSleepPDF(mode){
  if(!sleepEntries.length)return;
  const sorted=[...sleepEntries].sort((a,b)=>b.date.localeCompare(a.date));
  const name=currentProfile?.name||'';
  const avgMins=Math.round(sorted.reduce((a,e)=>a+(e.duration_mins||0),0)/sorted.length);
  const avgH=Math.floor(avgMins/60), avgM=avgMins%60;
  const rows=sorted.map(e=>{const h=Math.floor((e.duration_mins||0)/60),m=(e.duration_mins||0)%60;const r=e.rating!=null?(SLEEP_RATINGS[e.rating]?.emoji+' '+(SLEEP_RATINGS[e.rating]?.label||'')):'‚Äî';return`<tr><td>${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</td><td>${e.sleep_from||'‚Äî'} ‚Äì ${e.sleep_to||'‚Äî'}</td><td style="font-weight:700;">${h}h ${m}m</td><td>${r}</td><td style="font-size:11px;color:#666;">${e.note||'‚Äî'}</td></tr>`;}).join('');
  const body=`<h1>IRONLOG <span style="color:#666;font-weight:300;">Schlaf</span></h1>
    <div class="sub">${name} ¬∑ ${sorted.length} Eintr√§ge ¬∑ √ò ${avgH}h ${avgM}min</div>
    <table><thead><tr><th>Datum</th><th>Zeit</th><th>Dauer</th><th>Bewertung</th><th>Notiz</th></tr></thead><tbody>${rows}</tbody></table>`;
  if(mode==='table'){
    openPDFWindow('IRONLOG Schlaf',body);
  } else if(mode==='chart'){
    const canvas=g('sleepChart');
    if(!canvas){showToast('Kein Diagramm verf√ºgbar.',true);return;}
    const img=canvas.toDataURL('image/png');
    openPDFWindow('IRONLOG Schlaf',`<h1>IRONLOG <span style="color:#666;font-weight:300;">Schlaf</span></h1><div class="sub">${name}</div><div class="section">Diagramm</div><img src="${img}" style="max-width:100%;"/>`);
  } else {
    const canvas=g('sleepChart');
    const chartHtml=canvas?`<div class="section">Diagramm</div><img src="${canvas.toDataURL('image/png')}" style="max-width:100%;margin-bottom:16px;"/>` :'';
    openPDFWindow('IRONLOG Schlaf',`<h1>IRONLOG <span style="color:#666;font-weight:300;">Schlaf</span></h1><div class="sub">${name} ¬∑ ${sorted.length} Eintr√§ge ¬∑ √ò ${avgH}h ${avgM}min</div>${chartHtml}<div class="section">Alle Eintr√§ge</div><table><thead><tr><th>Datum</th><th>Zeit</th><th>Dauer</th><th>Bewertung</th><th>Notiz</th></tr></thead><tbody>${rows}</tbody></table>`);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ MOOD ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let moodTimeFilter='all', moodRatingVal=null, editingMoodId=null, moodChartI=null;

const MOOD_RATINGS={
  2:{label:'Sehr gut',emoji:'üòÑ',color:'#47ffb8'},
  1:{label:'Gut',emoji:'üôÇ',color:'#a8ff47'},
  0:{label:'Neutral',emoji:'üòê',color:'#47c8ff'},
  '-1':{label:'Schlecht',emoji:'üòï',color:'#ffb347'},
  '-2':{label:'Sehr schlecht',emoji:'üòû',color:'#ff4757'}
};

function setMoodTimeFilter(f,btn){
  moodTimeFilter=f;
  document.querySelectorAll('.mdtf').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  renderMoodChart();
}

function openMoodModal(entry=null){
  editingMoodId=entry?entry.id:null;
  moodRatingVal=entry?entry.rating:null;
  g('mood-modal-ttl').textContent=entry?'STIMMUNG BEARBEITEN':'STIMMUNG ERFASSEN';
  g('mood-date').value=entry?entry.date:today();
  const nowTime=new Date().toTimeString().slice(0,5);
  g('mood-time').value=entry?(entry.time||''):nowTime;
  g('mood-note').value=entry?(entry.note||''):'';
  g('mood-del-btn').style.display=entry?'block':'none';
  document.querySelectorAll('#mood-rating-btns .rating-btn').forEach(b=>{
    b.classList.toggle('active', parseInt(b.dataset.val)===moodRatingVal);
  });
  g('modal-mood').classList.add('open');
}

function selectMoodRating(val,btn){
  moodRatingVal=val;
  document.querySelectorAll('#mood-rating-btns .rating-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

async function saveMoodEntry(){
  const date=g('mood-date').value;
  if(!date){alert('Datum ist Pflichtfeld.');return;}
  if(moodRatingVal===null){alert('Bitte Stimmung w√§hlen.');return;}
  const entry={user_id:currentUser.id,date,time:g('mood-time').value||null,rating:moodRatingVal,note:g('mood-note').value.trim()};
  setSyncState('syncing');
  let res;
  if(editingMoodId) res=await sb.from('mood_entries').update(entry).eq('id',editingMoodId).eq('user_id',currentUser.id);
  else res=await sb.from('mood_entries').insert(entry).select();
  if(res.error){showToast('Fehler: '+res.error.message,true);setSyncState('error');return;}
  await loadAllData(); closeModal('modal-mood'); renderMood(); showToast('Stimmung gespeichert!');
}

async function deleteMoodEntry(){
  if(!confirm('Eintrag l√∂schen?'))return;
  await sb.from('mood_entries').delete().eq('id',editingMoodId);
  await loadAllData(); closeModal('modal-mood'); renderMood(); showToast('Gel√∂scht.');
}

function renderMood(){renderMoodChart();renderMoodAverages();renderMoodGroups();}

function renderMoodChart(){
  if(moodChartI){try{moodChartI.destroy();}catch(e){}moodChartI=null;}
  const old=g('moodChart'); if(!old)return;
  const fresh=document.createElement('canvas'); fresh.id='moodChart'; fresh.height=200;
  old.parentNode.replaceChild(fresh,old);
  const filtered=filterByTime(moodEntries,moodTimeFilter);
  if(!filtered.length)return;
  const sorted=[...filtered].sort((a,b)=>a.date.localeCompare(b.date));
  const vals=sorted.map(e=>e.rating);
  const maVals=calcMA(vals,7);
  moodChartI=new Chart(fresh,{type:'line',data:{
    labels:sorted.map(e=>fmtShort(e.date)),
    datasets:[
      {label:'Stimmung',data:vals,borderColor:'#ff9f47',backgroundColor:'rgba(255,159,71,.07)',pointBackgroundColor:sorted.map(e=>(MOOD_RATINGS[e.rating]||MOOD_RATINGS[0]).color),pointRadius:sorted.length>60?2:5,tension:.3,fill:true,order:2},
      {label:'√ò 7 Tage',data:maVals,borderColor:'#e8ff47',borderWidth:2,pointRadius:0,tension:.4,fill:false,order:1,spanGaps:true}
    ]
  },options:{
    plugins:{legend:{display:true,labels:{color:'#6b6b80',font:{size:10},boxWidth:12,filter:item=>item.text&&item.text.includes('√ò')}}},
    scales:{x:{ticks:{color:'#6b6b80',font:{size:10},maxTicksLimit:10},grid:{color:'#2a2a38'}},
            y:{ticks:{color:'#6b6b80',callback:v=>{const r=MOOD_RATINGS[v];return r?r.emoji:'';},stepSize:1},grid:{color:'#2a2a38'},min:-2,max:2}}
  }});
}

function renderMoodAverages(){
  const el=g('mood-averages'); if(!el)return;
  if(!moodEntries.length){el.innerHTML='<div style="color:var(--muted);font-size:13px;">Keine Daten.</div>';return;}
  const moodDates=moodEntries.map(e=>e.date).sort();
  const oldestMood=moodDates[0];
  function avgFor(days){
    const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-days);
    const cutStr=cutoff.toISOString().split('T')[0];
    if(oldestMood>cutStr) return null;
    const entries=moodEntries.filter(e=>e.date>=cutStr);
    if(!entries.length) return null;
    const avg=+(entries.reduce((a,e)=>a+e.rating,0)/entries.length).toFixed(1);
    return{avg,n:entries.length};
  }
  const periods=[{label:'7 Tage',days:7},{label:'1 Monat',days:30},{label:'3 Monate',days:90},{label:'1 Jahr',days:365}];
  const rows=periods.map(p=>{
    const avg=avgFor(p.days);
    if(!avg) return null;
    const rIdx=Math.round(avg.avg), r=MOOD_RATINGS[rIdx]||MOOD_RATINGS[0];
    return`<tr><td style="font-weight:700;font-size:13px;">${p.label}</td>
      <td style="text-align:center;font-size:22px;">${r.emoji}</td>
      <td style="text-align:center;font-size:13px;color:${r.color};">${r.label}</td>
      <td style="text-align:center;font-size:12px;color:var(--muted);">${avg.avg > 0 ? '+' : ''}${avg.avg}</td></tr>`;
  }).filter(Boolean).join('');
  el.innerHTML=`<table class="bp-table"><thead><tr><th>Zeitraum</th><th style="text-align:center;">üòä</th><th style="text-align:center;">Stimmung</th><th style="text-align:center;">√ò Wert</th></tr></thead><tbody>${rows}</tbody></table>`;
}

function renderMoodGroups(){
  const el=g('mood-groups'); if(!el)return;
  if(!moodEntries.length){el.innerHTML='';return;}
  const years={};
  moodEntries.forEach(e=>{const yr=e.date.substring(0,4),mk=monthKey(e.date);if(!years[yr])years[yr]={};if(!years[yr][mk])years[yr][mk]=[];years[yr][mk].push(e);});
  const yearKeys=Object.keys(years).sort().reverse();
  let gi=0;
  el.innerHTML=yearKeys.map((yr,yri)=>{
    const months=years[yr], mkeys=Object.keys(months).sort().reverse();
    const monthsHtml=mkeys.map((mk,mi)=>{
      const idx=gi++, isFirst=(yri===0&&mi===0);
      const entries=[...months[mk]].sort((a,b)=>b.date===a.date?(b.time||'').localeCompare(a.time||''):b.date.localeCompare(a.date));
      const rows=entries.map(e=>{
        const r=MOOD_RATINGS[e.rating]||MOOD_RATINGS[0];
        return`<div class="data-entry-row" onclick='openMoodModal(${JSON.stringify(e)})'><div>
          <div class="data-entry-date">${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short'})}${e.time?' ¬∑ '+e.time:''}</div>
          <div class="data-entry-vals"><span style="color:${r.color};">${r.emoji} <b>${r.label}</b></span>${e.note?`<span style="font-size:11px;color:var(--muted);">${e.note}</span>`:''}</div>
        </div><span style="color:var(--muted)">‚úèÔ∏è</span></div>`;
      }).join('');
      return`<div class="data-group"><div class="data-group-header" onclick="toggleGroup('mdg-${idx}')"><div><div class="data-group-title" style="color:#ff9f47;">${monthLabel(mk)}</div><div class="data-group-meta">${entries.length} Eintr√§ge</div></div><div id="mdg-arr-${idx}">${isFirst?'‚ñº':'‚ñ∂'}</div></div><div class="data-group-body${isFirst?' open':''}" id="mdg-${idx}">${rows}</div></div>`;
    }).join('');
    const total=Object.values(months).flat().length, isCurrentYear=(yri===0);
    return`<div class="year-group" id="yg-md-${yr}"><div class="year-header" onclick="toggleYearGroup('yg-md-${yr}')"><div style="display:flex;align-items:center;gap:10px;"><span style="font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:3px;color:var(--accent);">${yr}</span><span style="font-size:12px;color:var(--muted);">${total} Eintr√§ge</span></div><span id="yarr-md-${yr}" style="color:var(--muted);font-size:12px;">${isCurrentYear?'‚ñº':'‚ñ∂'}</span></div><div class="year-body${isCurrentYear?' open':''}" id="yb-md-${yr}">${monthsHtml}</div></div>`;
  }).join('');
}

function exportMoodCSV(){
  if(!moodEntries.length){showToast('Keine Daten.',true);return;}
  const sorted=[...moodEntries].sort((a,b)=>a.date.localeCompare(b.date));
  let csv='datum,uhrzeit,stimmung_wert,stimmung,notiz\n';
  sorted.forEach(e=>{
    const r=MOOD_RATINGS[e.rating]?.label||'';
    csv+=`${e.date},${e.time||''},${e.rating},"${r}","${(e.note||'').replace(/"/g,'""')}"\n`;
  });
  const a=document.createElement('a'); a.href='data:text/csv;charset=utf-8,\uFEFF'+encodeURIComponent(csv);
  a.download='ironlog_stimmung.csv'; a.click();
}

function exportMoodPDF(){
  if(!moodEntries.length){showToast('Keine Daten.',true);return;}
  openPDFSelect('STIMMUNG PDF', mode => _doExportMoodPDF(mode));
}
function _doExportMoodPDF(mode){
  if(!moodEntries.length)return;
  const sorted=[...moodEntries].sort((a,b)=>b.date.localeCompare(a.date));
  const name=currentProfile?.name||'';
  const rows=sorted.map(e=>{const r=MOOD_RATINGS[e.rating]||MOOD_RATINGS[0];return`<tr><td>${fmtD(e.date,{weekday:'short',day:'2-digit',month:'short',year:'numeric'})}</td><td>${e.time||'‚Äî'}</td><td>${r.emoji} ${r.label}</td><td style="font-size:11px;color:#666;">${e.note||'‚Äî'}</td></tr>`;}).join('');
  const body=`<h1>IRONLOG <span style="color:#666;font-weight:300;">Stimmung</span></h1>
    <div class="sub">${name} ¬∑ ${sorted.length} Eintr√§ge</div>
    <table><thead><tr><th>Datum</th><th>Uhrzeit</th><th>Stimmung</th><th>Notiz</th></tr></thead><tbody>${rows}</tbody></table>`;
  if(mode==='table'){
    openPDFWindow('IRONLOG Stimmung',body);
  } else if(mode==='chart'){
    const canvas=g('moodChart');
    if(!canvas){showToast('Kein Diagramm verf√ºgbar.',true);return;}
    const img=canvas.toDataURL('image/png');
    openPDFWindow('IRONLOG Stimmung',`<h1>IRONLOG <span style="color:#666;font-weight:300;">Stimmung</span></h1><div class="sub">${name}</div><div class="section">Diagramm</div><img src="${img}" style="max-width:100%;"/>`);
  } else {
    const canvas=g('moodChart');
    const chartHtml=canvas?`<div class="section">Diagramm</div><img src="${canvas.toDataURL('image/png')}" style="max-width:100%;margin-bottom:16px;"/>` :'';
    openPDFWindow('IRONLOG Stimmung',`<h1>IRONLOG <span style="color:#666;font-weight:300;">Stimmung</span></h1><div class="sub">${name} ¬∑ ${sorted.length} Eintr√§ge</div>${chartHtml}<div class="section">Alle Eintr√§ge</div><table><thead><tr><th>Datum</th><th>Uhrzeit</th><th>Stimmung</th><th>Notiz</th></tr></thead><tbody>${rows}</tbody></table>`);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ FIXES: BP chart Y-axis auto-scale + Start Button ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê



// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ KALORIEN & MAKRO RECHNER ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _macroGender = 'm';
let _macroProtein = 'low';
let _macroVProtein = 'low';
let _macroFat = 'mid';

function setMacroGender(gender) {
  _macroGender = gender;
  g('mg-m').classList.toggle('active', gender === 'm');
  g('mg-f').classList.toggle('active', gender === 'f');
  calcMacros();
}

function setMacro3(type, val) {
  if (type === 'protein')  { _macroProtein  = val; ['low','mid','high'].forEach(v => g('mp-' +v).classList.toggle('active', v===val)); }
  if (type === 'vprotein') { _macroVProtein = val; ['low','mid','high'].forEach(v => g('mpp-'+v).classList.toggle('active', v===val)); }
  if (type === 'fat')      { _macroFat      = val; ['low','mid','high'].forEach(v => g('mf-' +v).classList.toggle('active', v===val)); }
  calcMacros();
}

function calcMacros() {
  const alter   = parseFloat(g('mc-alter')?.value);
  const groesse = parseFloat(g('mc-groesse')?.value);
  const gewicht = parseFloat(g('mc-gewicht')?.value);
  const wunsch  = parseFloat(g('mc-wunsch')?.value);
  const akt     = parseFloat(g('mc-aktivitaet')?.value) || 1.4;

  if (!alter || !groesse || !gewicht) return;

  // ‚îÄ‚îÄ 1. Grundbedarf (Harris-Benedict) ‚îÄ‚îÄ
  let bmr;
  if (_macroGender === 'm') {
    bmr = 88.362 + (13.397 * gewicht) + (4.799 * groesse) - (5.677 * alter);
  } else {
    bmr = 447.593 + (9.247 * gewicht) + (3.098 * groesse) - (4.330 * alter);
  }
  bmr = Math.round(bmr);

  // ‚îÄ‚îÄ 2. Kalorienbereich ‚îÄ‚îÄ
  const kritisch   = bmr + 200;
  const erhaltungT = Math.round(bmr * akt);
  const defizitLow = kritisch + 100;
  const defizitHigh = erhaltungT - 200;
  const erhaltungPLow  = Math.round(erhaltungT * 0.96);
  const erhaltungPHigh = Math.round(erhaltungT * 1.19);

  g('mr-grundbedarf').textContent  = bmr + ' kcal';
  g('mr-kritisch').textContent     = kritisch + ' kcal';
  g('mr-defizit').textContent      = defizitLow + ' ‚Äì ' + defizitHigh + ' kcal';
  g('mr-erhaltung-t').textContent  = erhaltungT + ' kcal';
  g('mr-erhaltung-p').textContent  = erhaltungPLow + ' ‚Äì ' + erhaltungPHigh + ' kcal';

  // ‚îÄ‚îÄ 3. Makros ‚îÄ‚îÄ
  // Protein g/kg K√∂rpergewicht
  const proteinFactors = {
    low:  [1.27, 1.70],
    mid:  [1.33, 1.76],
    high: [1.39, 1.81]
  };
  const vProteinBonus = { low: 0, mid: 0.15, high: 0.30 };

  let [pLow, pHigh] = proteinFactors[_macroProtein];
  pLow  += vProteinBonus[_macroVProtein];
  pHigh += vProteinBonus[_macroVProtein];

  const proteinLow  = Math.round(gewicht * pLow);
  const proteinHigh = Math.round(gewicht * pHigh);

  // Fett g/kg
  const fatFactors = {
    low:  [0.70, 0.90],
    mid:  [0.86, 1.21],
    high: [1.26, 1.54]
  };
  const [fLow, fHigh] = fatFactors[_macroFat];
  const fettLow  = Math.round(gewicht * fLow);
  const fettHigh = Math.round(gewicht * fHigh);

  // KH = Rest (basierend auf Erhaltungsbereich)
  const kcalBase = (erhaltungPLow + erhaltungPHigh) / 2;
  const kcalFromProteinMid = ((proteinLow + proteinHigh) / 2) * 4;
  const kcalFromFatMid     = ((fettLow + fettHigh) / 2) * 9;
  const kcalForKH = kcalBase - kcalFromProteinMid - kcalFromFatMid;

  // KH range ¬±7g around midpoint
  const khMid  = Math.round(kcalForKH / 4);
  const khLow  = Math.max(0, khMid - 7);
  const khHigh = khMid + 7;

  g('mr-protein').textContent = proteinLow + ' ‚Äì ' + proteinHigh + ' g';
  g('mr-fett').textContent    = fettLow    + ' ‚Äì ' + fettHigh    + ' g';
  g('mr-kh').textContent      = khLow      + ' ‚Äì ' + khHigh      + ' g';

  // Progress bars (relative to max reasonable)
  const maxP = gewicht * 2.5;
  const maxF = gewicht * 2.0;
  const maxK = 800;
  g('mr-protein-bar').style.width = Math.min(100, (proteinHigh / maxP) * 100) + '%';
  g('mr-fett-bar').style.width    = Math.min(100, (fettHigh    / maxF) * 100) + '%';
  g('mr-kh-bar').style.width      = Math.min(100, (khHigh      / maxK) * 100) + '%';

  // Macro kcal note
  const totalKcal = Math.round(proteinHigh*4 + fettHigh*9 + khHigh*4);
  g('mr-macro-note').textContent = `Entspricht ca. ${totalKcal} kcal bei Max-Werten`;

  // ‚îÄ‚îÄ 4. K√∂rperfettzunahme ‚îÄ‚îÄ
  g('mr-kf1').textContent = defizitLow + ' ‚Äì ' + defizitHigh + ' kcal';
  g('mr-kf2').textContent = erhaltungT + ' kcal';
  g('mr-kf3').textContent = Math.round(erhaltungT * 1.15) + ' kcal';
  g('mr-kf4').textContent = Math.round(erhaltungT * 1.25) + ' kcal';

  // Store for 2.2
  window._macroErhaltungT = erhaltungT;
  window._macroErhaltungPLow = erhaltungPLow;
  window._macroErhaltungPHigh = erhaltungPHigh;
  calcKfTage();
}

function calcKfTage() {
  const kcalInput = parseFloat(g('mc-kcal-input')?.value);
  const erhT  = window._macroErhaltungT;
  const erhPL = window._macroErhaltungPLow;
  const erhPH = window._macroErhaltungPHigh;

  if (!kcalInput || !erhT) {
    g('mr-tage').textContent = '‚Äî';
    g('mr-tage-note').textContent = '';
    return;
  }

  // Use practical maintenance range for calculation
  // 1kg Fett = 7700 kcal
  const ueberschussLow  = Math.max(0, kcalInput - erhPH);
  const ueberschussHigh = Math.max(0, kcalInput - erhPL);

  if (ueberschussLow <= 0 && ueberschussHigh <= 0) {
    g('mr-tage').textContent = '‚Äî';
    g('mr-tage-note').textContent = 'Kein Kalorien√ºberschuss ‚Äì Fettzunahme unwahrscheinlich.';
    return;
  }

  const tageLow  = ueberschussHigh > 0 ? Math.round(7700 / ueberschussHigh) : null;
  const tageHigh = ueberschussLow  > 0 ? Math.round(7700 / ueberschussLow)  : null;

  if (tageLow && tageHigh) {
    g('mr-tage').textContent = tageLow + ' ‚Äì ' + tageHigh + ' Tage';
  } else if (tageHigh) {
    g('mr-tage').textContent = tageHigh + ' Tage';
  } else {
    g('mr-tage').textContent = tageLow + ' Tage';
  }
  g('mr-tage-note').textContent = 'Tage bis ca. 1 kg K√∂rperfettzunahme bei dieser Kalorienmenge.';
}

// Pre-fill macros from current weight entry if available
function prefillMacrosFromData() {
  if (weightEntries.length) {
    const latest = [...weightEntries].sort((a,b) => b.date.localeCompare(a.date))[0];
    if (latest?.weight && !g('mc-gewicht')?.value) {
      const el = g('mc-gewicht');
      if (el) el.value = latest.weight;
    }
  }
}


// ‚îÄ‚îÄ HABITS ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let habitWeekOff = 0; // 0=current week, -1=last week etc.
let habitChartI = null;
let _editingHabitId = null;
let _selectedHabitColor = '#47c8ff';

// ‚îÄ‚îÄ Frequency helpers ‚îÄ‚îÄ
function freqLabel(freq) {
  const map = {
    '1_daily':'T√§glich','2_daily':'2√ó t√§glich','3_daily':'3√ó t√§glich',
    '1_weekly':'1√ó pro Woche','2_weekly':'2√ó pro Woche','3_weekly':'3√ó pro Woche',
    '4_weekly':'4√ó pro Woche','5_weekly':'5√ó pro Woche','6_weekly':'6√ó pro Woche',
    '1_monthly':'1√ó pro Monat'
  };
  if (map[freq]) return map[freq];
  if (freq && freq.startsWith('custom_')) return freq.replace('custom_','') + '√ó t√§glich';
  return freq || '‚Äî';
}

function freqTarget(freq) {
  // Returns {count, period}: how many times per how many days
  if (!freq) return {count:1, period:1};
  if (freq.startsWith('custom_')) return {count: parseInt(freq.split('_')[1])||1, period:1};
  const [n, p] = freq.split('_');
  const count = parseInt(n)||1;
  if (p==='daily')   return {count, period:1};
  if (p==='weekly')  return {count, period:7};
  if (p==='monthly') return {count, period:30};
  return {count:1, period:1};
}

// ‚îÄ‚îÄ Week utilities ‚îÄ‚îÄ
function getWeekDates(offset) {
  const today = new Date();
  const dow = today.getDay(); // 0=Sun
  const monday = new Date(today);
  monday.setDate(today.getDate() - dow + 1 + offset * 7); // Mon
  return Array.from({length:7}, (_,i) => {
    const d = new Date(monday);
    d.setDate(monday.getDate() + i);
    return d.toISOString().split('T')[0];
  });
}

function habitWeekOffset(delta) {
  habitWeekOff += delta;
  renderHabitWeekGrid();
}

// ‚îÄ‚îÄ Count logs for a habit on a specific date ‚îÄ‚îÄ
function habitLogCount(habitId, date) {
  return habitLogs.filter(l => l.habit_id === habitId && l.date === date).length;
}

// ‚îÄ‚îÄ Toggle log for a habit/date ‚îÄ‚îÄ
async function toggleHabitLog(habitId, date, currentCount, targetCount) {
  setSyncState('syncing');
  if (currentCount >= targetCount) {
    // Remove ALL logs for this date
    const toDelete = habitLogs.filter(l => l.habit_id === habitId && l.date === date);
    for (const l of toDelete) {
      await sb.from('habit_logs').delete().eq('id', l.id);
    }
  } else {
    // Add one log
    await sb.from('habit_logs').insert({user_id: currentUser.id, habit_id: habitId, date});
  }
  await loadAllData();
  renderHabits();
}

// ‚îÄ‚îÄ Render ‚îÄ‚îÄ
function renderHabits() {
  renderHabitWeekGrid();
  renderHabitChart();
}

function renderHabitWeekGrid() {
  const el = g('habit-week-grid');
  const labelEl = g('habit-week-label');
  if (!el) return;

  const dates = getWeekDates(habitWeekOff);
  const dayNames = ['Mo','Di','Mi','Do','Fr','Sa','So'];
  const todayStr = today();

  // Week label
  const from = fmtD(dates[0], {day:'2-digit',month:'short'});
  const to   = fmtD(dates[6], {day:'2-digit',month:'short'});
  if (labelEl) labelEl.textContent = from + ' ‚Äì ' + to;

  if (!habits.length) {
    el.innerHTML = `<div style="text-align:center;padding:24px 0;color:var(--muted);font-size:13px;">
      Noch keine Habits. Tippe auf <b>+</b> um ein Habit hinzuzuf√ºgen.
    </div>`;
    return;
  }

  el.innerHTML = habits.map(h => {
    const target = freqTarget(h.frequency);
    const color  = h.color || '#47c8ff';

    // Day buttons
    const dayBtns = dates.map((date, i) => {
      const count   = habitLogCount(h.id, date);
      const done    = count >= target.count;
      const partial = count > 0 && !done;
      const isFuture = date > todayStr;
      const dayNum  = date.split('-')[2];

      return `<button class="habit-day-btn"
        onclick="${isFuture ? '' : `toggleHabitLog('${h.id}','${date}',${count},${target.count})`}"
        style="${isFuture ? 'opacity:.3;cursor:default;' : ''}">
        <span style="font-size:9px;color:var(--muted);">${dayNames[i]}</span>
        <span class="habit-day-dot ${done?'done':partial?'partial':''}"
          style="${done ? 'background:'+color+';' : partial ? 'color:'+color+';border-color:'+color+';' : ''}">
          ${done ? '‚úì' : partial ? count : dayNum}
        </span>
      </button>`;
    }).join('');

    // Weekly completion rate
    const weekDone = dates.reduce((a, d) => a + (habitLogCount(h.id,d) >= target.count ? 1 : 0), 0);

    return `<div class="habit-row">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${color};flex-shrink:0;"></span>
          <span style="font-weight:700;font-size:14px;">${h.name}</span>
          <span style="font-size:11px;color:var(--muted);">${freqLabel(h.frequency)}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:11px;color:${color};font-weight:600;">${weekDone}/7</span>
          <button class="btn btn-ghost btn-xs" onclick="openHabitModal('${h.id}')">‚úèÔ∏è</button>
        </div>
      </div>
      <div style="display:flex;justify-content:space-between;">${dayBtns}</div>
    </div>`;
  }).join('');
}

function renderHabitChart() {
  if (habitChartI) { try{habitChartI.destroy();}catch(e){} habitChartI=null; }
  const old = g('habitChart'); if (!old) return;
  const fresh = document.createElement('canvas'); fresh.id='habitChart'; fresh.height=200;
  old.parentNode.replaceChild(fresh, old);
  if (!habits.length) return;

  // Build last 30 days
  const days = [];
  for (let i = 29; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    days.push(d.toISOString().split('T')[0]);
  }

  const datasets = habits.map(h => {
    const target = freqTarget(h.frequency);
    const data = days.map(date => {
      const count = habitLogCount(h.id, date);
      return count >= target.count ? 1 : 0;
    });
    // Calculate 7-day rolling completion %
    const rolling = data.map((_, i) => {
      const slice = data.slice(Math.max(0, i-6), i+1);
      return Math.round((slice.reduce((a,b)=>a+b,0) / slice.length) * 100);
    });
    return {
      label: h.name,
      data: rolling,
      borderColor: h.color || '#47c8ff',
      backgroundColor: (h.color || '#47c8ff') + '22',
      borderWidth: 2,
      pointRadius: 0,
      tension: 0.4,
      fill: false
    };
  });

  habitChartI = new Chart(fresh, {
    type: 'line',
    data: { labels: days.map(d => fmtShort(d)), datasets },
    options: {
      plugins: { legend: { display: true, labels: { color:'#6b6b80', font:{size:10}, boxWidth:10 } } },
      scales: {
        x: { ticks:{color:'#6b6b80',font:{size:9},maxTicksLimit:10}, grid:{color:'#2a2a38'} },
        y: { ticks:{color:'#6b6b80',callback:v=>v+'%'}, grid:{color:'#2a2a38'}, min:0, max:100 }
      }
    }
  });
}

// ‚îÄ‚îÄ Modal ‚îÄ‚îÄ
function openHabitModal(habitId) {
  const h = habitId ? habits.find(x => x.id === habitId) : null;
  _editingHabitId = h ? h.id : null;
  _selectedHabitColor = h?.color || '#47c8ff';

  g('habit-modal-title').textContent = h ? 'HABIT BEARBEITEN' : 'HABIT ERSTELLEN';
  g('habit-name').value = h?.name || '';
  g('habit-del-btn').style.display = h ? 'block' : 'none';

  // Frequency
  const freq = h?.frequency || '1_daily';
  const sel = g('habit-freq');
  const isCustom = freq.startsWith('custom_');
  sel.value = isCustom ? 'custom' : freq;
  g('habit-custom-field').style.display = isCustom ? '' : 'none';
  if (isCustom) g('habit-custom-count').value = freq.split('_')[1] || 1;

  // Color
  document.querySelectorAll('.habit-color-btn').forEach(btn => {
    btn.style.border = btn.dataset.color === _selectedHabitColor ? '3px solid #fff' : '3px solid transparent';
    btn.classList.toggle('active', btn.dataset.color === _selectedHabitColor);
  });

  g('modal-habit').classList.add('open');
}

function selectHabitColor(color, btn) {
  _selectedHabitColor = color;
  document.querySelectorAll('.habit-color-btn').forEach(b => {
    b.style.border = b.dataset.color === color ? '3px solid #fff' : '3px solid transparent';
  });
}

async function saveHabit() {
  const name = g('habit-name').value.trim();
  if (!name) { showToast('Bitte einen Namen eingeben.', true); return; }

  let freq = g('habit-freq').value;
  if (freq === 'custom') {
    const n = parseInt(g('habit-custom-count').value) || 1;
    freq = 'custom_' + n;
  }

  const entry = { user_id: currentUser.id, name, frequency: freq, color: _selectedHabitColor };
  setSyncState('syncing');
  let res;
  if (_editingHabitId) res = await sb.from('habits').update(entry).eq('id', _editingHabitId).eq('user_id', currentUser.id);
  else res = await sb.from('habits').insert(entry).select();

  if (res.error) { showToast('Fehler: '+res.error.message, true); setSyncState('error'); return; }
  await loadAllData();
  closeModal('modal-habit');
  renderHabits();
  showToast((_editingHabitId ? 'Habit aktualisiert' : 'Habit erstellt') + '!');
}

async function deleteHabit() {
  if (!_editingHabitId || !confirm('Habit und alle Eintr√§ge l√∂schen?')) return;
  await sb.from('habit_logs').delete().eq('habit_id', _editingHabitId);
  await sb.from('habits').delete().eq('id', _editingHabitId);
  await loadAllData();
  closeModal('modal-habit');
  renderHabits();
  showToast('Habit gel√∂scht.');
}

// Habit-custom freq select toggle
setTimeout(() => {
  const sel = g('habit-freq');
  if (sel) sel.addEventListener('change', () => {
    g('habit-custom-field').style.display = sel.value === 'custom' ? '' : 'none';
  });
}, 800);


// ‚îÄ‚îÄ DEBUG (remove later) ‚îÄ‚îÄ
async function debugSave(){
  if(!currentUser){console.log('Not logged in');return;}
  console.log('User ID:', currentUser.id);
  const t1=await sb.from('weight_entries').insert({user_id:currentUser.id,date:'2025-01-01',weight:80}).select();
  console.log('Weight test:', t1.data, t1.error);
  if(t1.data?.[0]) await sb.from('weight_entries').delete().eq('id',t1.data[0].id);
}
// Run debug on next load: type debugSave() in browser console
</script>
</body>
</html>
<!-- SLEEP + MOOD JS injected below -->
